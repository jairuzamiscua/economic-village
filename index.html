<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EconoVille — Phase 1 (Agrarian Development)</title>
<style>
:root{--bg:#0f172a;--panel:#111827ee;--panel2:#0b1224cc;--text:#e5e7eb;--muted:#9ca3af;--accent:#22d3ee;--accent2:#a78bfa;--good:#22c55e;--warn:#f59e0b;--bad:#ef4444;--border:#1f2937}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:radial-gradient(1400px 900px at 70% -10%,#1e293b 0%,#0b1224 40%,#050816 100%);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
.shell{display:grid;grid-template-rows:auto 1fr;min-height:100%}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border)}
header h1{font-size:18px;margin:0;font-weight:800}
header .tag{font-size:12px;color:var(--muted)}
.main{display:grid;grid-template-columns:340px 1fr 360px;gap:14px;padding:14px}
.panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.panel h2{font-size:12px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);margin:0 0 10px}
.left,.right{padding:14px;overflow:auto;max-height:calc(100vh - 100px)}
.center{position:relative;padding:12px}

.view{height:100%;min-height:600px;border-radius:14px;border:1px solid var(--border);
background:radial-gradient(1200px 800px at 30% -20%, rgba(34,211,238,.07), transparent 50%),
linear-gradient(180deg, rgba(2,6,23,.25), rgba(2,6,23,.65)),
url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="920" height="620"><defs><linearGradient id="sky" x1="0" x2="0" y1="0" y2="1"><stop offset="0" stop-color="%231a2b57"/><stop offset="1" stop-color="%23091121"/></linearGradient><linearGradient id="ground" x1="0" x2="0" y1="0" y2="1"><stop offset="0" stop-color="%230b3a1e"/><stop offset="1" stop-color="%23061812"/></linearGradient></defs><rect width="100%" height="45%" fill="url(%23sky)"/><rect y="45%" width="100%" height="55%" fill="url(%23ground)"/></svg>');
background-size:cover;position:relative;overflow:hidden}
.hud{position:absolute;top:10px;left:10px;display:flex;gap:8px;flex-wrap:wrap;z-index:10}
.badge{background:#0b1224cc;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px}
.grid{position:absolute;left:20px;right:20px;bottom:20px;top:100px;border:1px dashed #33415555;border-radius:10px}
.icon{position:absolute;width:82px;height:72px;border-radius:8px;border:1px solid rgba(0,0,0,.35);box-shadow:0 10px 22px rgba(0,0,0,.35);background-size:cover;cursor:pointer}
.icon.farm{background:repeating-linear-gradient(45deg,#166534 0 7px,#0e9f6e 7px 14px)}
.icon.house{background:linear-gradient(#d1d5db,#6b7280)}
.icon.well{background:radial-gradient(circle,#93c5fd,#1d4ed8)}
.icon.granary{background:linear-gradient(#9ca3af,#6b7280)}
.icon.livestock{background:linear-gradient(135deg,#a16207,#854d0e)}
.icon.market{background:linear-gradient(90deg,#ef4444,#f59e0b,#facc15)}
.site{filter:grayscale(.8) brightness(.7)}
.ring{position:absolute;width:44px;height:44px;border-radius:50%;
background:radial-gradient(circle at 50% 50%, rgba(0,0,0,.6) 30%, transparent 31%), conic-gradient(var(--accent) calc(var(--pct,0)*1%), rgba(255,255,255,.12) 0);
border:1px solid rgba(255,255,255,.1);left:18px;top:12px}

.node{position:absolute;width:52px;height:52px;border-radius:10px;border:1px solid #0004;box-shadow:0 6px 16px rgba(0,0,0,.35);cursor:pointer;transition:transform .2s}
.node:hover{transform:scale(1.05)}
.node.tree{background:radial-gradient(circle,#14532d,#052e16)}
.node.rock{background:radial-gradient(circle,#6b7280,#111827)}

.labor{margin-bottom:14px;background:#0b1224aa;border:1px solid var(--border);border-radius:10px;padding:10px}
.labor h4{margin:0 0 8px;font-size:13px}
.slider-row{margin:8px 0}
.slider-label{display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px}
input[type="range"]{width:100%;accent-color:var(--accent)}

.tech-tree{margin-bottom:14px}
.tech-node{background:#0b1224aa;border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:8px;position:relative}
.tech-node.locked{opacity:.6}
.tech-node.complete{border-color:var(--good);background:#0b1224dd}
.tech-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.tech-name{font-size:13px;font-weight:600}
.tech-cost{font-size:11px;color:var(--muted)}
.tech-desc{font-size:11px;color:var(--muted);margin-bottom:6px}
.tech-req{font-size:10px;color:var(--warn);margin-bottom:6px}
.btn{border:1px solid var(--border);background:transparent;color:var(--text);border-radius:8px;padding:5px 10px;cursor:pointer;font-size:11px}
.btn:hover:not(:disabled){background:#1f2937}
.btn:disabled{opacity:.4;cursor:not-allowed}
.btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#041018;border:none}

.builds-list{margin-bottom:14px}
.build-card{background:#0b1224aa;border:1px solid var(--border);border-radius:10px;padding:8px;margin-bottom:6px;display:flex;gap:8px;align-items:center;cursor:pointer;transition:all .2s}
.build-card:hover{background:#1f2937aa;border-color:var(--accent)}
.build-icon{width:32px;height:32px;border-radius:6px;background-size:cover;flex-shrink:0}
.build-info{flex:1}
.build-name{font-size:12px;font-weight:600}
.build-stats{font-size:10px;color:var(--muted)}

.meter{background:#0b1224aa;border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:12px}
.meter header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.meter h4{margin:0;font-size:13px}
.bar{height:10px;background:#0b1224;border:1px solid var(--border);border-radius:999px;overflow:hidden}
.fill{height:100%;width:0%;background:linear-gradient(90deg,var(--good),var(--accent));transition:width .4s ease}
.stat{font-size:11px;color:var(--muted);margin-top:4px}

.weather{border-top:1px dashed var(--border);padding-top:10px;margin-top:10px}
.wbox{display:flex;gap:8px;align-items:center;border:1px solid var(--border);border-radius:10px;background:#0b1224aa;padding:8px;margin-bottom:8px}
.wsym{width:28px;height:28px;border-radius:8px}
.wsym.sunny{background:radial-gradient(circle,#fde68a,#f59e0b)}
.wsym.rain{background:radial-gradient(circle,#60a5fa,#2563eb)}
.wsym.storm{background:conic-gradient(#60a5fa, #1e40af, #111827)}
.wsym.drought{background:repeating-linear-gradient(45deg,#b45309 0 6px,#78350f 6px 12px)}

.toast{position:fixed;bottom:18px;right:18px;background:#0b1224ee;border:1px solid var(--border);padding:10px 12px;border-radius:10px;font-size:13px;display:none;z-index:1001}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:2000}
.modal.show{display:flex}
.modal-content{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:20px;max-width:500px;max-height:80vh;overflow:auto}
.modal h3{margin:0 0 12px;font-size:16px}
.modal-close{float:right;background:none;border:none;color:var(--text);cursor:pointer;font-size:20px;line-height:1}
</style>
</head>
<body>
<div class="shell">
<header>
  <div>
    <h1>EconoVille — Phase 1 (Agrarian Economy)</h1>
    <div class="tag">Day <span id="day">1</span> • Year <span id="year">1</span> • Season: <span id="season">Spring</span></div>
  </div>
  <div class="tag">
    <button class="btn" id="btnSave">Save</button>
    <button class="btn" id="btnLoad">Load</button>
    <button class="btn" id="btnReset">Reset</button>
  </div>
</header>

<div class="main">
  <aside class="panel left">
    <h2>Labor Allocation</h2>
    <div class="labor">
      <div class="slider-row">
        <div class="slider-label"><span>Farmers</span><span id="farmerPct">50%</span></div>
        <input type="range" min="0" max="100" value="50" id="farmerSlider"/>
      </div>
      <div class="slider-row">
        <div class="slider-label"><span>Builders</span><span id="builderPct">30%</span></div>
        <input type="range" min="0" max="100" value="30" id="builderSlider"/>
      </div>
      <div class="slider-row">
        <div class="slider-label"><span>Herders</span><span id="herderPct">10%</span></div>
        <input type="range" min="0" max="100" value="10" id="herderSlider"/>
      </div>
      <div class="slider-row">
        <div class="slider-label"><span>Idle</span><span id="idlePct">10%</span></div>
      </div>
      <div class="stat">Total Pop: <b id="popTotal">80</b></div>
    </div>

    <h2>Technology Tree</h2>
    <div class="tech-tree" id="techTree"></div>

    <h2>Buildings</h2>
    <div class="builds-list" id="buildsList"></div>
  </aside>

  <section class="panel center">
    <div class="view" id="view">
      <div class="hud">
        <div class="badge">Pop: <span id="pop">80</span>/<span id="cap">100</span></div>
        <div class="badge">Materials: <span id="mat">30</span></div>
        <div class="badge">Food: <span id="foodStock">20</span></div>
        <div class="badge">Livestock: <span id="livestock">0</span></div>
      </div>
      <div class="grid" id="grid"></div>
    </div>
  </section>

  <aside class="panel right">
    <h2>Village Status</h2>
    <div class="meter">
      <header><h4>Food Security</h4><span id="foodLbl">0%</span></header>
      <div class="bar"><div class="fill" id="fillFood"></div></div>
      <div class="stat">Daily: +<span id="foodDaily">0</span> • Need: <span id="foodNeed">16</span> • Stock: <span id="foodStockVal">20</span></div>
    </div>
    <div class="meter">
      <header><h4>Health</h4><span id="healthLbl">60%</span></header>
      <div class="bar"><div class="fill" id="fillHealth"></div></div>
      <div class="stat">Wells, sanitation reduce disease</div>
    </div>
    <div class="meter">
      <header><h4>Morale</h4><span id="moraleLbl">60%</span></header>
      <div class="bar"><div class="fill" id="fillMorale"></div></div>
      <div class="stat">Affects productivity (+/-10%)</div>
    </div>

    <div class="weather">
      <h2>Weather</h2>
      <div class="wbox"><div class="wsym" id="wNow"></div><div>Today: <span id="wNowTxt">Sunny</span></div></div>
      <div class="wbox"><div class="wsym" id="wNext"></div><div>Tomorrow: <span id="wNextTxt">Rain</span></div></div>
      <div class="stat">Rain +20%, Storm +30%, Drought -30%</div>
    </div>

    <div style="margin-top:14px;padding:10px;background:#0b1224aa;border:1px solid var(--border);border-radius:10px">
      <h2 style="margin:0 0 8px">Info</h2>
      <div class="stat" id="gameLog">Welcome, Chief! Allocate labor and build farms to start.</div>
    </div>
  </aside>
</div>
</div>

<div class="modal" id="buildModal">
  <div class="modal-content">
    <button class="modal-close" id="modalClose">×</button>
    <h3 id="modalTitle">Farm</h3>
    <div id="modalContent"></div>
    <button class="btn primary" id="modalAction" style="margin-top:12px">Place Building</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const el=id=>document.getElementById(id);
const toast=msg=>{const t=el('toast');t.innerHTML=msg;t.style.display='block';setTimeout(()=>t.style.display='none',2500)};

let autoStarted = false;
let tickInterval = null;

const S = {
  day:1, year:1, season:0, seasons:["Spring","Summer","Autumn","Winter"],
  pop:80, cap:100,
  farmers:0.5, builders:0.3, herders:0.1,
  materials:30, foodStock:20, livestock:0,
  health:0.6, morale:0.6,
  tfp:1.0, landQuality:1.0,
  weatherNow:null, weatherNext:null,
  tech:{}, 
  builds:[],
  nodes:[],
  lastUpdate:Date.now()
};

const TECH_TREE = {
  basicFarming: {name:"Basic Farming", cost:0, req:[], effect:"Can build farms", desc:"Learn to cultivate crops"},
  livestock: {name:"Livestock", cost:15, req:["basicFarming"], effect:"Herders produce food & manure", desc:"Domesticate animals for food security"},
  threeField: {name:"Three-Field Rotation", cost:20, req:["basicFarming"], effect:"+15% crop yields", desc:"Rotate crops to maintain soil"},
  heavyPlough: {name:"Heavy Plough", cost:25, req:["livestock"], effect:"+20% farm productivity", desc:"Use animal power to till deep"},
  manure: {name:"Manure Fertilization", cost:15, req:["livestock"], effect:"+10% yields per livestock", desc:"Use animal waste to enrich soil"},
  irrigation: {name:"Irrigation", cost:30, req:["basicFarming"], effect:"Drought -30% → -10%", desc:"Water management systems"},
  granary: {name:"Granary", cost:25, req:["basicFarming"], effect:"Reduce spoilage 25% → 10%", desc:"Store surplus food safely"},
  well: {name:"Well", cost:20, req:[], effect:"+20% health, less disease", desc:"Clean water access"},
  marketAccess: {name:"Path to Market", cost:20, req:["basicFarming"], effect:"Can sell surplus +20%", desc:"Roads enable trade"},
  horsePower: {name:"Horse & Cart", cost:40, req:["heavyPlough"], effect:"+30% transport, unlock Phase 2", desc:"Powerful draft animals"},
};

const BUILDS = {
  farm: {name:"Farm", mat:8, dur:5, tip:"Produces food daily", icon:"farm"},
  house: {name:"House", mat:12, dur:4, tip:"+5 population cap", icon:"house"},
  well: {name:"Well", mat:15, dur:6, tip:"Improves health", icon:"well", reqTech:"well"},
  granary: {name:"Granary", mat:20, dur:7, tip:"Reduces spoilage", icon:"granary", reqTech:"granary"},
  livestock: {name:"Livestock Pen", mat:12, dur:5, tip:"Herders tend animals", icon:"livestock", reqTech:"livestock"},
  market: {name:"Market", mat:25, dur:6, tip:"Trade surplus", icon:"market", reqTech:"marketAccess"},
};

function autoStart(){
  if(!autoStarted){
    autoStarted = true;
    tickInterval = setInterval(tick, 2000);
    toast("Time started! Days pass automatically.");
  }
}

document.addEventListener('click', autoStart, {once:true});
document.addEventListener('input', autoStart, {once:true});

function seasonWeighted(s){
  const r=Math.random();
  if(s===0){ if(r<0.50)return"rain"; if(r<0.85)return"sunny"; return"storm";}
  if(s===1){ if(r<0.15)return"rain"; if(r<0.70)return"sunny"; return"drought";}
  if(s===2){ if(r<0.35)return"rain"; if(r<0.85)return"sunny"; return"storm";}
  if(s===3){ if(r<0.20)return"rain"; if(r<0.65)return"sunny"; return"drought";}
  return "sunny";
}

function weatherEffect(w){
  let mult=1, spoil=0.25, disease=0.01;
  if(w==="rain") mult=1.2;
  if(w==="storm"){ mult=1.3; spoil+=0.05; }
  if(w==="drought"){ mult = S.tech.irrigation?0.90:0.70; }
  if(S.tech.well) disease=0.005;
  if(S.tech.granary) spoil=0.10;
  return {mult,spoil,disease};
}

function tick(){
  const builderPop = Math.floor(S.pop * S.builders);
  S.builds.forEach(b=>{
    if(!b.done){
      b.progress += builderPop * 0.02;
      if(b.progress >= b.dur){ b.done=true; onBuildComplete(b); }
    }
  });

  const farms = S.builds.filter(b=>b.type==='farm'&&b.done).length;
  const farmerPop = Math.floor(S.pop * S.farmers);
  const herderPop = Math.floor(S.pop * S.herders);
  
  let farmFood = farms * 2 * S.tfp * (farmerPop / Math.max(1,S.pop));
  const w = weatherEffect(S.weatherNow);
  farmFood *= w.mult;
  
  const moraleBonus = 1 + (S.morale - 0.5) * 0.2;
  farmFood *= moraleBonus;
  
  let livestockFood = S.livestock * 0.5 * (herderPop / Math.max(1,S.pop));
  
  if(S.tech.manure){
    farmFood *= (1 + S.livestock * 0.1);
  }
  
  const totalFood = farmFood + livestockFood;
  const spoilage = totalFood * w.spoil;
  const netFood = totalFood - spoilage;
  
  S.foodStock += netFood;
  
  const needPerDay = S.pop * 0.2;
  S.foodStock -= needPerDay;
  
  if(S.foodStock > needPerDay * 7) S.morale = Math.min(1, S.morale + 0.01);
  else if(S.foodStock < needPerDay * 3) S.morale = Math.max(0, S.morale - 0.02);
  
  if(Math.random() < w.disease && S.foodStock < 0){
    const deaths = Math.max(1, Math.floor(S.pop * 0.01));
    S.pop = Math.max(10, S.pop - deaths);
    toast(`Disease! Lost ${deaths} villagers.`);
  }
  
  const houses = S.builds.filter(b=>b.type==='house'&&b.done).length;
  S.cap = 100 + houses * 5;
  if(S.foodStock > needPerDay * 10 && S.pop < S.cap && Math.random() < 0.1){
    S.pop++;
  }
  
  if(herderPop > 0 && S.livestock < herderPop * 3 && Math.random() < 0.05){
    S.livestock++;
  }
  
  S.day++;
  if(S.day > 90){ S.day=1; S.year++; S.season=(S.season+1)%4; }
  if(S.day % 7 === 0){
    S.weatherNow = S.weatherNext;
    S.weatherNext = seasonWeighted(S.season);
  }
  
  updateUI();
}

function onBuildComplete(b){
  if(b.type==='well') S.health=Math.min(1,S.health+0.2);
  if(b.type==='livestock') S.livestock+=2;
  toast(`${BUILDS[b.type].name} complete!`);
}

function updateUI(){
  el('day').textContent=S.day;
  el('year').textContent=S.year;
  el('season').textContent=S.seasons[S.season];
  el('pop').textContent=S.pop;
  el('cap').textContent=S.cap;
  el('mat').textContent=Math.floor(S.materials);
  el('foodStock').textContent=Math.floor(S.foodStock);
  el('livestock').textContent=S.livestock;
  el('popTotal').textContent=S.pop;
  
  const foodPct = Math.max(0,Math.min(1,S.foodStock/(S.pop*0.2*14)));
  el('fillFood').style.width=(foodPct*100)+'%';
  el('foodLbl').textContent=Math.round(foodPct*100)+'%';
  el('foodStockVal').textContent=Math.floor(S.foodStock);
  el('foodNeed').textContent=Math.floor(S.pop*0.2);
  
  el('fillHealth').style.width=(S.health*100)+'%';
  el('healthLbl').textContent=Math.round(S.health*100)+'%';
  el('fillMorale').style.width=(S.morale*100)+'%';
  el('moraleLbl').textContent=Math.round(S.morale*100)+'%';
  
  paintWeather('wNow',S.weatherNow,'wNowTxt');
  paintWeather('wNext',S.weatherNext,'wNextTxt');
  
  updateSliders();
  renderTechTree();
  renderBuilds();
  renderGrid();
}

function paintWeather(id,w,txtId){
  const sym=el(id);
  sym.className='wsym '+(w||'sunny');
  el(txtId).textContent=w||'Sunny';
}

function updateSliders(){
  const f=S.farmers, b=S.builders, h=S.herders;
  const idle = 1-f-b-h;
  el('farmerPct').textContent=Math.round(f*100)+'%';
  el('builderPct').textContent=Math.round(b*100)+'%';
  el('herderPct').textContent=Math.round(h*100)+'%';
  el('idlePct').textContent=Math.round(idle*100)+'%';
}

el('farmerSlider').addEventListener('input',e=>{
  S.farmers = e.target.value/100;
  normalizeLabor();
  updateUI();
});
el('builderSlider').addEventListener('input',e=>{
  S.builders = e.target.value/100;
  normalizeLabor();
  updateUI();
});
el('herderSlider').addEventListener('input',e=>{
  S.herders = e.target.value/100;
  normalizeLabor();
  updateUI();
});

function normalizeLabor(){
  const total = S.farmers + S.builders + S.herders;
  if(total > 1){
    const scale = 1/total;
    S.farmers *= scale;
    S.builders *= scale;
    S.herders *= scale;
  }
  el('farmerSlider').value = S.farmers*100;
  el('builderSlider').value = S.builders*100;
  el('herderSlider').value = S.herders*100;
}

function renderTechTree(){
  const tree = el('techTree');
  tree.innerHTML='';
  Object.keys(TECH_TREE).forEach(key=>{
    const t = TECH_TREE[key];
    const unlocked = S.tech[key];
    const canUnlock = !unlocked && t.req.every(r=>S.tech[r]) && S.materials >= t.cost;
    
    const node = document.createElement('div');
    node.className = 'tech-node' + (unlocked?' complete':'') + (!canUnlock&&!unlocked?' locked':'');
    
    let reqText = '';
    if(t.req.length && !unlocked){
      const missing = t.req.filter(r=>!S.tech[r]);
      if(missing.length) reqText = `<div class="tech-req">Requires: ${missing.map(m=>TECH_TREE[m].name).join(', ')}</div>`;
    }
    
    node.innerHTML = `
      <div class="tech-header">
        <div class="tech-name">${t.name}</div>
        <div class="tech-cost">${unlocked?'✓':t.cost+' mat'}</div>
      </div>
      <div class="tech-desc">${t.desc}</div>
      ${reqText}
      <div class="tech-desc"><i>${t.effect}</i></div>
    `;
    
    if(canUnlock){
      const btn = document.createElement('button');
      btn.className='btn primary';
      btn.textContent='Unlock';
      btn.onclick=()=>unlockTech(key);
      node.appendChild(btn);
    }
    
    tree.appendChild(node);
  });
}

function unlockTech(key){
  const t = TECH_TREE[key];
  if(S.materials < t.cost) return toast('Not enough materials');
  S.materials -= t.cost;
  S.tech[key] = true;
  
  if(key==='threeField') S.tfp *= 1.15;
  if(key==='heavyPlough') S.tfp *= 1.20;
  if(key==='well') S.health = Math.min(1, S.health + 0.20);
  
  toast(`Unlocked: ${t.name}!`);
  updateUI();
}

function renderBuilds(){
  const list = el('buildsList');
  list.innerHTML = '';
  
  Object.keys(BUILDS).forEach(key=>{
    const b = BUILDS[key];
    if(b.reqTech && !S.tech[b.reqTech]) return;
    
    const card = document.createElement('div');
    card.className = 'build-card';
    const iconClass = b.icon;
    
    const count = S.builds.filter(x=>x.type===key&&x.done).length;
    const building = S.builds.filter(x=>x.type===key&&!x.done).length;
    
    card.innerHTML = `
      <div class="build-icon icon ${iconClass}"></div>
      <div class="build-info">
        <div class="build-name">${b.name} (${count}${building?'+'+building:''})</div>
        <div class="build-stats">${b.mat} mat • ${b.dur} days • ${b.tip}</div>
      </div>
    `;
    
    card.onclick = ()=> openBuildModal(key);
    list.appendChild(card);
  });
}

function openBuildModal(type){
  const b = BUILDS[type];
  el('modalTitle').textContent = b.name;
  el('modalContent').innerHTML = `
    <p>${b.tip}</p>
    <p><strong>Cost:</strong> ${b.mat} materials</p>
    <p><strong>Build Time:</strong> ${b.dur} days</p>
    <p><strong>Current:</strong> ${S.builds.filter(x=>x.type===type&&x.done).length} built</p>
  `;
  
  const btn = el('modalAction');
  btn.onclick = ()=> {
    if(S.materials < b.mat) return toast('Not enough materials!');
    S.materials -= b.mat;
    S.builds.push({
      id:Date.now()+Math.random(),
      type,
      x:100+Math.random()*400,
      y:100+Math.random()*300,
      done:false,
      progress:0,
      dur:b.dur
    });
    toast(`Started building ${b.name}`);
    el('buildModal').classList.remove('show');
    updateUI();
  };
  
  el('buildModal').classList.add('show');
}

el('modalClose').addEventListener('click', ()=> el('buildModal').classList.remove('show'));
el('buildModal').addEventListener('click', e=>{
  if(e.target === el('buildModal')) el('buildModal').classList.remove('show');
});

function renderGrid(){
  const grid = el('grid');
  const existing = [...grid.querySelectorAll('.icon')];
  
  S.builds.forEach((b,idx)=>{
    let icon = existing.find(e=>e.dataset.id===b.id);
    if(!icon){
      icon = document.createElement('div');
      icon.className = 'icon ' + BUILDS[b.type].icon + (b.done?'':' site');
      icon.dataset.id = b.id;
      icon.style.left = b.x + 'px';
      icon.style.top = b.y + 'px';
      grid.appendChild(icon);
    }
    
    if(!b.done){
      icon.className = 'icon ' + BUILDS[b.type].icon + ' site';
      let ring = icon.querySelector('.ring');
      if(!ring){
        ring = document.createElement('div');
        ring.className = 'ring';
        icon.appendChild(ring);
      }
      const pct = Math.min(100, (b.progress/b.dur)*100);
      ring.style.setProperty('--pct', pct);
    } else {
      icon.className = 'icon ' + BUILDS[b.type].icon;
      const ring = icon.querySelector('.ring');
      if(ring) ring.remove();
    }
  });
  
  existing.forEach(e=>{
    if(!S.builds.find(b=>b.id===e.dataset.id)){
      e.remove();
    }
  });
  
  drawNodes();
}

function spawnNodes(){
  for(let i=0;i<4;i++) S.nodes.push({id:'tree'+i, type:'tree', x:50+Math.random()*300, y:50+Math.random()*300, hp:3});
  for(let i=0;i<3;i++) S.nodes.push({id:'rock'+i, type:'rock', x:400+Math.random()*200, y:50+Math.random()*300, hp:2});
}

function drawNodes(){
  const grid = el('grid');
  S.nodes.forEach(n=>{
    let node = grid.querySelector(`[data-nodeid="${n.id}"]`);
    if(!node){
      node = document.createElement('div');
      node.className = 'node ' + n.type;
      node.dataset.nodeid = n.id;
      node.style.left = n.x + 'px';
      node.style.top = n.y + 'px';
      node.onclick = ()=> harvestNode(n);
      grid.appendChild(node);
    }
  });
  
  [...grid.querySelectorAll('.node')].forEach(node=>{
    if(!S.nodes.find(n=>n.id===node.dataset.nodeid)){
      node.remove();
    }
  });
}

function harvestNode(n){
  n.hp--;
  const gain = n.type==='tree'?4:5;
  S.materials += gain;
  toast(`Gathered +${gain} materials`);
  if(n.hp<=0){
    S.nodes = S.nodes.filter(x=>x.id!==n.id);
  }
  updateUI();
}

el('btnSave').addEventListener('click', ()=>{
  localStorage.setItem('econoville_save', JSON.stringify(S));
  toast('Game saved!');
});

el('btnLoad').addEventListener('click', ()=>{
  const save = localStorage.getItem('econoville_save');
  if(!save) return toast('No save found');
  Object.assign(S, JSON.parse(save));
  S.lastUpdate = Date.now();
  toast('Game loaded!');
  updateUI();
});

el('btnReset').addEventListener('click', ()=>{
  if(!confirm('Reset game? This cannot be undone.')) return;
  Object.assign(S, {
    day:1, year:1, season:0,
    pop:80, cap:100,
    farmers:0.5, builders:0.3, herders:0.1,
    materials:30, foodStock:20, livestock:0,
    health:0.6, morale:0.6,
    tfp:1.0, landQuality:1.0,
    weatherNow:null, weatherNext:null,
    tech:{basicFarming:true},
    builds:[], nodes:[],
    lastUpdate:Date.now()
  });
  rollWeather();
  spawnNodes();
  autoStarted = false;
  if(tickInterval){ clearInterval(tickInterval); tickInterval=null; }
  toast('Game reset! Click to start.');
  updateUI();
});

function rollWeather(){
  S.weatherNow = seasonWeighted(S.season);
  S.weatherNext = seasonWeighted(S.season);
}

function init(){
  S.tech.basicFarming = true;
  rollWeather();
  spawnNodes();
  updateUI();
  
  el('gameLog').innerHTML = `
    <strong>Welcome, Chief!</strong><br>
    • Allocate labor using sliders<br>
    • Click buildings to construct<br>
    • Click trees/rocks for materials<br>
    • Unlock tech to progress<br>
    • Time starts on first interaction
  `;
}

init();
</script>
</body>
</html>
