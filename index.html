<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Macroeconomic Town Simulator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        h1 {
            text-align: center; color: white; margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .town-display {
            height: 500px; position: relative;
            background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 60%, #90EE90 60%, #90EE90 100%);
            border-radius: 10px; overflow: hidden;
        }

        .building { position: absolute; bottom: 40%; transition: all 0.5s ease; }

        .factory { width: 80px; height: 60px; background: #8B4513; border: 2px solid #654321; }
        .factory::before {
            content: ''; position: absolute; top: -20px; left: 10px;
            width: 20px; height: 20px; background: #666; border-radius: 50%;
        }
        .factory.active::after {
            content: ''; position: absolute; top: -40px; left: 10px;
            width: 20px; height: 20px; background: #888; border-radius: 50%;
            animation: smoke 2s infinite;
        }
        @keyframes smoke {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-30px) scale(2); opacity: 0; }
        }

        .shop { width: 60px; height: 50px; background: #4169E1; border: 2px solid #1E90FF; position: relative; }
        .shop::before {
            content: 'SHOP'; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); color: white; font-size: 12px; font-weight: bold;
        }
        .shop.closed { background: #696969; opacity: 0.7; }
        .shop.closed::after {
            content: 'CLOSED'; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-20deg); color: red; font-size: 10px; font-weight: bold;
            background: white; padding: 2px;
        }

        .house { width: 50px; height: 40px; background: #FFB6C1; border: 2px solid #FF69B4; position: relative; }
        .house::before {
            content: ''; position: absolute; top: -15px; left: -5px; width: 0; height: 0;
            border-left: 30px solid transparent; border-right: 30px solid transparent; border-bottom: 15px solid #8B0000;
        }
        .house.forsale::after {
            content: 'FOR SALE'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: red; font-size: 8px; font-weight: bold; background: yellow; padding: 2px; white-space: nowrap;
        }

        .worker {
            position: absolute; width: 10px; height: 20px; background: #000; border-radius: 50% 50% 0 0;
            bottom: 40%; transition: all 1s ease;
        }
        .worker.unemployed { background: #FF0000; }

        .control-group { margin-bottom: 20px; }
        .control-group h3 {
            margin-bottom: 10px; color: #333; border-bottom: 2px solid #667eea; padding-bottom: 5px;
        }

        .control-item { margin-bottom: 15px; }
        .control-item label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        .control-item input[type="range"] { width: 100%; margin-bottom: 5px; }
        .control-item select {
            width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd; background: white;
        }

        .value-display { text-align: right; color: #667eea; font-weight: bold; }

        .stat-item {
            display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa;
            margin-bottom: 10px; border-radius: 5px; transition: all 0.3s ease;
        }
        .stat-item:hover { background: #e9ecef; transform: translateX(5px); }

        .stat-label { font-weight: 600; color: #495057; }
        .stat-value { font-weight: bold; color: #667eea; }

        .positive { color: #28a745 !important; }
        .negative { color: #dc3545 !important; }
        .neutral  { color: #6c757d !important; }

        button {
            width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: bold;
            cursor: pointer; transition: all 0.3s ease; margin-bottom: 10px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        button:active { transform: translateY(0); }

        .shock-buttons {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;
        }
        .shock-button { padding: 8px; font-size: 14px; background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%); }
        .shock-button:hover { box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4); }

        .info-box { background: #e8f4f8; border-left: 4px solid #667eea; padding: 10px; margin-bottom: 15px; border-radius: 5px; }
        .info-box h4 { margin-bottom: 5px; color: #667eea; }
        .info-box p { color: #666; font-size: 14px; }

        @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.05)} 100%{transform:scale(1)} }
        .warning {
            background: #fff3cd; border: 1px solid #ffc107; color: #856404;
            padding: 10px; border-radius: 5px; margin-bottom: 15px; animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèõÔ∏è Macroeconomic Town Simulator</h1>

        <div class="main-grid">
            <!-- Policy Controls -->
            <div class="panel">
                <h2>Policy Controls</h2>

                <div class="control-group">
                    <h3>Exchange Rate Regime</h3>
                    <div class="control-item">
                        <select id="exchangeRegime" onchange="updateRegime()">
                            <option value="flexible">Flexible Exchange Rate</option>
                            <option value="fixed">Fixed Exchange Rate</option>
                        </select>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Monetary Policy</h3>
                    <div class="control-item">
                        <label>Interest Rate (i)</label>
                        <input type="range" id="interestRate" min="0" max="20" value="5" step="0.5" oninput="updatePolicy()">
                        <div class="value-display"><span id="interestRateValue">5.0</span>%</div>
                    </div>
                    <div class="control-item">
                        <label>Money Supply (M)</label>
                        <input type="range" id="moneySupply" min="800" max="1500" value="1000" step="10" oninput="updatePolicy()">
                        <div class="value-display"><span id="moneySupplyValue">1000</span></div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Fiscal Policy</h3>
                    <div class="control-item">
                        <label>Government Spending (G)</label>
                        <input type="range" id="govSpending" min="100" max="400" value="200" step="10" oninput="updatePolicy()">
                        <div class="value-display"><span id="govSpendingValue">200</span></div>
                    </div>
                    <div class="control-item">
                        <label>Tax Rate (T)</label>
                        <input type="range" id="taxRate" min="10" max="50" value="25" step="1" oninput="updatePolicy()">
                        <div class="value-display"><span id="taxRateValue">25</span>%</div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>External Conditions</h3>
                    <div class="control-item">
                        <label>Foreign Interest Rate (i*)</label>
                        <input type="range" id="foreignRate" min="0" max="20" value="5" step="0.5" oninput="updatePolicy()">
                        <div class="value-display"><span id="foreignRateValue">5.0</span>%</div>
                    </div>
                    <div class="control-item">
                        <label>Foreign Output (Y*)</label>
                        <input type="range" id="foreignOutput" min="800" max="1200" value="1000" step="10" oninput="updatePolicy()">
                        <div class="value-display"><span id="foreignOutputValue">1000</span></div>
                    </div>
                </div>

                <div class="shock-buttons">
                    <button class="shock-button" onclick="applyShock('demand')">Demand Shock</button>
                    <button class="shock-button" onclick="applyShock('supply')">Supply Shock</button>
                    <button class="shock-button" onclick="applyShock('productivity')">Productivity Shock</button>
                    <button class="shock-button" onclick="applyShock('financial')">Financial Crisis</button>
                </div>
            </div>

            <!-- Town Visualization -->
            <div class="panel">
                <h2>Economic Town</h2>
                <div id="townWarning" class="warning" style="display: none;"></div>
                <div class="town-display" id="townDisplay"></div>
                <div class="info-box">
                    <h4>Town Status</h4>
                    <p id="townStatus">Normal economic conditions</p>
                </div>
                <button onclick="runSimulation()">Run Simulation Step</button>
                <button onclick="resetSimulation()">Reset Economy</button>
            </div>

            <!-- Economic Indicators -->
            <div class="panel">
                <h2>Economic Indicators</h2>

                <div class="control-group">
                    <h3>Real Economy</h3>
                    <div class="stat-item">
                        <span class="stat-label">Output (Y)</span>
                        <span class="stat-value" id="outputValue">1000</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Output Gap</span>
                        <span class="stat-value" id="outputGapValue">0.0%</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Unemployment (U)</span>
                        <span class="stat-value" id="unemploymentValue">5.0%</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Natural Rate (≈™)</span>
                        <span class="stat-value neutral" id="naturalRateValue">5.0%</span>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Prices & Inflation</h3>
                    <div class="stat-item">
                        <span class="stat-label">Price Level (P)</span>
                        <span class="stat-value" id="priceLevelValue">100</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Inflation (œÄ)</span>
                        <span class="stat-value" id="inflationValue">2.0%</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Expected Inflation (œÄ^e)</span>
                        <span class="stat-value" id="expectedInflationValue">2.0%</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Core Inflation</span>
                        <span class="stat-value" id="coreInflationValue">2.0%</span>
                    </div>
                </div>

                <div class="control-group">
                    <h3>External Sector</h3>
                    <div class="stat-item">
                        <span class="stat-label">Exchange Rate (S)</span>
                        <span class="stat-value" id="exchangeRateValue">1.00</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Real Exchange Rate (œÉ)</span>
                        <span class="stat-value" id="realExchangeRateValue">1.00</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Net Exports (NX)</span>
                        <span class="stat-value" id="netExportsValue">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Current Account</span>
                        <span class="stat-value" id="currentAccountValue">0</span>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Financial Markets</h3>
                    <div class="stat-item">
                        <span class="stat-label">Real Interest Rate (r)</span>
                        <span class="stat-value" id="realRateValue">3.0%</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Money Velocity (V)</span>
                        <span class="stat-value" id="velocityValue">1.0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Real Balances (M/P)</span>
                        <span class="stat-value" id="realBalancesValue">10.0</span>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Components of GDP</h3>
                    <div class="stat-item">
                        <span class="stat-label">Consumption (C)</span>
                        <span class="stat-value" id="consumptionValue">600</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Investment (I)</span>
                        <span class="stat-value" id="investmentValue">200</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Government (G)</span>
                        <span class="stat-value" id="governmentValue">200</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Net Exports (NX)</span>
                        <span class="stat-value" id="nxValue">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">MPC</span>
                        <span class="stat-value neutral" id="mpcValue">0.75</span>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Accounting Check</h3>
                    <div class="stat-item">
                        <span class="stat-label">C + I + G + NX</span>
                        <span class="stat-value" id="identityCheckValue">1000</span>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Economic Model State
        let economy = {
            // Real variables
            Y: 1000,           // Output
            Y_natural: 1000,   // Natural output
            U: 5.0,            // Unemployment rate
            U_natural: 5.0,    // Natural unemployment rate

            // Prices
            P: 100,            // Price level
            P_foreign: 100,    // Foreign price level
            inflation: 2.0,    // Current inflation
            expectedInflation: 2.0, // Expected inflation
            coreInflation: 2.0,    // Core inflation

            // Exchange rates
            S: 1.0,            // Nominal exchange rate
            sigma: 1.0,        // Real exchange rate
            regime: 'flexible', // Exchange rate regime

            // Policy variables
            i: 5.0,            // Interest rate (nominal)
            i_foreign: 5.0,    // Foreign interest rate
            M: 1000,           // Money supply
            G: 200,            // Government spending
            T: 0.25,           // Tax rate

            // Components
            C: 600,            // Consumption
            I: 200,            // Investment
            NX: 0,             // Net exports

            // Foreign sector
            Y_foreign: 1000,   // Foreign output

            // Parameters
            alpha: 0.5,        // Phillips curve parameter
            beta: 0.5,         // Okun's law parameter
            mpc: 0.75,         // Marginal propensity to consume
            productivity: 1.0, // Productivity level

            // Dynamic variables
            time: 0,
            shockActive: false,
            shockType: null
        };

        // Initialize town visualization
        function initializeTown() {
            const townDisplay = document.getElementById('townDisplay');
            townDisplay.innerHTML = '';

            // Factories
            for (let i = 0; i < 3; i++) {
                const factory = document.createElement('div');
                factory.className = 'building factory active';
                factory.style.left = `${50 + i * 150}px`;
                factory.id = `factory${i}`;
                townDisplay.appendChild(factory);
            }

            // Shops
            for (let i = 0; i < 4; i++) {
                const shop = document.createElement('div');
                shop.className = 'building shop';
                shop.style.left = `${100 + i * 120}px`;
                shop.id = `shop${i}`;
                townDisplay.appendChild(shop);
            }

            // Houses
            for (let i = 0; i < 5; i++) {
                const house = document.createElement('div');
                house.className = 'building house';
                house.style.left = `${60 + i * 100}px`;
                house.style.bottom = '20%';
                house.id = `house${i}`;
                townDisplay.appendChild(house);
            }

            // Workers
            for (let i = 0; i < 10; i++) {
                const worker = document.createElement('div');
                worker.className = 'worker';
                worker.style.left = `${30 + Math.random() * 500}px`;
                worker.id = `worker${i}`;
                townDisplay.appendChild(worker);
            }
        }

        // IS-LM calculations
        function calculateIS() {
            // Disposable income and consumption
            const Y_d = economy.Y * (1 - economy.T);
            economy.C = 100 + economy.mpc * Y_d;

            // Investment depends on real rate
            const r = Math.max(-5, economy.i - economy.expectedInflation); // clamp
            economy.I = Math.max(0, 400 - 20 * r);

            // NX depends on RER, foreign output, and domestic income
            economy.NX = 100 * (economy.Y_foreign / 1000) - 50 * economy.sigma - 0.1 * economy.Y;

            // Simple multiplier with leakage for imports (0.1*Y)
            const k = 1 / (1 - economy.mpc * (1 - economy.T) + 0.1);
            const autonomous = (100 + economy.I + economy.G + (100 * (economy.Y_foreign / 1000) - 50 * economy.sigma))
                               - economy.mpc * economy.Y * (1 - economy.T);
            return k * (autonomous - 0.1 * economy.Y);
        }

        function calculateLM() {
            // Velocity increases with the nominal rate (simple)
            const velocity = 1 + 0.1 * economy.i;
            const realBalances = economy.M / economy.P;
            // Income consistent with money market: Y = V * (M/P)
            return realBalances * velocity * 100; // scale so baseline ~1000 when M/P=10 and V=1
        }

        // Phillips Curve & Okun's Law
        function updatePhillipsCurve() {
            const outputGap = (economy.Y - economy.Y_natural) / economy.Y_natural;
            economy.inflation = economy.expectedInflation + economy.alpha * outputGap * 100;
            economy.coreInflation = 0.8 * economy.coreInflation + 0.2 * economy.inflation;
        }

        function updateOkunsLaw() {
            const outputGap = (economy.Y - economy.Y_natural) / economy.Y_natural;
            economy.U = economy.U_natural - economy.beta * outputGap * 100;
            economy.U = Math.max(0, Math.min(25, economy.U));
        }

        // Exchange rate dynamics
        function updateExchangeRate() {
            if (economy.regime === 'flexible') {
                const interestDiff = economy.i - economy.i_foreign;
                const longRunS = (economy.P / economy.P_foreign);
                economy.S = longRunS * (1 + 0.1 * interestDiff);
                economy.sigma = (economy.S * economy.P) / economy.P_foreign;
            } else {
                // Fixed peg
                economy.S = 1.0;
                economy.sigma = economy.P / economy.P_foreign;

                // Adjust M to keep i ~ i*
                if (Math.abs(economy.i - economy.i_foreign) > 0.05) {
                    economy.M = Math.max(100, economy.M * (1 + 0.1 * (economy.i_foreign - economy.i)));
                    economy.i = economy.i_foreign;
                }
            }
        }

        // Mundell-Fleming flavor
        function applyMundellFleming() {
            if (economy.regime === 'fixed') {
                if (Math.abs(economy.i - economy.i_foreign) > 0.1) {
                    economy.M = Math.max(100, economy.M * (economy.i_foreign / Math.max(0.1, economy.i)));
                    economy.i = economy.i_foreign;
                }
                const fiscalImpact = (economy.G - 200) * 2;
                economy.Y = economy.Y_natural + fiscalImpact;
            } else {
                if (economy.G > 200) {
                    economy.sigma = economy.sigma * (1 + 0.001 * (economy.G - 200));
                    economy.NX = economy.NX - 0.5 * (economy.G - 200);
                }
                const monetaryImpact = (5 - economy.i) * 50; // lower i -> boost Y
                economy.Y = economy.Y + monetaryImpact;
            }
        }

        // Simulation step
        function runSimulation() {
            economy.time++;

            // IS-LM equilibrium (simple averaging towards intersection)
            const Y_IS = calculateIS();
            const Y_LM = calculateLM();
            economy.Y = (0.5 * Y_IS + 0.5 * Y_LM);

            applyMundellFleming();
            updateExchangeRate();
            updatePhillipsCurve();
            updateOkunsLaw();

            // Price adjusts gradually toward MV=PY target
            const V = 1 + 0.1 * economy.i;
            const targetP = (economy.M * V) / Math.max(1, economy.Y / 100); // scaled
            economy.P = 0.9 * economy.P + 0.1 * targetP;

            // Expectations adapt
            economy.expectedInflation = 0.7 * economy.expectedInflation + 0.3 * economy.inflation;

            // Natural output follows productivity
            economy.Y_natural = 1000 * economy.productivity;

            if (economy.shockActive) applyShockEffects();

            updateDisplay();
            updateTownVisualization();
        }

        // Shocks
        function applyShock(type) {
            economy.shockActive = true;
            economy.shockType = type;

            switch(type) {
                case 'demand':
                    economy.C *= 1.2;
                    economy.I *= 1.15;
                    showWarning("Demand surge! Consumer confidence boost!");
                    break;
                case 'supply':
                    economy.P *= 1.1;
                    economy.inflation += 5;
                    showWarning("Supply shock! Input costs rising!");
                    break;
                case 'productivity':
                    economy.productivity = Math.min(1.5, economy.productivity * 1.1);
                    economy.Y_natural *= 1.1;
                    showWarning("Productivity breakthrough! Potential output increased!");
                    break;
                case 'financial':
                    economy.I *= 0.5;
                    economy.i = Math.min(economy.i, 0.5);
                    showWarning("Financial crisis! Credit crunch in effect!");
                    break;
            }

            runSimulation();
        }

        function applyShockEffects() {
            // Dissipate shocks every 5 ticks
            if (economy.time % 5 === 0) {
                economy.shockActive = false;
                economy.productivity = 0.95 * economy.productivity + 0.05 * 1.0;
                hideWarning();
            }
        }

        // UI updates
        function updateDisplay() {
            // Real economy
            document.getElementById('outputValue').textContent = economy.Y.toFixed(1);
            const outputGapPct = ((economy.Y - economy.Y_natural) / economy.Y_natural) * 100;
            const ogEl = document.getElementById('outputGapValue');
            ogEl.textContent = outputGapPct.toFixed(1) + '%';
            ogEl.className = outputGapPct > 0 ? 'stat-value positive' : outputGapPct < 0 ? 'stat-value negative' : 'stat-value neutral';

            const uEl = document.getElementById('unemploymentValue');
            uEl.textContent = economy.U.toFixed(1) + '%';
            uEl.className = (economy.U < economy.U_natural) ? 'stat-value positive' :
                            (economy.U > economy.U_natural) ? 'stat-value negative' : 'stat-value neutral';
            document.getElementById('naturalRateValue').textContent = economy.U_natural.toFixed(1) + '%';

            // Prices & Inflation
            document.getElementById('priceLevelValue').textContent = economy.P.toFixed(1);
            document.getElementById('inflationValue').textContent = economy.inflation.toFixed(1) + '%';
            document.getElementById('expectedInflationValue').textContent = economy.expectedInflation.toFixed(1) + '%';
            document.getElementById('coreInflationValue').textContent = economy.coreInflation.toFixed(1) + '%';

            // External
            document.getElementById('exchangeRateValue').textContent = economy.S.toFixed(2);
            document.getElementById('realExchangeRateValue').textContent = economy.sigma.toFixed(2);
            document.getElementById('netExportsValue').textContent = economy.NX.toFixed(1);
            // Simple proxy for current account ~ NX
            document.getElementById('currentAccountValue').textContent = economy.NX.toFixed(1);

            // Financial
            const r = economy.i - economy.expectedInflation;
            document.getElementById('realRateValue').textContent = r.toFixed(1) + '%';
            const V = 1 + 0.1 * economy.i;
            document.getElementById('velocityValue').textContent = V.toFixed(2);
            document.getElementById('realBalancesValue').textContent = (economy.M / Math.max(1, economy.P)).toFixed(2);

            // GDP components (use current C/I/G/NX)
            document.getElementById('consumptionValue').textContent = economy.C.toFixed(1);
            document.getElementById('investmentValue').textContent = economy.I.toFixed(1);
            document.getElementById('governmentValue').textContent = economy.G.toFixed(1);
            document.getElementById('nxValue').textContent = economy.NX.toFixed(1);
            document.getElementById('mpcValue').textContent = economy.mpc.toFixed(2);

            const identity = economy.C + economy.I + economy.G + economy.NX;
            document.getElementById('identityCheckValue').textContent = identity.toFixed(1);

            // Town status text
            let status = [];
            if (outputGapPct > 2) status.push("Economy running hot");
            if (outputGapPct < -2) status.push("Economy below potential");
            if (economy.inflation > 4) status.push("Inflation pressures");
            if (economy.U > economy.U_natural + 1) status.push("Labour slack rising");
            if (status.length === 0) status.push("Normal economic conditions");
            document.getElementById('townStatus').textContent = status.join(" ¬∑ ");
        }

        function updateTownVisualization() {
            const gap = (economy.Y - economy.Y_natural) / economy.Y_natural;
            const hot = gap > 0.02;
            const cold = gap < -0.02;

            // Factories: active (smoke) when economy hot, idle when cold
            for (let i = 0; i < 3; i++) {
                const f = document.getElementById(`factory${i}`);
                if (!f) continue;
                if (hot) { f.classList.add('active'); }
                else if (cold) { f.classList.remove('active'); }
                // y-position wiggle to hint capacity strain
                f.style.bottom = hot ? '42%' : cold ? '38%' : '40%';
            }

            // Shops: close some when cold
            for (let i = 0; i < 4; i++) {
                const s = document.getElementById(`shop${i}`);
                if (!s) continue;
                s.classList.toggle('closed', cold && i >= 2);
            }

            // Houses: show for-sale signs when unemployment is high
            const highU = economy.U > economy.U_natural + 1.5;
            for (let i = 0; i < 5; i++) {
                const h = document.getElementById(`house${i}`);
                if (!h) continue;
                h.classList.toggle('forsale', highU && i % 2 === 0);
            }

            // Workers: some become unemployed (red) and drift
            const joblessShare = Math.min(1, Math.max(0, economy.U / 25));
            for (let i = 0; i < 10; i++) {
                const w = document.getElementById(`worker${i}`);
                if (!w) continue;
                const unemployed = (i / 10) < joblessShare;
                w.classList.toggle('unemployed', unemployed);
                // gentle wander
                const baseLeft = 30 + i * 50 * 0.5;
                const jitter = (Math.sin((economy.time + i) * 0.5) * 10);
                w.style.left = `${Math.max(10, Math.min(560, baseLeft + jitter))}px`;
                w.style.bottom = unemployed ? '35%' : '40%';
            }
        }

        // Controls
        function updatePolicy() {
            const iEl = document.getElementById('interestRate');
            const MEl = document.getElementById('moneySupply');
            const GEl = document.getElementById('govSpending');
            const TEl = document.getElementById('taxRate');
            const ifEl = document.getElementById('foreignRate');
            const YfEl = document.getElementById('foreignOutput');

            economy.i = parseFloat(iEl.value);
            economy.M = parseFloat(MEl.value);
            economy.G = parseFloat(GEl.value);
            economy.T = parseFloat(TEl.value) / 100.0;
            economy.i_foreign = parseFloat(ifEl.value);
            economy.Y_foreign = parseFloat(YfEl.value);

            // update inline value displays
            document.getElementById('interestRateValue').textContent = economy.i.toFixed(1);
            document.getElementById('moneySupplyValue').textContent = economy.M.toFixed(0);
            document.getElementById('govSpendingValue').textContent = economy.G.toFixed(0);
            document.getElementById('taxRateValue').textContent = (economy.T * 100).toFixed(0);
            document.getElementById('foreignRateValue').textContent = economy.i_foreign.toFixed(1);
            document.getElementById('foreignOutputValue').textContent = economy.Y_foreign.toFixed(0);

            // Each user tweak triggers a small step so students see effects immediately
            runSimulation();
        }

        function updateRegime() {
            const sel = document.getElementById('exchangeRegime');
            economy.regime = sel.value;
            showWarning(economy.regime === 'fixed'
                ? "Fixed exchange rate: monetary policy is constrained; fiscal policy is powerful."
                : "Flexible exchange rate: monetary policy is powerful; fiscal policy is damped by ER moves.");
            runSimulation();
        }

        function resetSimulation() {
            economy = {
                Y: 1000, Y_natural: 1000, U: 5.0, U_natural: 5.0,
                P: 100, P_foreign: 100, inflation: 2.0, expectedInflation: 2.0, coreInflation: 2.0,
                S: 1.0, sigma: 1.0, regime: document.getElementById('exchangeRegime').value,
                i: parseFloat(document.getElementById('interestRate').value),
                i_foreign: parseFloat(document.getElementById('foreignRate').value),
                M: parseFloat(document.getElementById('moneySupply').value),
                G: parseFloat(document.getElementById('govSpending').value),
                T: parseFloat(document.getElementById('taxRate').value) / 100.0,
                C: 600, I: 200, NX: 0,
                Y_foreign: parseFloat(document.getElementById('foreignOutput').value),
                alpha: 0.5, beta: 0.5, mpc: 0.75, productivity: 1.0,
                time: 0, shockActive: false, shockType: null
            };
            hideWarning();
            initializeTown();
            updateDisplay();
            updateTownVisualization();
        }

        function showWarning(msg) {
            const w = document.getElementById('townWarning');
            w.style.display = 'block';
            w.textContent = msg;
        }
        function hideWarning() {
            const w = document.getElementById('townWarning');
            w.style.display = 'none';
            w.textContent = '';
        }

        // Boot
        window.addEventListener('load', () => {
            initializeTown();
            updateDisplay();
            updateTownVisualization();
        });
    </script>
</body>
</html>
