<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EconoVille – Fixed Exchange Rate Macro Simulator</title>
  <style>
    :root{
      --bg1:#6a5acd; --bg2:#7a5cda;
      --card:#ffffff; --muted:#667085; --ink:#101828;
      --accent:#6337ee; --accent2:#9b8cff;
      --good:#0d9488; --warn:#f59e0b; --bad:#dc2626;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      color:var(--ink);
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:auto;padding:18px;display:grid;grid-template-columns:320px 1fr 320px;gap:16px}
    h2{margin:.25rem 0 .5rem 0}
    .panel{
      background:var(--card); border-radius:14px; padding:14px; box-shadow:0 8px 24px rgba(16,24,40,.12)
    }
    .section{margin:10px 0; padding-top:6px; border-top:1px solid #eef2f7}
    label{font-size:.9rem; color:var(--muted); display:flex; justify-content:space-between}
    input[type=range]{width:100%}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .btn{
      width:100%; border:0; padding:10px 14px; border-radius:10px;
      background:linear-gradient(90deg,#4338ca,#7c3aed); color:#fff; font-weight:700; cursor:pointer
    }
    .btn.secondary{background:#e7e5ff; color:#312e81}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .kv{display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #eef2f7}
    .kv small{color:var(--muted)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.8rem}
    .pill.good{background:#ecfdf5;color:var(--good)}
    .pill.warn{background:#fffbeb;color:var(--warn)}
    .pill.bad{background:#fef2f2;color:var(--bad)}
    canvas{width:100%; aspect-ratio:16/9; background:linear-gradient(#9bd0ff 60%, #89e27f 40%); border-radius:12px; border:2px solid #2f855a}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Controls -->
    <div class="panel">
      <h2>Policy Controls</h2>
      <div class="section">
        <label>Exchange Rate Regime <strong>Fixed (peg)</strong></label>
        <small class="mono">S = 1.00 (nominal peg)</small>
      </div>
      <div class="section">
        <h3>Monetary</h3>
        <label>Interest Rate i <span><span id="iLbl">1.5</span>%</span></label>
        <input id="iInput" type="range" min="0" max="10" step="0.1" value="1.5">
        <label>Base Money M <span><span id="mLbl">870</span></span></label>
        <input id="mInput" type="range" min="400" max="2000" step="10" value="870">
      </div>
      <div class="section">
        <h3>Fiscal</h3>
        <label>Government Spending G <span><span id="gLbl">190</span></span></label>
        <input id="gInput" type="range" min="100" max="400" step="5" value="190">
        <label>Tax Rate τ <span><span id="tLbl">30</span>%</span></label>
        <input id="tInput" type="range" min="0" max="60" step="1" value="30">
      </div>
      <div class="section">
        <h3>External</h3>
        <label>Foreign Output Y* <span><span id="yfLbl">1000</span></span></label>
        <input id="yfInput" type="range" min="800" max="1200" step="10" value="1000">
        <label>Foreign Price P* <span><span id="pstarLbl">100</span></span></label>
        <input id="pstarInput" type="range" min="80" max="140" step="1" value="100">
      </div>
      <div class="section row">
        <button id="stepBtn" class="btn">Run Simulation Step</button>
        <button id="resetBtn" class="btn secondary">Reset Economy</button>
      </div>
      <div class="section">
        <h3>Shock Buttons</h3>
        <div class="row">
          <button class="btn" style="background:#0ea5e9" id="confShock">Confidence +</button>
          <button class="btn" style="background:#f97316" id="creditShock">Credit Spread +</button>
        </div>
        <small class="mono">Shocks decay (ρ≈0.85).</small>
      </div>
    </div>

    <!-- Town -->
    <div class="panel">
      <h2>Economic Town</h2>
      <canvas id="town"></canvas>
      <div class="section">
        <div id="status" class="pill good">Normal economic conditions</div>
      </div>
      <div class="section grid2">
        <div class="kv"><span>Accounting Check (real):</span><strong class="mono" id="acctChk">OK</strong></div>
        <div class="kv"><span>Reserves (R):</span><strong class="mono" id="rLbl">500</strong></div>
        <div class="kv"><span>Peg Pressure:</span><strong id="pegLbl" class="pill good">Low</strong></div>
        <div class="kv"><span>Nominal GDP (P×Y):</span><strong class="mono" id="ngdpLbl">100,000</strong></div>
      </div>
    </div>

    <!-- Indicators -->
    <div class="panel">
      <h2>Economic Indicators</h2>
      <div class="section">
        <h3>Real Economy</h3>
        <div class="kv"><span>Output (Y)</span><strong class="mono" id="yLbl">1000.0</strong></div>
        <div class="kv"><span>Output Gap</span><strong class="mono" id="gapLbl">0.0%</strong></div>
        <div class="kv"><span>Unemployment (U)</span><strong class="mono" id="uLbl">5.0%</strong></div>
      </div>
      <div class="section">
        <h3>Prices & Inflation</h3>
        <div class="kv"><span>Price Level (P)</span><strong class="mono" id="pLbl">100.0</strong></div>
        <div class="kv"><span>Inflation (π)</span><strong class="mono" id="piLbl">2.0%</strong></div>
        <div class="kv"><span>Expected Inflation (πᵉ)</span><strong class="mono" id="pieLbl">2.0%</strong></div>
        <div class="kv"><span>Core Inflation</span><strong class="mono" id="coreLbl">2.0%</strong></div>
      </div>
      <div class="section">
        <h3>External Sector</h3>
        <div class="kv"><span>Nominal Rate (S)</span><strong class="mono">1.00</strong></div>
        <div class="kv"><span>Real Exchange Rate (q = S·P*/P)</span><strong class="mono" id="qLbl">1.00</strong></div>
        <div class="kv"><span>Net Exports (NX, real)</span><strong class="mono" id="nxLbl">0.0</strong></div>
        <div class="kv"><span>Current Account (≈ NX, nominal)</span><strong class="mono" id="caLbl">0.0</strong></div>
      </div>
      <div class="section">
        <h3>Financial Markets</h3>
        <div class="kv"><span>Real Interest Rate (r = i − πᵉ)</span><strong class="mono" id="rrealLbl">-0.5%</strong></div>
        <div class="kv"><span>Money Velocity (V)</span><strong class="mono" id="vLbl">1.15</strong></div>
        <div class="kv"><span>Real Money (M/P)</span><strong class="mono" id="mpLbl">8.70</strong></div>
      </div>
      <div class="section">
        <h3>Components of GDP (real)</h3>
        <div class="kv"><span>Consumption (C)</span><strong class="mono" id="cLbl">600.0</strong></div>
        <div class="kv"><span>Investment (I)</span><strong class="mono" id="iInvLbl">200.0</strong></div>
        <div class="kv"><span>Government (G)</span><strong class="mono" id="gOutLbl">190.0</strong></div>
        <div class="kv"><span>Net Exports (NX)</span><strong class="mono" id="nx2Lbl">0.0</strong></div>
      </div>
    </div>
  </div>

  <!-- === ECONOMICS ENGINE (red flags fixed) === -->
  <script>
    // Parameters and State — see previous assistant message for full explanations
    const P = { Y_pot:1000, NAIRU:0.05, U_min:0.035, c0:150,c1:0.75,I0:150,b_r:25,b_gapLag:30,NX_ss:0,eta_q:300,mu_Y:0.20,lambda:0.25,beta_okun:0.40,kappa:0.30,adj_U:0.50,V_ss:1.15,rhoV:0.80,S:1.00,R0:500,R_min:120,phi_CA_to_M:0.60,gapCap:0.20,V_min:0.60,V_max:1.80,P_min:40,P_max:400};
    const S = {i_nom:0.015,M:870,G:190,tau:0.30,Yf:1000,Pstar:100,Y:1000,P:100,V:P.V_ss,pi:0.02,pi_e:0.02,pi_core:0.02,U:0.05,R:P.R0,C:600,I:200,NX:0,gapLag:0,shockConf:0,shockCredit:0};

    const $=id=>document.getElementById(id);
    const pct=x=>(100*x).toFixed(1)+'%'; const num=x=>Number(x).toFixed(1);

    function stepModel(){
      S.i_nom=$('iInput').value/100; S.M=+$('mInput').value; S.G=+$('gInput').value; S.tau=$('tInput').value/100; S.Yf=+$('yfInput').value; S.Pstar=+$('pstarInput').value;
      S.pi_e=(1-P.lambda)*S.pi_e+P.lambda*S.pi; const r=S.i_nom-S.pi_e;
      const q=P.S*(S.Pstar/S.P); const A=1-P.c1*(1-S.tau)+P.mu_Y; const constTerm=(P.c0+S.shockConf)+(P.I0-P.b_r*(r*100)+P.b_gapLag*S.gapLag-S.shockCredit)+S.G+(P.NX_ss+P.eta_q*(q-1)+P.mu_Y*S.Yf);
      let Y_new=constTerm/A; let gap_raw=(Y_new-P.Y_pot)/P.Y_pot; const gap=Math.min(P.gapCap,Math.max(-P.gapCap,gap_raw)); Y_new=P.Y_pot*(1+gap);
      const T=S.tau*Y_new; const C0=(P.c0+S.shockConf)+P.c1*(Y_new-T); const I0=(P.I0-P.b_r*(r*100)+P.b_gapLag*S.gapLag-S.shockCredit); const NX0=P.NX_ss+P.eta_q*(q-1)-P.mu_Y*(Y_new-S.Yf); const sum0=C0+I0+S.G+NX0; const recon=Y_new-sum0;
      S.C=C0+recon; S.I=I0; S.NX=NX0; S.Y=Y_new;
      const Vt=P.V_ss; S.V=Math.min(P.V_max,Math.max(P.V_min,P.rhoV*S.V+(1-P.rhoV)*Vt)); const Pprev=S.P; S.P=Math.min(P.P_max,Math.max(P.P_min,(S.M*S.V)/S.Y)); S.pi=Math.min(0.20,Math.max(-0.20,S.P/Pprev-1)); S.pi_core=Math.min(0.20,Math.max(-0.20,S.pi_core+P.kappa*gap));
      const Utarget=Math.max(P.NAIRU-P.beta_okun*gap,P.U_min); S.U=Math.min(0.25,Math.max(0.03,S.U+P.adj_U*(Utarget-S.U)));
      const CA_nom=S.NX*S.P; S.R+=CA_nom; S.M+=P.phi_CA_to_M*(CA_nom/S.P);
      S.gapLag=0.7*S.gapLag+0.3*gap; S.shockConf*=0.85; S.shockCredit*=0.85;
      render();
    }

    function render(){
      const gap=(S.Y-P.Y_pot)/P.Y_pot;
      if(Math.abs(gap)>0.08&&S.pi>0.04){$('status').textContent='Economy overheating';$('status').className='pill warn';}
      else if(gap<-0.04){$('status').textContent='Slack in economy';$('status').className='pill warn';}
      else{$('status').textContent='Normal economic conditions';$('status').className='pill good';}
      const pegPress=S.R<P.R_min?'High':(S.R<1.6*P.R_min?'Rising':'Low'); $('pegLbl').textContent=pegPress; $('pegLbl').className='pill '+(S.R<P.R_min?'bad':(S.R<1.6*P.R_min?'warn':'good'));
      $('yLbl').textContent=num(S.Y); $('gapLbl').textContent=pct(gap); $('uLbl').textContent=pct(S.U);
      $('pLbl').textContent=num(S.P); $('piLbl').textContent=pct(S.pi); $('pieLbl').textContent=pct(S.pi_e); $('coreLbl').textContent=pct(S.pi_core);
      const qNow=P.S*(S.Pstar/S.P); $('qLbl').textContent=num(qNow); $('nxLbl').textContent=num(S.NX); $('caLbl').textContent=num(S.NX*S.P);
      $('rrealLbl').textContent=pct(S.i_nom-S.pi_e); $('vLbl').textContent=S.V.toFixed(2); $('mpLbl').textContent=num(S.M/S.P);
      $('cLbl').textContent=num(S.C); $('iInvLbl').textContent=num(S.I); $('gOutLbl').textContent=num(S.G); $('nx2Lbl').textContent=num(S.NX);
      const sum=S.C+S.I+S.G+S.NX; $('acctChk').textContent=(Math.abs(sum-S.Y)<0.5?'OK':'Check')+' (Σ='+num(sum)+')';
      $('ngdpLbl').textContent=num(S.P*S.Y); $('rLbl').textContent=num(S.R);
    }

    // Hook buttons
    $('stepBtn').onclick=stepModel; $('resetBtn').onclick=()=>{Object.assign(S,{i_nom:0.015,M:870,G:190,tau:0.30,Yf:1000,Pstar:100,Y:1000,P:100,V:P.V_ss,pi:0.02,pi_e:0.02,pi_core:0.02,U:0.05,R:P.R0,C:600,I:200,NX:0,gapLag:0,shockConf:0,shockCredit:0}); stepModel();};
    $('confShock').onclick=()=>{S.shockConf+=20;stepModel();}; $('creditShock').onclick=()=>{S.shockCredit+=20;stepModel();};

    stepModel(); // initial draw
  </script>
</body>
</html>
