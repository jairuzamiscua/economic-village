<div class="long-term">
              <strong>Long-term:</strong> Investment and productivity growth ${direction === 'higher' ? 'may slow' : 'could accelerate'}, affecting potential GDP.
            </div>
          </div>
          
          <div class="impact-analysis">
            <div class="winners">
              <div class="impact-title">Winners:</div>
              ${direction === 'higher' ? 
                '• Savers earn higher returns<br>• Import-competing industries (stronger currency)' :
                '• Borrowers face lower costs<br>• Export industries benefit<br>• First-time home buyers'}
            </div>
            <div class="losers">
              <div class="impact-title">Losers:</div>
              ${direction === 'higher' ? 
                '• Borrowers face higher costs<br>• Construction and housing sectors<br>• Export industries' :
                '• Savers receive lower returns<br>• May fuel asset bubbles'}
            </div>
          </div>
          
          <div class="evaluation-point">
            <strong>Effectiveness depends on:</strong> Consumer confidence and business expectations. If households are already pessimistic, rate cuts may have limited impact on spending.
            <a href="${EDU_REFS.taylor.url}" class="ref-link" target="_blank">${EDU_REFS.taylor.title}</a>
          </div>
          
          <div class="evaluation-point">
            <strong>Limitations:</strong> Monetary policy operates with 12-18 month lags. The housing market shows immediate effects, but broader economic impacts take time to materialize.
          </div>
        `;
        
      } else if (lastControl === 'gdpGrowth') {
        const trend = cur.gdp_growth_pct > prev.gdp_growth_pct ? 'stronger' : 'weaker';
        const gapDescription = gap > 0 ? 'above potential' : gap < -1 ? 'in recession' : 'near potential';
        
        analysis = `
          <div class="analysis-chain">
            <div class="chain-step">
              <strong>Growth shock:</strong> GDP growth ${trend === 'stronger' ? 'accelerates' : 'slows'} to ${cur.gdp_growth_pct.toFixed(1)}%, 
              putting the economy ${gapDescription} (potential = ${MODEL.potential_growth}%).
            </div>
            <div class="chain-step">
              <span class="chain-arrow">↓</span>
              <strong>Labour market response:</strong> <span class="econ-concept" title="Output growth affects employment">Okun's law</span> 
              suggests unemployment ${trend === 'stronger' ? 'falls' : 'rises'} as firms ${trend === 'stronger' ? 'hire more workers' : 'cut jobs'}.
            </div>
            <div class="chain-step">
              <span class="chain-arrow">↓</span>
              <strong>Inflation pressure:</strong> The <span class="econ-concept" title="Trade-off between unemployment and inflation">Phillips curve</span> 
              indicates ${gap > 0 ? 'upward' : 'downward'} pressure on wages and prices.
            </div>
            <div class="chain-step">
              <span class="chain-arrow">↓</span>
              <strong>Village effects:</strong> Factory capacity at ${(state.factory_capacity * 100).toFixed(0)}%, 
              ${(state.shops_closed_rate * 100).toFixed(0)}% shop closure rate reflects demand conditions.
            </div>
          </div>
        `;
        
        evaluation = `
          <div class="time-horizon">
            <div class="short-term">
              <strong>Short-term:</strong> Employment effects visible within quarters. Consumer confidence ${trend === 'stronger' ? 'improves' : 'weakens'} quickly.
            </div>
            <div class="long-term">
              <strong>Long-term:</strong> Sustained ${trend === 'stronger' ? 'above-potential' : 'below-potential'} growth affects inflation expectations and potential output.
            </div>
          </div>
          
          <div class="evaluation-point">
            <strong>Multiplier effects:</strong> Initial spending changes create larger economic impacts through the 
            <span class="econ-concept" title="How initial spending creates larger economic changes">multiplier process</span>. 
            Each £1 of spending may generate £1.50+ in total economic activity.
            <a href="${EDU_REFS.multiplier.url}" class="ref-link" target="_blank">${EDU_REFS.multiplier.title}</a>
          </div>
          
          <div class="evaluation-point">
            <strong>Automatic stabilisers:</strong> ${gap < 0 ? 'Government spending rises and tax receipts fall, providing some cushioning' : 'Higher growth increases tax receipts, potentially cooling the economy'}.
            <a href="${EDU_REFS.stabilisers.url}" class="ref-link" target="_blank">${EDU_REFS.stabilisers.title}</a>
          </div>
        `;
        
      } else if (lastControl === 'unemployment') {
        const change = cur.unemployment_pct > prev.unemployment_pct ? 'risen' : 'fallen';
        const uGap = cur.unemployment_pct - MODEL.u_star;
        
        analysis = `
          <div class="analysis-chain">
            <div class="chain-step">
              <strong>Labour market shift:</strong> Unemployment has ${change} to ${cur.unemployment_pct.toFixed(1)}%, 
              ${uGap > 0 ? (uGap.toFixed(1) + 'pp above') : 'at/below'} the natural rate (NAIRU = ${MODEL.u_star}%).
            </div>
            <div class="chain-step">
              <span class="chain-arrow">↓</span>
              <strong>Wage pressure:</strong> ${uGap > 0 ? 'High unemployment reduces worker bargaining power' : 'Tight labour markets push wages up'}, 
              affecting production costs across the economy.
            </div>
            <div class="chain-step">
              <span class="chain-arrow">↓</span>
              <strong>Consumer spending:</strong> ${change === 'risen' ? 'Job insecurity and lost incomes reduce household spending' : 'Lower unemployment boosts consumer confidence and spending power'}.
            </div>
            <div class="chain-step">
              <span class="chain-arrow">↓</span>
              <strong>Business confidence:</strong> Retail sector shows ${(state.shops_closed_rate * 100).toFixed(0)}% closure rate, 
              reflecting weak demand conditions.
            </div>
          </div>
        `;
        
        evaluation = `
          <div class="evaluation-point">
            <strong>Phillips curve relationship:</strong> Current unemployment ${uGap > 1 ? 'well above NAIRU suggests disinflationary pressure' : uGap < -0.5 ? 'below NAIRU may fuel inflation' : 'near natural rate indicates stable inflation'}.
            <a href="${EDU_REFS.phillips.url}" class="ref-link" target="_blank">${EDU_REFS.phillips.title}</a>
          </div>
          
          <div class="evaluation-point">
            <strong>Hysteresis effects:</strong> ${change === 'risen' ? 'Prolonged unemployment can permanently damage workers\' skills and job prospects' : 'Rapid job growth may draw discouraged workers back into the labour force'}.
          </div>
          
          <div class="impact-analysis">
            <div class="winners">
              <div class="impact-title">Winners:</div>
              ${change === 'fallen' ? '• Workers gain bargaining power<br>• Retail and service sectors<br>• Government (higher tax receipts)' : '• Employers face lower wage pressure<br>• Consumers benefit from lower prices'}
            </div>
            <div class="losers">
              <div class="impact-title">Losers:</div>
              ${change === 'risen' ? '• Unemployed workers lose income<br>• Retail businesses lose customers<br>• Government (higher benefit costs)' : '• May lead to skills shortages<br>• Inflation pressures build'}
            </div>
          </div>
        `;
        
      } else if (lastControl === 'inflation') {
        const trend = cur.inflation_pct > prev.inflation_pct ? 'risen' : 'fallen';
        const targetGap = cur.inflation_pct - MODEL.pi_target;
        
        analysis = `
          <div class="analysis-chain">
            <div class="chain-step">
              <strong>Price level change:</strong> Inflation has ${trend} to ${cur.inflation_pct.toFixed(1)}%, 
              ${Math.abs(targetGap).toFixed(1)}pp ${targetGap > 0 ? 'above' : 'below'} the ${MODEL.pi_target}% target.
            </div>
            <div class="chain-step">
              <span class="chain-arrow">↓</span>
              <strong>Real income effects:</strong> ${trend === 'risen' ? 'Higher prices erode purchasing power, especially for fixed-income households' : 'Falling prices increase real incomes and spending power'}.
            </div>
            <div class="chain-step">
              <span class="chain-arrow">↓</span>
              <strong>Real interest rates:</strong> With nominal rates at ${cur.interest_rate_pct.toFixed(1)}%, 
              real rates are ${realRate.toFixed(1)}%, affecting investment and saving decisions.
            </div>
            <div class="chain-step">
              <span class="chain-arrow">↓</span>
              <strong>Business responses:</strong> Retailers show ${(state.price_pressure * 100).toFixed(0)}% price pressure, 
              with some posting "price rise" signs in shop windows.
            </div>
          </div>
        `;
        
        evaluation = `
          <div class="evaluation-point">
            <strong>Expectations matter:</strong> If inflation becomes entrenched in expectations, it becomes self-fulfilling as workers demand higher wages and firms raise prices pre-emptively.
          </div>
          
          <div class="evaluation-point">
            <strong>Sectoral impacts:</strong> ${trend === 'risen' ? 'Essential goods hit low-income households hardest' : 'Deflation risks include delayed purchases and debt burdens'}.
          </div>
          
          <div class="time-horizon">
            <div class="short-term">
              <strong>Short-term:</strong> Consumer behaviour adjusts quickly. ${trend === 'risen' ? 'Shoppers reduce discretionary spending' : 'May delay purchases expecting lower prices'}.
            </div>
            <div class="long-term">
              <strong>Long-term:</strong> ${Math.abs(targetGap) > 2 ? 'Significant deviation from target may require policy response' : 'Close to target supports stable economic planning'}.
            </div>
          </div>
        `;
        
      } else {
        // Default analysis for other controls or initial state
        analysis = `
          <div class="analysis-chain">
            <div class="chain-step">
              <strong>Current economic position:</strong> GDP growth at ${cur.gdp_growth_pct.toFixed(1)}% vs potential ${MODEL.potential_growth}% creates ${gap > 0 ? 'expansionary' : gap < -0.5 ? 'recessionary' : 'neutral'} conditions.
            </div>
            <div class="chain-step">
              <span class="chain-arrow">↓</span>
              <strong>Labour market:</strong> Unemployment at ${cur.unemployment_pct.toFixed(1)}% vs natural rate ${MODEL.u_star}% affects wage and price pressures through <span class="econ-concept" title="Non-accelerating inflation rate of unemployment">NAIRU</span> relationship.
            </div>
            <div class="chain-step">
              <span class="chain-arrow">↓</span>
              <strong>Monetary conditions:</strong> Real interest rate of ${realRate.toFixed(1)}% influences investment, consumption, and exchange rates.
            </div>
            <div class="chain-step">
              <span class="chain-arrow">↓</span>
              <strong>Village outcomes:</strong> These macro conditions translate to ${(state.citizen_activity * 100).toFixed(0)}% activity levels and ${(state.shops_closed_rate * 100).toFixed(0)}% retail closures.
            </div>
          </div>
        `;
        
        evaluation = `
          <div class="evaluation-point">
            <strong>Economic relationships:</strong> Multiple economic laws interact: <span class="econ-concept">Okun's law</span> (GDP-unemployment), 
            <span class="econ-concept">Phillips curve</span> (unemployment-inflation), and <span class="econ-concept">Taylor rule</span> (policy response).
          </div>
          
          <div class="evaluation-point">
            <strong>Policy trade-offs:</strong> Achieving full employment, price stability, and growth simultaneously is challenging - policymakers face difficult choices.
          </div>
        `;
      }
      
      return { analysis, evaluation };
    }

    // ===== Auto-links functions (same as before) =====
    function controlKeyFromId(id){
      return {
        gdpGrowth:'gdp_growth_pct',
        unemployment:'unemployment_pct',
        inflation:'inflation_pct',
        interestRate:'interest_rate_pct',
        commodityIndex:'commodity_index',
        exports:'exports_pct_growth',
        shock:'shock'
      }[id] || null;
    }

    let lastAction = {kind:'init', control:null, old:null, value:null};

    function applyAutoLinks(prev, cur){
      const draft = {...cur};
      const gapPrev = prev.gdp_growth_pct - MODEL.potential_growth;
      const gapNow  = draft.gdp_growth_pct - MODEL.potential_growth;
      const dGap    = gapNow - gapPrev;

      if(SETTINGS.autoOkun && Math.abs(dGap) > 0.0001){
        const du = COEFF.okun * dGap;
        draft.unemployment_pct = clamp(2, 15, draft.unemployment_pct + du);
      }

      if(SETTINGS.autoPhillips){
        const pi_star = MODEL.pi_target + MODEL.phillips_kappa * gapNow;
        draft.inflation_pct = clamp(0, 12, lerp(draft.inflation_pct, pi_star, COEFF.phillipsBlend));
      }

      if(SETTINGS.autoOil){
        const over = Math.max(0, draft.commodity_index - MODEL.commodity_base);
        const pi_add = (over/10) * (COEFF.oilPiPer10pts/10);
        draft.inflation_pct = clamp(0, 12, draft.inflation_pct + pi_add);
      }

      if(SETTINGS.autoTaylor){
        const pi_gap = draft.inflation_pct - MODEL.pi_target;
        const i_taylor = COEFF.taylor_rstar + draft.inflation_pct
                       + COEFF.taylor_phi_pi * pi_gap
                       + COEFF.taylor_phi_y * gapNow;
        draft.interest_rate_pct = clamp(0, 10, i_taylor);
      }

      if(SETTINGS.autoStab && gapNow < 0){
        const cushion = -gapNow * COEFF.stabiliserShare;
        draft.gdp_growth_pct = clamp(-5, 8, draft.gdp_growth_pct + cushion);
      }

      return draft;
    }

    // ===== Game state & rendering (same as before, abbreviated for space) =====
    let currentEconomy = {...DEFAULT_ECONOMY};
    let computedState = {};
    let oldComputedState = {};
    let tweenProgress = 1, isTransitioning = false, animationFrame = 0;

    let citizens = [];
    function initializeCitizens(){
      citizens.length = 0;
      for(let i=0;i<28;i++){
        citizens.push({
          x: Math.random()*canvas.width, y: Math.random()*canvas.height,
          targetX: Math.random()*canvas.width, targetY: Math.random()*canvas.height,
          speed: 0.6 + Math.random()*0.9, frame: Math.floor(Math.random()*3), frameTimer: 0
        });
      }
    }
    function drawCitizen(c,state){
      const sp = c.speed * state.citizen_activity;
      const dx = c.targetX - c.x, dy = c.targetY - c.y, dist = Math.hypot(dx,dy);
      if(dist > sp){ c.x += (dx/dist)*sp; c.y += (dy/dist)*sp; }
      else{ c.x = c.targetX; c.y = c.targetY; c.targetX = Math.random()*canvas.width; c.targetY = Math.random()*canvas.height; }
      c.frameTimer += sp; if(c.frameTimer > 10){ c.frame=(c.frame+1)%3; c.frameTimer=0; }
      ctx.fillStyle = ['#FF69B4','#87CEEB','#98FB98'][c.frame];
      ctx.beginPath(); ctx.arc(Math.round(c.x), Math.round(c.y), 3, 0, Math.PI*2); ctx.fill();
    }

    const roadAt = (tx,ty) => ty>=0 && ty<VILLAGE_HEIGHT && tx>=0 && tx<VILLAGE_WIDTH && villageLayout[ty][tx]==='road';
    function randomRoadTile(){
      let tx,ty; do{ tx = (Math.random()*VILLAGE_WIDTH)|0; ty=(Math.random()*VILLAGE_HEIGHT)|0; } while(!roadAt(tx,ty));
      return {tx,ty};
    }

    let vehicles = [];
    function initializeVehicles(){
      vehicles.length = 0;
      for(let i=0;i<7;i++){
        const {tx,ty} = randomRoadTile();
        vehicles.push({ tx,ty, x: tx*TILE_SIZE + TILE_SIZE/2, y: ty*TILE_SIZE + TILE_SIZE/2,
          speed: 1 + Math.random()*1.8, type: Math.random()>0.5?'truck':'car', dir:null });
      }
    }
    function nextRoadStep(v){
      const choices = [{dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:1},{dx:0,dy:-1}].filter(d=>roadAt(v.tx+d.dx, v.ty+d.dy));
      v.dir = choices.length ? choices[(Math.random()*choices.length)|0] : {dx:0,dy:0};
    }
    function drawVehicle(v,state){
      const sp = v.speed * (state.vehicle_activity || 1);
      if(!v.dir) nextRoadStep(v);
      const targetX = (v.tx+v.dir.dx)*TILE_SIZE + TILE_SIZE/2, targetY = (v.ty+v.dir.dy)*TILE_SIZE + TILE_SIZE/2;
      const dx = targetX - v.x, dy = targetY - v.y, dist = Math.hypot(dx,dy);
      if(dist <= sp){ v.tx += v.dir.dx; v.ty += v.dir.dy; v.x = targetX; v.y = targetY; nextRoadStep(v); }
      else{ v.x += (dx/dist)*sp; v.y += (dy/dist)*sp; }
      ctx.fillStyle = v.type==='truck' ? '#8B4513' : '#4169E1';
      ctx.fillRect(Math.round(v.x-6), Math.round(v.y-3), 12, 6);
    }

    function drawTile(x,y,type,state){
      const px = x*TILE_SIZE, py = y*TILE_SIZE;
      switch(type){
        case 'road': ctx.fillStyle='#696969'; ctx.fillRect(px,py,TILE_SIZE,TILE_SIZE); break;
        case 'farm': 
          const prod = state.farm_productivity, g = Math.floor(50 + prod*150);
          ctx.fillStyle = `rgb(34,${g},34)`; ctx.fillRect(px,py,TILE_SIZE,TILE_SIZE); break;
        case 'industry': 
          ctx.fillStyle='#8B4513'; ctx.fillRect(px,py,TILE_SIZE,TILE_SIZE);
          ctx.fillStyle='#A0A0A0'; ctx.fillRect(px+5, py+5, TILE_SIZE-10, TILE_SIZE-10); break;
        case 'retail':
          const key = `${x},${y}`, rs = retailState.get(key) || {closed:false, priceTag:false};
          ctx.fillStyle = rs.closed ? '#654321' : '#228B22'; ctx.fillRect(px,py,TILE_SIZE,TILE_SIZE); break;
        case 'housing': 
          ctx.fillStyle='#DEB887'; ctx.fillRect(px,py,TILE_SIZE,TILE_SIZE); break;
        case 'square': 
          ctx.fillStyle='#98FB98'; ctx.fillRect(px,py,TILE_SIZE,TILE_SIZE); break;
        default: ctx.fillStyle='#90EE90'; ctx.fillRect(px,py,TILE_SIZE,TILE_SIZE);
      }
    }

    function recomputeRetailState(state){
      retailState.clear();
      for(const {x,y} of retailTiles){
        const closed = Math.random() < state.shops_closed_rate;
        const priceTag = !closed && state.price_pressure>0.3 && Math.random() < state.price_pressure;
        retailState.set(`${x},${y}`, {closed, priceTag});
      }
    }

    function getCurrentState(){
      if(!isTransitioning || tweenProgress>=1) return computedState;
      const cur = {};
      for(const k in computedState){
        if(typeof computedState[k]==='number' && typeof oldComputedState[k]==='number'){
          cur[k] = lerp(oldComputedState[k], computedState[k], tweenProgress);
        }else{ cur[k] = computedState[k]; }
      }
      return cur;
    }

    function render(){
      ctx.clearRect(0,0,canvas.width, canvas.height);
      const s = getCurrentState();
      for(let y=0;y<VILLAGE_HEIGHT;y++) for(let x=0;x<VILLAGE_WIDTH;x++) drawTile(x,y,villageLayout[y][x], s);
      const nC = Math.min(citizens.length, Math.floor(citizens.length * s.citizen_activity));
      for(let i=0;i<nC;i++) drawCitizen(citizens[i], s);
      const nV = Math.min(vehicles.length, Math.floor(vehicles.length * (s.vehicle_activity||1)));
      for(let i=0;i<nV;i++) drawVehicle(vehicles[i], s);
    }

    // ===== UI Elements =====
    const els = {
      gdp: document.getElementById('gdpGrowth'), u: document.getElementById('unemployment'),
      pi: document.getElementById('inflation'), i: document.getElementById('interestRate'),
      com: document.getElementById('commodityIndex'), ex: document.getElementById('exports'),
      shock: document.getElementById('shock'), gdpV: document.getElementById('gdpValue'),
      uV: document.getElementById('unemploymentValue'), piV: document.getElementById('inflationValue'),
      iV: document.getElementById('interestRateValue'), comV: document.getElementById('commodityValue'),
      exV: document.getElementById('exportsValue'), scenarioTip: document.getElementById('scenarioTip'),
      narrative: document.getElementById('narrativeBanner'), statusSummary: document.getElementById('statusSummary'),
      quickStats: document.getElementById('quickStats'), debugBtn: document.getElementById('debugBtn'),
      debugContent: document.getElementById('debugContent'), debugStats: document.getElementById('debugStats'),
      glossaryBtn: document.getElementById('glossaryBtn'), glossary: document.getElementById('glossary'),
      presetBoom: document.getElementById('presetBoom'), presetRecession: document.getElementById('presetRecession'),
      presetStagflation: document.getElementById('presetStagflation'), btnReset: document.getElementById('btnReset'),
      analysisContent: document.getElementById('analysisContent'), evaluationContent: document.getElementById('evaluationContent'),
      evaluationSection: document.getElementById('evaluationSection'), toggleEvaluation: document.getElementById('toggleEvaluation'),
      autoOkun: document.getElementById('autoOkun'), autoPhillips: document.getElementById('autoPhillips'),
      autoTaylor: document.getElementById('autoTaylor'), autoOil: document.getElementById('autoOil'),
      autoStab: document.getElementById('autoStab')
    };

    function updateSliderDisplays(){
      els.gdpV.textContent = currentEconomy.gdp_growth_pct.toFixed(1)+'%';
      els.uV.textContent = currentEconomy.unemployment_pct.toFixed(1)+'%';
      els.piV.textContent = currentEconomy.inflation_pct.toFixed(1)+'%';
      els.iV.textContent = currentEconomy.interest_rate_pct.toFixed(1)+'%';
      els.comV.textContent = String(currentEconomy.commodity_index);
      els.exV.textContent = currentEconomy.exports_pct_growth.toFixed(1)+'%';
    }

    function updateEconomy(){
      oldComputedState = {...computedState};
      computedState = computeEconomicState(currentEconomy);
      recomputeRetailState(computedState);
      tweenProgress = 0; isTransitioning = true;
      updateNarrative(); updateDebugPanel();
    }

    function updateNarrative(){
      const s = computedState;
      let msg = 'Steady as she goes.';
      if(s.citizen_activity>1.1) msg = `Boom time! Factory near ${(s.factory_capacity*100|0)}% capacity.`;
      else if(s.citizen_activity<0.6) msg = `Tough times. ${(s.shops_closed_rate*100|0)}% shops shuttered.`;
      els.narrative.textContent = msg;
      els.statusSummary.textContent = s.citizen_activity>1.0 ? 'Booming' : (s.citizen_activity<0.6 ? 'Struggling' : 'Stable');
      els.quickStats.textContent = `Capacity: ${(s.factory_capacity*100|0)}% | Closures: ${(s.shops_closed_rate*100|0)}% | Activity: ${(s.citizen_activity*100|0)}%`;
    }

    function updateDebugPanel(){
      const s = computedState;
      const lines = [
        `shops_closed_rate: ${s.shops_closed_rate.toFixed(2)}`,
        `factory_capacity: ${s.factory_capacity.toFixed(2)}`,
        `citizen_activity: ${s.citizen_activity.toFixed(2)}`
      ];
      els.debugStats.innerHTML = lines.join('<br>');
    }

    function updateReasoningUI(prev, cur, state){
      const reasoning = buildEconomicAnalysis(prev, cur, state);
      els.analysisContent.innerHTML = reasoning.analysis;
      els.evaluationContent.innerHTML = reasoning.evaluation;
    }

    // ===== Event Handlers =====
    els.toggleEvaluation.addEventListener('click', ()=>{
      const isOpen = els.evaluationSection.style.display !== 'none';
      els.evaluationSection.style.display = isOpen ? 'none' : 'block';
      els.toggleEvaluation.textContent = isOpen ? 'Show Evaluation' : 'Hide Evaluation';
    });

    [els.autoOkun, els.autoPhillips, els.autoTaylor, els.autoOil, els.autoStab].forEach((box)=>{
      box.addEventListener('change', ()=>{
        SETTINGS.autoOkun = els.autoOkun.checked; SETTINGS.autoPhillips = els.autoPhillips.checked;
        SETTINGS.autoTaylor = els.autoTaylor.checked; SETTINGS.autoOil = els.autoOil.checked;
        SETTINGS.autoStab = els.autoStab.checked;
        const prev = {...currentEconomy}, withLinks = applyAutoLinks(prev, {...currentEconomy});
        currentEconomy = withLinks;
        els.gdp.value = currentEconomy.gdp_growth_pct; els.u.value = currentEconomy.unemployment_pct;
        els.pi.value = currentEconomy.inflation_pct; els.i.value = currentEconomy.interest_rate_pct;
        updateEconomy(); updateSliderDisplays(); updateReasoningUI(prev, currentEconomy, computedState);
      });
    });

    function updateEconomyFromUI(ev){
      const prev = {...currentEconomy};
      if(ev && ev.target){ lastAction.control = ev.target.id; }
      currentEconomy.gdp_growth_pct = parseFloat(els.gdp.value);
      currentEconomy.unemployment_pct = parseFloat(els.u.value);
      currentEconomy.inflation_pct = parseFloat(els.pi.value);
      currentEconomy.interest_rate_pct = parseFloat(els.i.value);
      currentEconomy.commodity_index = parseInt(els.com.value,10);
      currentEconomy.exports_pct_growth = parseFloat(els.ex.value);
      currentEconomy.shock = els.shock.value || null;
      const linked = applyAutoLinks(prev, currentEconomy);
      currentEconomy = linked;
      els.gdp.value = currentEconomy.gdp_growth_pct; els.u.value = currentEconomy.unemployment_pct;
      els.pi.value = currentEconomy.inflation_pct; els.i.value = currentEconomy.interest_rate_pct;
      updateEconomy(); updateSliderDisplays(); updateReasoningUI(prev, currentEconomy, computedState);
    }

    [els.gdp,els.u,els.pi,els.i,els.com,els.ex].forEach(el=>{ el.addEventListener('input', updateEconomyFromUI); });
    els.shock.addEventListener('change', updateEconomyFromUI);

    function applyPreset(name){
      const p = PRESETS[name]; if(!p) return;
      currentEconomy = {...p};
      els.gdp.value = p.gdp_growth_pct; els.u.value = p.unemployment_pct; els.pi.value = p.inflation_pct;
      els.i.value = p.interest_rate_pct; els.com.value = p.commodity_index; els.ex.value = p.exports_pct_growth;
      els.shock.value = p.shock || ''; els.scenarioTip.textContent = p.tip;
      updateEconomy(); updateSliderDisplays(); updateReasoningUI(currentEconomy, currentEconomy, computedState);
    }

    function resetEconomy(){
      currentEconomy = {...DEFAULT_ECONOMY};
      els.gdp.value = DEFAULT_ECONOMY.gdp_growth_pct; els.u.value = DEFAULT_ECONOMY.unemployment_pct;
      els.pi.value = DEFAULT_ECONOMY.inflation_pct; els.i.value = DEFAULT_ECONOMY.interest_rate_pct;
      els.com.value = DEFAULT_ECONOMY.commodity_index; els.ex.value = DEFAULT_ECONOMY.exports_pct_growth;
      els.shock.value = ''; els.scenarioTip.textContent = 'Select a preset to see different economic scenarios play out!';
      updateEconomy(); updateSliderDisplays(); updateReasoningUI(currentEconomy, currentEconomy, computedState);
    }

    els.presetBoom.addEventListener('click', ()=>applyPreset('boom'));
    els.presetRecession.addEventListener('click', ()=>applyPreset('recession'));
    els.presetStagflation.addEventListener('click', ()=>applyPreset('stagflation'));
    els.btnReset.addEventListener('click', resetEconomy);

    // Tooltip system
    const tooltip = document.getElementById('tooltip');
    const hoveredTile = {x:-1,y:-1};
    function showTooltip(x,y,html){ 
      tooltip.innerHTML = html; 
      tooltip.style.left=(x+10)+'px'; 
      tooltip.style.top=(y+10)+'px'; 
      tooltip.classList.add('visible'); 
    }
    function hideTooltip(){ tooltip.classList.remove('visible'); }
    
    function tileTooltip(type,state){
      const s=state, e=currentEconomy;
      if(type==='farm') return `<strong>Agriculture</strong><br>Productivity: ${(s.farm_productivity*100).toFixed(0)}%`;
      if(type==='industry') return `<strong>Manufacturing</strong><br>Capacity: ${(s.factory_capacity*100).toFixed(0)}%`;
      if(type==='retail') return `<strong>Retail & Services</strong><br>Shops Closed: ${(s.shops_closed_rate*100).toFixed(0)}%`;
      if(type==='housing') return `<strong>Housing</strong><br>Activity: ${(s.housing_activity*100).toFixed(0)}%`;
      if(type==='square') return `<strong>Town Square</strong><br>Economic Mood: ${s.citizen_activity>1.0?'Optimistic':'Cautious'}`;
      return `<strong>${type}</strong>`;
    }

    canvas.addEventListener('mousemove', (ev)=>{
      const r = canvas.getBoundingClientRect();
      const cx = ev.clientX - r.left, cy = ev.clientY - r.top;
      const tx = Math.floor(cx / TILE_SIZE), ty = Math.floor(cy / TILE_SIZE);
      hoveredTile.x = tx; hoveredTile.y = ty;
      if(tx>=0 && tx<VILLAGE_WIDTH && ty>=0 && ty<VILLAGE_HEIGHT){
        const t = villageLayout[ty][tx];
        if(t!=='road'){ showTooltip(ev.clientX, ev.clientY, tileTooltip(t, getCurrentState())); }
        else hideTooltip();
      }else hideTooltip();
    });
    canvas.addEventListener('mouseleave', ()=>{ hoveredTile.x=-1; hoveredTile.y=-1; hideTooltip(); });

    // Toggle panels
    els.debugBtn.addEventListener('click', ()=>{ els.debugContent.classList.toggle('open'); });
    els.glossaryBtn.addEventListener('click', ()=>{ els.glossary.classList.toggle('open'); });

    // Animation loop
    function animate(){
      animationFrame++;
      if(isTransitioning){
        tweenProgress += 0.03;
        if(tweenProgress>=1){ tweenProgress=1; isTransitioning=false; }
      }
      render();
      requestAnimationFrame(animate);
    }

    // Initialize
    function init(){
      resizeCanvas();
      initializeCitizens();
      initializeVehicles();
      computedState = computeEconomicState(currentEconomy);
      recomputeRetailState(computedState);
      updateSliderDisplays();
      updateNarrative();
      updateDebugPanel();
      updateReasoningUI(currentEconomy, currentEconomy, computedState);
      requestAnimationFrame(animate);
    }

    // Start the simulation
    init();
  </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EconoVille – Macroeconomic Village Simulator</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg,#87CEEB,#98FB98);
      color:#333; overflow:auto;
    }
    .container{display:flex; height:100vh}
    .game-area{flex:1; position:relative; min-width:0}
    #gameCanvas{
      border:2px solid #8B4513; background:#90EE90; display:block;
      width:100%; height:auto; max-width:100%;
      image-rendering: pixelated; image-rendering: crisp-edges;
      cursor: crosshair;
    }
    .narrative-banner{
      position:absolute; top:10px; left:10px; z-index:10;
      background:rgba(255,255,255,0.92); border:2px solid #4169E1;
      border-radius:8px; padding:10px 14px; max-width:420px;
      font-weight:bold; color:#2E8B57;
    }
    .legend{
      position:absolute; bottom:10px; left:10px; z-index:10;
      background:rgba(255,255,255,0.9); border:1px solid #DDD;
      border-radius:6px; padding:10px; font-size:0.85em;
    }
    .legend-item{display:flex; align-items:center; gap:8px; margin:4px 0}
    .legend-icon{width:16px; height:16px; border:1px solid #666}
    .controls{
      width:380px; background:rgba(255,255,255,0.96);
      padding:18px 20px; border-left:2px solid #8B4513; overflow-y:auto;
    }
    .preset-buttons{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:14px}
    button{
      padding:8px 12px; border:2px solid #4169E1; border-radius:6px;
      background:#87CEEB; color:#fff; font-weight:bold; cursor:pointer;
      transition:transform .15s, background .15s;
    }
    button:hover{background:#4169E1; transform:translateY(-1px)}
    .scenario-tip{
      background:#FFF8DC; border:1px solid #DDA0DD; border-radius:6px;
      padding:10px; margin:8px 0 12px; color:#8B4513; font-size:0.9em;
    }
    .status-row{
      background:#E6F3FF; border-radius:6px; padding:8px; font-size:0.85em; margin:10px 0;
    }
    .control-group{margin:12px 0}
    .control-group label{display:block; font-weight:bold; color:#2E8B57; margin-bottom:6px}
    .slider-container{display:flex; align-items:center; gap:10px}
    input[type="range"]{flex:1; height:6px; border-radius:3px; background:#ddd; outline:none}
    .value-display{min-width:56px; text-align:right; font-weight:bold; color:#4169E1}
    .debug-panel{margin-top:14px; background:#F0F8FF; border:1px solid #B0C4DE; border-radius:6px}
    .debug-toggle{width:100%; background:#B0C4DE; border:none; padding:8px; font-weight:bold; cursor:pointer}
    .debug-content{display:none; padding:10px; font-family:monospace; font-size:0.85em}
    .debug-content.open{display:block}
    .glossary{display:none; background:#F5F5F5; border:1px solid #DDD; border-radius:6px; padding:10px; margin-top:10px; font-size:0.88em}
    .glossary.open{display:block}
    .glossary-term{font-weight:bold; color:#4169E1}
    .tooltip{
      position:absolute; pointer-events:none; z-index:100;
      max-width:260px; background:rgba(0,0,0,0.92); color:#fff;
      padding:8px 10px; border-radius:6px; font-size:0.9em; opacity:0; transition:opacity .15s;
    }
    .tooltip.visible{opacity:1}

    /* --- Enhanced Reasoning Panel --- */
    .reasoning-panel{
      background:#fff; border:1px solid #B0C4DE; border-radius:8px;
      padding:14px; margin:12px 0; font-size:0.9em; line-height:1.4;
    }
    .reasoning-header{
      display:flex; align-items:center; justify-content:space-between; 
      margin-bottom:12px; border-bottom:1px solid #E0E8FF; padding-bottom:8px;
    }
    .reasoning-title{font-weight:bold; color:#2E5B8A; font-size:1.05em}
    
    /* Analysis Section */
    .analysis-section{
      margin-bottom:12px;
    }
    .section-header{
      font-weight:bold; color:#1B4F72; margin-bottom:6px;
      display:flex; align-items:center; gap:6px;
    }
    .analysis-chain{
      background:#F8FAFF; border-left:3px solid #4169E1;
      padding:8px 12px; margin:8px 0; border-radius:0 6px 6px 0;
    }
    .chain-step{
      margin:4px 0; color:#2C5282;
    }
    .chain-arrow{color:#4169E1; font-weight:bold; margin:0 6px}
    
    /* Evaluation Section */
    .evaluation-section{
      margin-top:12px; border-top:1px solid #E8F0FE; padding-top:10px;
    }
    .evaluation-toggle{
      background:#E8F4FD; border:1px solid #B8D9F0; border-radius:4px;
      padding:6px 10px; cursor:pointer; font-size:0.9em; margin-bottom:8px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .evaluation-toggle:hover{background:#D1E9F8}
    .evaluation-content{
      display:none; background:#F7FBFF; border-radius:6px;
      padding:10px; border-left:3px solid #F39C12; margin-top:8px;
    }
    .evaluation-content.open{display:block}
    .evaluation-point{margin:6px 0; padding-left:8px}
    
    /* Economics concepts highlighting */
    .econ-concept{
      background:#FFF3E0; padding:2px 6px; border-radius:3px;
      border-bottom:2px dotted #FF8C00; cursor:help; font-weight:500;
    }
    .econ-concept:hover{background:#FFE0B2}
    
    /* Reference links */
    .ref-link{
      color:#1565C0; text-decoration:none; font-size:0.85em;
      border:1px solid #E3F2FD; border-radius:3px; padding:1px 4px;
      margin:0 2px; display:inline-block;
    }
    .ref-link:hover{background:#E3F2FD; text-decoration:underline}
    
    /* Auto-links section */
    .autolinks{ display:grid; grid-template-columns: 1fr 1fr; gap:6px; margin:10px 0 6px }
    .autolinks label{ display:flex; gap:8px; align-items:center; font-size:0.86em }
    
    /* Winner/Loser analysis */
    .impact-analysis{
      display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:8px 0;
    }
    .winners, .losers{
      padding:8px; border-radius:4px; font-size:0.85em;
    }
    .winners{background:#E8F5E8; border-left:3px solid #4CAF50}
    .losers{background:#FFEBEE; border-left:3px solid #F44336}
    .impact-title{font-weight:bold; margin-bottom:4px}
    
    /* Time horizon indicators */
    .time-horizon{
      display:flex; gap:12px; margin:8px 0; font-size:0.85em;
    }
    .short-term, .long-term{
      flex:1; padding:6px 8px; border-radius:4px; text-align:center;
    }
    .short-term{background:#FFF3E0; border:1px solid #FFB74D}
    .long-term{background:#E8F5E8; border:1px solid #81C784}
  </style>
</head>
<body>
  <div class="container">
    <div class="game-area">
      <div class="narrative-banner" id="narrativeBanner">
        Welcome to EconoVille! Watch how the economy shapes daily life.
      </div>
      <canvas id="gameCanvas" width="800" height="600"></canvas>

      <div class="legend">
        <div class="legend-item"><div class="legend-icon" style="background:#228B22"></div><span>Open Shop</span></div>
        <div class="legend-item"><div class="legend-icon" style="background:#8B4513"></div><span>Closed Shop</span></div>
        <div class="legend-item"><div class="legend-icon" style="background:#B0B0B0"></div><span>Factory Smoke</span></div>
        <div class="legend-item"><div class="legend-icon" style="background:#32CD32"></div><span>Healthy Crops</span></div>
      </div>
    </div>

    <aside class="controls">
      <h2 style="text-align:center; color:#2E8B57; margin-bottom:12px">Economic Controls</h2>

      <div class="preset-buttons">
        <button id="presetBoom">Boom</button>
        <button id="presetRecession">Recession</button>
        <button id="presetStagflation">Stagflation</button>
        <button id="btnReset">Reset</button>
      </div>

      <div class="scenario-tip" id="scenarioTip">Select a preset to see different economic scenarios play out!</div>

      <div class="status-row">
        <div><strong>Status:</strong> <span id="statusSummary">Economy loading...</span></div>
        <div style="margin-top:4px"><span id="quickStats">Capacity: --% | Closures: --% | Activity: --%</span></div>
      </div>

      <!-- Auto-links (policy rules & stabilisers) -->
      <div class="control-group">
        <label>Auto-links (economic relationships)</label>
        <div class="autolinks">
          <label><input type="checkbox" id="autoOkun" checked/> Okun's Law</label>
          <label><input type="checkbox" id="autoPhillips" checked/> Phillips Curve</label>
          <label><input type="checkbox" id="autoTaylor" checked/> Taylor Rule</label>
          <label><input type="checkbox" id="autoOil" checked/> Oil Pass-through</label>
          <label><input type="checkbox" id="autoStab" checked/> Auto Stabilisers</label>
        </div>
        <div style="font-size:0.8em;color:#666">Toggle to see individual relationships vs. coupled system effects</div>
      </div>

      <!-- Enhanced Reasoning Panel -->
      <div class="reasoning-panel">
        <div class="reasoning-header">
          <div class="reasoning-title">Economic Analysis</div>
          <button id="toggleEvaluation" type="button" style="font-size:0.8em; padding:4px 8px; background:#F0F8FF">
            Show Evaluation
          </button>
        </div>
        
        <div class="analysis-section">
          <div class="section-header">
            📊 Analysis: What's happening?
          </div>
          <div id="analysisContent">
            <!-- Dynamic content will be inserted here -->
          </div>
        </div>

        <div class="evaluation-section" id="evaluationSection" style="display:none">
          <div class="section-header">
            ⚖️ Evaluation: Strengths, limitations & trade-offs
          </div>
          <div id="evaluationContent">
            <!-- Dynamic content will be inserted here -->
          </div>
        </div>
      </div>

      <div class="control-group">
        <label for="gdpGrowth">GDP Growth (%)</label>
        <div class="slider-container">
          <input type="range" id="gdpGrowth" min="-5" max="8" step="0.1" value="1.8"/>
          <span class="value-display" id="gdpValue">1.8%</span>
        </div>
      </div>

      <div class="control-group">
        <label for="unemployment">Unemployment (%)</label>
        <div class="slider-container">
          <input type="range" id="unemployment" min="2" max="15" step="0.1" value="5.2"/>
          <span class="value-display" id="unemploymentValue">5.2%</span>
        </div>
      </div>

      <div class="control-group">
        <label for="inflation">Inflation (%)</label>
        <div class="slider-container">
          <input type="range" id="inflation" min="0" max="12" step="0.1" value="3.0"/>
          <span class="value-display" id="inflationValue">3.0%</span>
        </div>
      </div>

      <div class="control-group">
        <label for="interestRate">Interest Rate (%)</label>
        <div class="slider-container">
          <input type="range" id="interestRate" min="0" max="10" step="0.1" value="4.0"/>
          <span class="value-display" id="interestRateValue">4.0%</span>
        </div>
      </div>

      <div class="control-group">
        <label for="commodityIndex">Commodity Index</label>
        <div class="slider-container">
          <input type="range" id="commodityIndex" min="80" max="200" step="1" value="120"/>
          <span class="value-display" id="commodityValue">120</span>
        </div>
      </div>

      <div class="control-group">
        <label for="exports">Exports Growth (%)</label>
        <div class="slider-container">
          <input type="range" id="exports" min="-5" max="10" step="0.1" value="0.5"/>
          <span class="value-display" id="exportsValue">0.5%</span>
        </div>
      </div>

      <div class="control-group">
        <label for="shock">Economic Shock</label>
        <select id="shock" style="width:100%; padding:6px">
          <option value="">None</option>
          <option value="oil_shock">Oil Crisis</option>
          <option value="supply_chain">Supply Chain Disruption</option>
          <option value="policy_tightening">Policy Tightening</option>
        </select>
      </div>

      <button id="glossaryBtn" class="glossary-toggle">Economic Terms</button>
      <div class="glossary" id="glossary">
        <div><span class="glossary-term">GDP Growth:</span> How fast total output is changing.</div>
        <div><span class="glossary-term">Unemployment:</span> Share of workers without jobs.</div>
        <div><span class="glossary-term">Inflation:</span> Rate at which prices rise.</div>
        <div><span class="glossary-term">Interest Rate:</span> Cost of borrowing.</div>
        <div><span class="glossary-term">Commodity Index:</span> Prices for inputs like oil or grain.</div>
        <div><span class="glossary-term">Exports:</span> Goods sold abroad.</div>
      </div>

      <div class="debug-panel">
        <button id="debugBtn" class="debug-toggle">Technical Debug</button>
        <div class="debug-content" id="debugContent"><div id="debugStats"></div></div>
      </div>
    </aside>
  </div>

  <div id="tooltip" class="tooltip"></div>

  <script>
    // ===== Utilities =====
    const clamp = (lo, hi, x) => Math.max(lo, Math.min(hi, x));
    const lerp = (a,b,t) => a + (b-a)*t;

    // ===== Academic-ish model params =====
    const MODEL = {
      potential_growth: 2.0,     
      u_star: 5.0,               
      pi_target: 2.0,            
      phillips_kappa: 0.30,      
      exports_scale: 5.0,        
      commodity_base: 120,       
      commodity_norm: 100,       

      closures_sens_u: 0.15,
      closures_sens_prices: 0.10,
      closures_offset_gap: 0.05,

      gap_sens_factory: 0.35,
      exports_sens_factory: 0.25,
      energy_sens_factory: 0.25,

      gap_sens_conf: 0.45,
      u_slack_sens_conf: 0.30,

      real_rate_housing_sens: 0.12,
      u_slack_sens_housing: 0.10
    };

    // ===== Defaults & presets =====
    const DEFAULT_ECONOMY = {
      gdp_growth_pct: 1.8,
      unemployment_pct: 5.2,
      inflation_pct: 3.0,
      interest_rate_pct: 4.0,
      commodity_index: 120,
      exports_pct_growth: 0.5,
      trend: { gdp: 'flat', inflation: 'down' },
      shock: null
    };

    const PRESETS = {
      boom: {
        gdp_growth_pct: 4.5, unemployment_pct: 3.8, inflation_pct: 2.1,
        interest_rate_pct: 2.5, commodity_index: 140, exports_pct_growth: 6.2,
        trend: { gdp:'up', inflation:'flat' }, shock: null,
        tip: "Boom time! Low unemployment and strong growth create a bustling economy."
      },
      recession: {
        gdp_growth_pct: -2.1, unemployment_pct: 9.8, inflation_pct: 1.2,
        interest_rate_pct: 0.5, commodity_index: 95, exports_pct_growth: -3.4,
        trend: { gdp:'down', inflation:'down' }, shock: null,
        tip: "Economic downturn: job losses and business closures across the village."
      },
      stagflation: {
        gdp_growth_pct: 0.2, unemployment_pct: 8.1, inflation_pct: 7.8,
        interest_rate_pct: 6.5, commodity_index: 160, exports_pct_growth: -1.2,
        trend: { gdp:'flat', inflation:'up' }, shock: 'oil_shock',
        tip: "Stagflation: weak growth + high inflation squeezes everyone."
      }
    };

    // ===== Educational References =====
    const EDU_REFS = {
      okun: {
        title: "Okun's Law Explained",
        url: "https://www.economicshelp.org/blog/glossary/okuns-law/",
        description: "Relationship between unemployment and GDP growth"
      },
      phillips: {
        title: "Phillips Curve Analysis", 
        url: "https://www.economicshelp.org/macroeconomics/unemployment/phillips-curve/",
        description: "Trade-off between unemployment and inflation"
      },
      taylor: {
        title: "Taylor Rule Guide",
        url: "https://www.economicshelp.org/blog/glossary/taylor-rule/", 
        description: "How central banks set interest rates"
      },
      multiplier: {
        title: "Multiplier Effect",
        url: "https://www.economicshelp.org/macroeconomics/fiscal-policy/multiplier-effect/",
        description: "How initial spending creates bigger economic changes"
      },
      stabilisers: {
        title: "Automatic Stabilisers",
        url: "https://www.tutor2u.net/economics/reference/automatic-fiscal-stabilisers",
        description: "How government spending and taxes respond to economic cycles"
      }
    };

    // ===== Auto-link settings =====
    const SETTINGS = {
      autoOkun: true,        
      autoPhillips: true,    
      autoTaylor: true,      
      autoOil: true,         
      autoStab: true         
    };

    const COEFF = {
      okun: -0.5,            
      phillipsBlend: 0.35,   
      oilPiPer10pts: 0.12,   
      taylor_rstar: 0.8,     
      taylor_phi_pi: 0.5,
      taylor_phi_y: 0.5,
      stabiliserShare: 0.30  
    };

    // ===== Canvas setup (same as before) =====
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const VILLAGE_WIDTH = 20, VILLAGE_HEIGHT = 15;
    let TILE_SIZE = 40;

    function resizeCanvas(){
      const sidebarWidth = 380;
      const w = Math.max(520, window.innerWidth - sidebarWidth - 24);
      const h = Math.max(420, window.innerHeight - 24);
      TILE_SIZE = Math.floor(Math.min(w / VILLAGE_WIDTH, h / VILLAGE_HEIGHT));
      canvas.width = TILE_SIZE * VILLAGE_WIDTH;
      canvas.height = TILE_SIZE * VILLAGE_HEIGHT;
    }
    window.addEventListener('resize', resizeCanvas);

    // ===== Village layout (same as before) =====
    const villageLayout = [
      ['farm','farm','farm','farm','road','housing','housing','housing','road','farm','farm','farm','farm','road','housing','housing','housing','housing','housing','housing'],
      ['farm','farm','farm','farm','road','housing','housing','housing','road','farm','farm','farm','farm','road','housing','housing','housing','housing','housing','housing'],
      ['farm','farm','farm','farm','road','housing','housing','housing','road','farm','farm','farm','farm','road','housing','housing','housing','housing','housing','housing'],
      ['road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road'],
      ['industry','industry','industry','road','retail','retail','retail','retail','road','square','square','square','road','retail','retail','retail','retail','industry','industry','industry'],
      ['industry','industry','industry','road','retail','retail','retail','retail','road','square','square','square','road','retail','retail','retail','retail','industry','industry','industry'],
      ['industry','industry','industry','road','retail','retail','retail','retail','road','square','square','square','road','retail','retail','retail','retail','industry','industry','industry'],
      ['road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road'],
      ['housing','housing','housing','road','retail','retail','retail','retail','road','industry','industry','industry','road','farm','farm','farm','farm','farm','farm','farm'],
      ['housing','housing','housing','road','retail','retail','retail','retail','road','industry','industry','industry','road','farm','farm','farm','farm','farm','farm','farm'],
      ['housing','housing','housing','road','retail','retail','retail','retail','road','industry','industry','industry','road','farm','farm','farm','farm','farm','farm','farm'],
      ['road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road'],
      ['farm','farm','farm','farm','housing','housing','housing','housing','road','retail','retail','retail','road','industry','industry','industry','industry','industry','industry','industry'],
      ['farm','farm','farm','farm','housing','housing','housing','housing','road','retail','retail','retail','road','industry','industry','industry','industry','industry','industry','industry'],
      ['farm','farm','farm','farm','housing','housing','housing','housing','road','retail','retail','retail','road','industry','industry','industry','industry','industry','industry','industry']
    ];

    const retailTiles = [];
    for(let y=0;y<VILLAGE_HEIGHT;y++){
      for(let x=0;x<VILLAGE_WIDTH;x++){
        if(villageLayout[y][x]==='retail'){ retailTiles.push({x,y}); }
      }
    }
    const retailState = new Map();

    // ===== Economic computation (same as before) =====
    function computeEconomicState(e){
      const gap_raw = e.gdp_growth_pct - MODEL.potential_growth;       
      const gap_norm = gap_raw / 4.0;                                   
      const u_slack = Math.max(0, e.unemployment_pct - MODEL.u_star) / 5.0;

      const pi_expected = MODEL.pi_target + MODEL.phillips_kappa * gap_raw;
      const supply_shock = Math.max(0, e.inflation_pct - pi_expected);
      const price_pressure = clamp(0,1,(e.inflation_pct - 4) / 8);

      const r_real = e.interest_rate_pct - e.inflation_pct;
      const exports_n = e.exports_pct_growth / MODEL.exports_scale;
      const energy_shock = Math.max(0,(e.commodity_index - MODEL.commodity_base)/60);
      const agri_tailwind = (e.commodity_index - 100) / MODEL.commodity_norm;

      const shops_closed_rate = clamp(
        0, 0.85,
        MODEL.closures_sens_u * u_slack
        + MODEL.closures_sens_prices * clamp(0,1, supply_shock/6)
        - MODEL.closures_offset_gap * gap_norm
      );

      const factory_capacity = clamp(
        0.20, 1.00,
        0.60 + MODEL.gap_sens_factory*gap_norm + MODEL.exports_sens_factory*exports_n - MODEL.energy_sens_factory*energy_shock
      );

      const citizen_activity = clamp(
        0.30, 1.50,
        1.00 + MODEL.gap_sens_conf*gap_norm - MODEL.u_slack_sens_conf*u_slack
      );

      const farm_productivity = clamp(
        0.20, 1.00,
        0.50 + 0.40*agri_tailwind - 0.20*energy_shock + 0.20*exports_n
      );

      let housing_activity = clamp(
        0.20, 1.00,
        1.00 - MODEL.real_rate_housing_sens*Math.max(0,r_real) - MODEL.u_slack_sens_housing*u_slack + 0.08*gap_norm
      );

      let vehicle_activity = 1.0, warehouse_congestion = 0.0, shock_effect = e.shock || 'none';
      if(e.shock==='oil_shock'){ vehicle_activity *= 0.4; }
      if(e.shock==='supply_chain'){ warehouse_congestion = 1.0; }
      if(e.shock==='policy_tightening'){ housing_activity *= 0.6; }

      return {
        shops_closed_rate,
        factory_capacity,
        citizen_activity,
        farm_productivity,
        housing_activity,
        price_pressure: clamp(0,1, price_pressure),
        vehicle_activity,
        warehouse_congestion,
        shock_effect
      };
    }

    // ===== Enhanced Reasoning System =====
    function buildEconomicAnalysis(prev, cur, state) {
      const gap = cur.gdp_growth_pct - MODEL.potential_growth;
      const realRate = cur.interest_rate_pct - cur.inflation_pct;
      const lastControl = lastAction.control;
      
      let analysis = '';
      let evaluation = '';
      
      // Determine what changed and build chain of reasoning
      if (lastControl === 'interestRate') {
        const change = cur.interest_rate_pct > prev.interest_rate_pct ? 'raised' : 'lowered';
        const direction = change === 'raised' ? 'higher' : 'lower';
        
        analysis = `
          <div class="analysis-chain">
            <div class="chain-step">
              <strong>Initial effect:</strong> ${direction === 'higher' ? 'Higher' : 'Lower'} interest rates ${direction === 'higher' ? 'increase' : 'reduce'} borrowing costs for businesses and households.
            </div>
            <div class="chain-step">
              <span class="chain-arrow">↓</span>
              <strong>Spending response:</strong> Firms cut investment, consumers reduce spending on credit-financed goods 
              <span class="econ-concept" title="Total spending in the economy">aggregate demand</span> ${direction === 'higher' ? 'falls' : 'rises'}.
            </div>
            <div class="chain-step">
              <span class="chain-arrow">↓</span>
              <strong>Economic activity:</strong> ${direction === 'higher' ? 'Slower' : 'Faster'} growth affects employment through 
              <span class="econ-concept" title="Relationship between growth and unemployment">Okun's law</span>.
            </div>
            <div class="chain-step">
              <span class="chain-arrow">↓</span>
              <strong>Village impact:</strong> Real interest rate is now ${realRate.toFixed(1)}%, affecting housing market activity and business investment.
            </div>
          </div>
        `;
        
        evaluation = `
          <div class="time-horizon">
            <div class="short-term">
              <strong>Short-term:</strong> Housing market reacts quickly to rate changes. Mortgage demand ${direction === 'higher' ? 'falls' : 'rises'} within months.
            </div>
