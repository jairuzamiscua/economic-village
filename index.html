<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EconoVille — Phase 1++ (Queue • Upkeep • Workforce • Tutorial)</title>
<style>
:root{
  --bg:#0f172a;--panel:#111827ee;--panel2:#0b1224cc;--text:#e5e7eb;
  --muted:#9ca3af;--accent:#22d3ee;--accent2:#a78bfa;
  --good:#22c55e;--warn:#f59e0b;--bad:#ef4444;--border:#1f2937;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:radial-gradient(1200px 800px at 70% -10%,#1e293b 0%,#0b1224 40%,#050816 100%);
     color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
.shell{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border)}
header h1{font-size:18px;margin:0;font-weight:800;letter-spacing:.3px}
header .tag{font-size:12px;color:var(--muted)}
.main{display:grid;grid-template-columns:360px 1fr 360px;gap:14px;padding:14px}
.panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);
       border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.panel h2{font-size:12px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);margin:0 0 10px}
.left{padding:14px;overflow:auto}
.cards{display:grid;gap:10px}
.card{border:1px solid var(--border);background:#0b1224aa;border-radius:12px;padding:12px}
.card h3{margin:0 0 6px;font-size:14px}
.card p{margin:0 0 8px;color:var(--muted);font-size:12px;line-height:1.35}
.meta{display:flex;gap:8px;font-size:11px;color:var(--muted);margin-bottom:10px;flex-wrap:wrap}
.pill{padding:2px 8px;border:1px solid var(--border);border-radius:999px}
.pill.cd{border-style:dashed}
button.action{width:100%;padding:10px 12px;border:none;border-radius:10px;font-weight:800;color:#061015;
              background:linear-gradient(135deg,var(--accent),var(--accent2));cursor:pointer}
button.action:disabled{opacity:.35;cursor:not-allowed}
.queue{margin-top:14px;border-top:1px dashed var(--border);padding-top:10px}
.queue h3{font-size:12px;margin:0 0 8px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em}
.qitem{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border);
       border-radius:10px;padding:8px;margin-bottom:8px;background:#0b1224aa}
.qitem .name{font-size:13px}
.qitem .prog{font-size:12px;color:var(--muted)}
.qitem .cancel{border:1px solid var(--border);background:transparent;color:var(--text);border-radius:8px;padding:6px 8px;cursor:pointer}
.center{position:relative;padding:12px}
.view{height:100%;min-height:520px;border-radius:14px;border:1px solid var(--border);
      background:linear-gradient(180deg,rgba(30,41,59,.55),rgba(2,6,23,.7)),
                 radial-gradient(1200px 600px at 50% -10%,rgba(34,211,238,.15),transparent 50%),
                 url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="600" height="400"><defs><pattern id="g" width="40" height="40" patternUnits="userSpaceOnUse"><path d="M0 20 H40 M20 0 V40" stroke="%231f2937" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="%230a0f1f"/><rect width="100%" height="100%" fill="url(%23g)"/></svg>');
      background-size:cover;position:relative;overflow:hidden}
.hud{position:absolute;top:10px;left:10px;display:flex;gap:8px;flex-wrap:wrap}
.badge{background:#0b1224cc;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px}
.stageBanner{position:absolute;top:12px;right:12px;background:#0b1224cc;border:1px solid var(--border);
             border-radius:12px;padding:8px 12px;font-size:12px}
.sprite{position:absolute;transition:transform .4s ease,opacity .4s ease}
.sprite.hut{width:70px;height:50px;left:40px;bottom:40px;background:linear-gradient(180deg,#d4a373,#8d5524);
            border:2px solid #2b1d11;border-bottom-left-radius:8px;border-bottom-right-radius:8px}
.sprite.field{width:140px;height:80px;left:140px;bottom:36px;background:repeating-linear-gradient(45deg,#14532d 0 6px,#166534 6px 12px);
              border:2px solid #0e2518;border-radius:6px}
.sprite.granary{width:70px;height:52px;left:60px;bottom:110px;background:linear-gradient(180deg,#9ca3af,#6b7280);
                border:2px solid #111827;border-radius:6px;display:none}
.sprite.well{width:24px;height:24px;left:230px;bottom:128px;background:radial-gradient(circle,#93c5fd,#1d4ed8);
             border:2px solid #0b3b9a;border-radius:50%;display:none}
.sprite.canal{width:6px;height:120px;left:210px;bottom:50px;background:#22d3ee;border:1px solid #0c4a6e;border-radius:3px;display:none}
.sprite.council{width:84px;height:54px;left:250px;bottom:36px;background:linear-gradient(180deg,#fde68a,#b45309);
                border:2px solid #78350f;border-radius:8px;display:none}
.sprite.market{width:120px;height:36px;left:120px;bottom:140px;background:repeating-linear-gradient(90deg,#fca5a5 0 10px,#fdba74 10px 20px,#fde68a 20px 30px);
               border:2px solid #7c2d12;border-radius:8px;display:none}
.sprite.workshop{width:90px;height:50px;left:300px;bottom:110px;background:linear-gradient(180deg,#94a3b8,#475569);
                 border:2px solid #1f2937;border-radius:8px;display:none}
.sprite.house{width:46px;height:36px;background:linear-gradient(180deg,#d1d5db,#6b7280);border:2px solid #111827;border-radius:6px;display:none}
.sprite.farm{width:110px;height:64px;background:repeating-linear-gradient(45deg,#166534 0 7px,#0e9f6e 7px 14px);border:2px solid #064e3b;border-radius:6px;display:none}
.right{padding:14px}
.meters{display:grid;gap:12px}
.meter{background:#0b1224aa;border:1px solid var(--border);border-radius:10px;padding:10px}
.meter header{display:flex;align-items:center;justify-content:space-between;padding:0;border:none}
.meter header h4{margin:0;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em}
.bar{height:12px;background:#0b1224;border:1px solid var(--border);border-radius:999px;overflow:hidden}
.fill{height:100%;width:0%;background:linear-gradient(90deg,var(--good),var(--accent));transition:width .4s ease}
.bar.bad .fill{background:linear-gradient(90deg,var(--bad),#f97316)}
.stat{font-size:12px;color:var(--muted);margin-top:6px}
.kpi{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
.chip{border:1px solid var(--border);border-radius:8px;padding:6px 8px;font-size:12px;color:var(--muted)}
.workforce{margin-top:12px;border-top:1px dashed var(--border);padding-top:10px}
.workforce h3{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em;margin:0 0 8px}
.wbtn{border:1px solid var(--border);background:transparent;color:var(--text);border-radius:10px;padding:6px 10px;cursor:pointer;margin-right:6px}
.wbtn.active{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#041018}
.bottom{margin:0 14px 14px;padding:12px}
.reason{border:1px solid var(--border);border-radius:12px;background:#0b1224aa;padding:12px}
.btnRow{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;color:#041018;border-radius:10px;
         padding:10px 12px;font-weight:800;cursor:pointer}
.ghost{background:transparent;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:10px 12px;cursor:pointer}
.toast{position:fixed;bottom:18px;right:18px;background:#0b1224ee;border:1px solid var(--border);padding:10px 12px;
       border-radius:10px;font-size:13px;display:none}
/* tutorial overlay */
.tut{position:fixed;inset:0;background:rgba(2,6,23,.8);display:none;align-items:center;justify-content:center;z-index:50}
.tcard{width:min(720px,90%);background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);
       border-radius:16px;padding:18px}
.tcard h2{margin:0 0 8px} .tcard p{margin:8px 0 12px;color:var(--muted)}
.tnav{display:flex;justify-content:space-between;gap:8px}
.tnav button{border:1px solid var(--border);background:transparent;color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer}
.tnav .primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#041018;border:none}
</style>
</head>
<body>
  <div class="shell">
    <header>
      <div>
        <h1>EconoVille — Phase 1: Village Economy</h1>
        <div class="tag">Subsistence → Surplus → Proto-Institutions • Queue • Upkeep • Workforce</div>
      </div>
      <div class="tag">
        Date: <span id="date">Year 1, Month 1</span> •
        Turn: <span id="turn">1</span> •
        Season: <span id="season">Spring</span>
      </div>
    </header>

    <div class="main">
      <!-- LEFT -->
      <aside class="panel left">
        <h2>Projects & Builds</h2>
        <div class="cards" id="cards"></div>

        <div class="queue">
          <h3>Build Queue</h3>
          <div id="queueList"></div>
        </div>
      </aside>

      <!-- CENTER -->
      <section class="panel center">
        <div class="view" id="view">
          <div class="hud">
            <div class="badge">Population: <span id="pop">100</span>/<span id="cap">100</span></div>
            <div class="badge">Builders: <span id="labor">20%</span></div>
            <div class="badge">PP: <span id="pp">10</span></div>
            <div class="badge">Coins: <span id="money">20</span></div>
            <div class="badge">Food: <span id="food">100</span></div>
          </div>
          <div class="stageBanner" id="stage">Stage: Village (Phase 1++)</div>

          <!-- baseline -->
          <div class="sprite hut" title="Homes"></div>
          <div class="sprite field" title="Fields"></div>

          <!-- infra/institutions -->
          <div class="sprite granary" id="spr_granary" title="Granary"></div>
          <div class="sprite well" id="spr_well" title="Well"></div>
          <div class="sprite canal" id="spr_canal" title="Irrigation"></div>
          <div class="sprite council" id="spr_council" title="Council Hut"></div>
          <div class="sprite market" id="spr_market" title="Market Fair"></div>
          <div class="sprite workshop" id="spr_workshop" title="Workshop"></div>

          <!-- dynamic houses/farms -->
          <div class="sprite house" id="tpl_house" style="left:28px;bottom:200px"></div>
          <div class="sprite farm"  id="tpl_farm"  style="left:320px;bottom:48px"></div>
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="panel right">
        <h2>Village Indicators</h2>
        <div class="meters">
          <div class="meter">
            <header><h4>Food</h4><span id="foodLbl">0%</span></header>
            <div class="bar" id="barFood"><div class="fill" id="fillFood"></div></div>
            <div class="stat">Stocks: <b id="foodStock">0</b> • Needs: <b id="foodNeeds">0</b> • Surplus: <b id="foodSurplus">0</b></div>
          </div>
          <div class="meter">
            <header><h4>Health</h4><span id="healthLbl">0%</span></header>
            <div class="bar" id="barHealth"><div class="fill" id="fillHealth"></div></div>
            <div class="stat">Sanitation & medicine reduce mortality.</div>
          </div>
          <div class="meter">
            <header><h4>Trust</h4><span id="trustLbl">0%</span></header>
            <div class="bar" id="barTrust"><div class="fill" id="fillTrust"></div></div>
            <div class="stat">Legitimacy for enacting reforms.</div>
          </div>
          <div class="meter">
            <header><h4>Stability</h4><span id="stabLbl">0%</span></header>
            <div class="bar" id="barStab"><div class="fill" id="fillStab"></div></div>
            <div class="stat">Low stability risks disputes or revolt.</div>
          </div>

          <div class="workforce">
            <h3>Workforce Assignment</h3>
            <div>
              <button class="wbtn" data-share="0.1">Builders 10%</button>
              <button class="wbtn active" data-share="0.2">Builders 20%</button>
              <button class="wbtn" data-share="0.3">Builders 30%</button>
            </div>
            <p class="stat">More builders speed construction but reduce farm labour this season.</p>
          </div>

          <div class="kpi">
            <div class="chip">Season: <span id="kSeason">Spring</span></div>
            <div class="chip">Events: <span id="kEvents">None</span></div>
          </div>
        </div>
      </aside>
    </div>

    <!-- BOTTOM -->
    <div class="bottom">
      <div class="reason" id="reason">
        <b>Tip:</b> Surplus food turns into <b>coins</b> (more with a <i>Market Fair</i>) and <b>PP</b> via legitimacy (Council).
        Build <b>Houses</b> to raise population capacity and <b>Farms</b> to grow output. Use the <b>Workforce</b> buttons to tune build speed vs food.
      </div>
      <div class="btnRow">
        <button class="ghost" id="btnReset">Reset</button>
        <button class="primary" id="btnPlay">▶ Play</button>
        <button class="ghost" id="btnAdvance">Step Season</button>
        <select class="ghost" id="speed" title="Game speed">
          <option value="1">1x</option>
          <option value="1.5">1.5x</option>
          <option value="2">2x</option>
          <option value="3">3x</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Tutorial Overlay -->
  <div class="tut" id="tut">
    <div class="tcard">
      <h2 id="tTitle">Welcome to EconoVille — Phase 1</h2>
      <p id="tBody">You lead a subsistence village. Create a food surplus and build proto-institutions to advance.</p>
      <div class="tnav">
        <button id="tPrev">Back</button>
        <div></div>
        <button class="primary" id="tNext">Next</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ==========================
   Phase 1++ (Queue • Upkeep • Workforce • Tutorial)
   Economics: Malthus (capacity/food), Lewis (surplus → non-farm),
   Rodrik (institutions), Europe (plough, granaries, fairs).
   ========================== */

let TIMER=null, SPEED=1, MONTH_TIMER=null;

const S = {
  // time
  turn:1, seasonIdx:0, seasons:["Spring","Summer","Autumn","Winter"], year:1, month:1,
  // people
  pop:100, cap:100,
  builderShare:0.2, // workforce assignment (0.1/0.2/0.3)
  needsPerCap:0.9,
  // production
  land:1.0, A:1.0, losses:0.12,
  // institutions & money
  health:0.35, trust:0.40, stability:0.45, pp:10, money:20,
  // builds / flags
  built:{ well:false, granary:false, irrigation:false, council:false, fair:false, workshop:false, plough:false },
  farms:0, houses:0,
  // queue (construction)
  queue:[], // {id,name,dur,left,lab,effect,upkeep}
  // cooldowns
  cooldowns:{ gatherReadyAt:1 },
  eventsLast:[],
};

const el=id=>document.getElementById(id);
const toast=msg=>{const t=el('toast');t.innerHTML=msg;t.style.display='block';setTimeout(()=>t.style.display='none',2400)};
function setDateDisplay(){ el('date').textContent=`Year ${S.year}, Month ${S.month}`; }

// ======== Production snapshot ========
function snapshot(){
  const builders = Math.floor(S.pop * S.builderShare);
  const LA = Math.max(0, S.pop - builders); // farm labour pool
  const effLand = S.land + S.farms*0.15;
  const tech = S.A * (S.built.irrigation?1.15:1) * (S.built.plough?1.25:1);
  const output = tech * Math.pow(effLand,0.3) * Math.pow(LA*0.9,0.7);
  const loss = S.losses * (S.built.granary?0.6:1);
  const foodOut = Math.max(0, output * (1 - loss));
  const needs = S.pop * S.needsPerCap;
  const net = Math.round(foodOut - needs);
  return {builders, LA, effLand, foodOut, needs, net};
}

function recompute(reason=""){
  const {builders, foodOut, needs, net} = snapshot();

  // meters
  const foodRatio = Math.max(0, Math.min(1, foodOut/(needs*1.2)));
  setBar('Food', foodRatio, foodOut, needs, net);
  setBar('Health', S.health);
  setBar('Trust', S.trust);
  setBar('Stab', S.stability);

  // HUD
  el('pop').textContent=S.pop; el('cap').textContent=S.cap;
  el('labor').textContent=Math.round(S.builderShare*100)+'%';
  el('pp').textContent=Math.floor(S.pp);
  el('money').textContent=Math.floor(S.money);
  el('food').textContent=Math.round(foodOut);
  el('season').textContent=S.seasons[S.seasonIdx];
  el('kSeason').textContent=S.seasons[S.seasonIdx];
  el('kEvents').textContent=S.eventsLast.join(', ') || 'None';
  setDateDisplay();

  // sprites toggles
  el('spr_well').style.display=S.built.well?'block':'none';
  el('spr_granary').style.display=S.built.granary?'block':'none';
  el('spr_canal').style.display=S.built.irrigation?'block':'none';
  el('spr_council').style.display=S.built.council?'block':'none';
  el('spr_market').style.display=S.built.fair?'block':'none';
  el('spr_workshop').style.display=S.built.workshop?'block':'none';
  syncDynamicSprites();

  if(reason) el('reason').innerHTML=reason;

  // Phase 2 teaser
  if (net > 0 && (S.built.granary || S.built.irrigation) && !S.built.workshop) mountCards();
  renderQueue();
}

function setBar(kind,val,foodOut,needs,surplus){
  const fill=el('fill'+kind); const lbl=el(kind.toLowerCase()+"Lbl");
  fill.style.width=Math.round(val*100)+'%';
  if(kind==='Food'){
    el('foodLbl').textContent=Math.round(val*100)+'%';
    el('foodStock').textContent=Math.round(foodOut);
    el('foodNeeds').textContent=Math.round(needs);
    el('foodSurplus').textContent=surplus;
    el('barFood').classList.toggle('bad',surplus<0);
  } else lbl.textContent=Math.round(val*100)+'%';
}

function syncDynamicSprites(){
  const view=el('view');
  [...view.querySelectorAll('.clone')].forEach(n=>n.remove());
  // houses grid
  for(let i=0;i<S.houses;i++){
    const n=el('tpl_house').cloneNode(true); n.classList.add('clone'); n.style.display='block';
    const col=i%5, row=Math.floor(i/5);
    n.style.left=(28+col*54)+'px'; n.style.bottom=(200+row*44)+'px';
    view.appendChild(n);
  }
  // farms grid
  for(let i=0;i<S.farms;i++){
    const n=el('tpl_farm').cloneNode(true); n.classList.add('clone'); n.style.display='block';
    const col=i%4, row=Math.floor(i/4);
    n.style.left=(320+col*120)+'px'; n.style.bottom=(48+row*70)+'px';
    view.appendChild(n);
  }
}

// ======== Cards (Projects & Builds) ========
const ALL_CARDS = [
  // Soft-power — Community Gathering
  { id:'gather', name:'Community Gathering', cost:{pp:0,money:0,labor:1}, dur:1, upkeep:0,
    desc:'Hold a gathering. +Trust, +1 PP. Cooldown 4 seasons.',
    tip:'Legitimacy builds policy capacity.',
    can:()=> S.turn>=S.cooldowns.gatherReadyAt,
    req:()=> S.pop>=60,
    effect:()=>{ S.trust=Math.min(1,S.trust+0.06); S.pp+=1; S.cooldowns.gatherReadyAt=S.turn+4; }
  },
  // Infrastructure / Institutions
  { id:'well', name:'Build Wells & Sanitation', cost:{pp:2,money:6,labor:2}, dur:2, upkeep:0.2,
    desc:'Reduce disease; improves health.',
    tip:'Public health cushions shocks.',
    can:()=>!S.built.well, req:()=> true,
    effect:()=>{ S.built.well=true; S.health=Math.min(1,S.health+0.25); S.stability=Math.min(1,S.stability+0.05); }
  },
  { id:'granary', name:'Construct Granary', cost:{pp:3,money:8,labor:3}, dur:3, upkeep:0.3,
    desc:'Cut spoilage; buffers bad harvests.',
    tip:'Granaries reduce famine volatility.',
    can:()=>!S.built.granary, req:()=> true,
    effect:()=>{ S.built.granary=true; S.stability=Math.min(1,S.stability+0.10); }
  },
  { id:'council', name:'Form Village Council', cost:{pp:3,money:4,labor:1}, dur:1, upkeep:0.1,
    desc:'Legitimacy & dispute resolution. Generates PP when surplus is positive.',
    tip:'Market-creating institutions.',
    can:()=>!S.built.council, req:()=> S.pop>=80,
    effect:()=>{ S.built.council=true; S.trust=Math.min(1,S.trust+0.20); S.stability=Math.min(1,S.stability+0.15); }
  },
  { id:'literacy', name:'Run Literacy Classes', cost:{pp:2,money:5,labor:1}, dur:1, upkeep:0.1,
    desc:'+TFP now; unlocks faster tech later.',
    tip:'Human capital deepens growth.',
    can:()=>true, req:()=> S.pop>=70,
    effect:()=>{ S.A*=1.02; S.trust=Math.min(1,S.trust+0.05); }
  },
  { id:'fair', name:'Establish Market Fair', cost:{pp:2,money:10,labor:2}, dur:2, upkeep:0.2,
    desc:'Boosts trade revenue from surplus; small stability bump.',
    tip:'Fairs monetize surplus.',
    can:()=>!S.built.fair, req:()=> S.pop>=80,
    effect:()=>{ S.built.fair=true; S.stability=Math.min(1,S.stability+0.05); }
  },
  { id:'irrigation', name:'Dig Irrigation Ditch', cost:{pp:3,money:8,labor:3}, dur:3, upkeep:0.15,
    desc:'+15% yields via secured water.',
    tip:'Precondition to sustained surplus.',
    can:()=>!S.built.irrigation, req:()=> true,
    effect:()=>{ S.built.irrigation=true; S.A*=1.05; }
  },
  { id:'plough', name:'Adopt Heavy Plough/Rotation', cost:{pp:4,money:12,labor:3}, dur:3, upkeep:0.15,
    desc:'+25% yield jump (tech step).',
    tip:'Medieval divergence on heavy soils.',
    can:()=>!S.built.plough, req:()=> true,
    effect:()=>{ S.built.plough=true; S.A*=1.10; S.trust=Math.min(1,S.trust+0.03); }
  },
  { id:'workshop', name:'Open Community Workshop', cost:{pp:4,money:12,labor:3}, dur:3, upkeep:0.2,
    desc:'Proto-industry; generates coin each season if surplus exists.',
    tip:'Lewis: modern sector emerges post-surplus.',
    can:()=> !S.built.workshop && (S.built.granary||S.built.irrigation),
    req:()=> S.pop>=90,
    effect:()=>{ S.built.workshop=true; }
  },
  // Construction economy
  { id:'build_house', name:'Build House (+4 cap)', cost:{pp:2,money:8,labor:2}, dur:2, upkeep:0.05,
    desc:'Raises population capacity to allow growth.',
    tip:'Housing as capacity constraint.',
    can:()=>true, req:()=> true,
    effect:()=>{ S.houses+=1; S.cap+=4; }
  },
  { id:'build_farm', name:'Develop Farm Plot (+land)', cost:{pp:2,money:10,labor:3}, dur:2, upkeep:0.08,
    desc:'Expands effective land; increases food output.',
    tip:'Extensive margin growth.',
    can:()=>true, req:()=> true,
    effect:()=>{ S.farms+=1; }
  },
];

function totalQueuedLabor(){
  return S.queue.reduce((a,q)=>a+q.lab,0);
}

function enqueue(card){
  const builders = Math.floor(S.pop * S.builderShare);
  if(S.pp < card.cost.pp){ toast('Not enough PP'); return; }
  if(S.money < (card.cost.money||0)){ toast('Not enough coins'); return; }
  if((totalQueuedLabor()+ (card.cost.labor||0)) > builders){ toast('Not enough builders for this season'); return; }
  if(!card.req()){ toast('Requirements not met'); return; }

  S.pp -= card.cost.pp;
  S.money -= (card.cost.money||0);
  const item = {
    id: card.id, name: card.name, dur: card.dur, left: card.dur,
    lab: card.cost.labor||0, effect: card.effect, upkeep: card.upkeep||0
  };
  S.queue.push(item);
  toast(`Enqueued: <b>${card.name}</b> (${card.dur} seasons)`);
  mountCards(); renderQueue(); recompute();
}

function cancelQueue(i){
  S.queue.splice(i,1);
  renderQueue();
}

function mountCards(){
  const wrap=el('cards'); wrap.innerHTML='';
  const builders = Math.floor(S.pop * S.builderShare);
  ALL_CARDS.forEach(c=>{
    if(!c.can()) return;
    const div=document.createElement('div');
    div.className='card';
    const cdText = c.id==='gather' ? `<span class="pill cd">Cooldown: ${Math.max(0,(S.cooldowns.gatherReadyAt - S.turn))} seasons</span>` : '';
    div.innerHTML = `
      <h3>${c.name}</h3>
      <div class="meta">
        <span class="pill">Cost: PP ${c.cost.pp}</span>
        <span class="pill">Coins ${c.cost.money||0}</span>
        <span class="pill">Labor ${c.cost.labor||0}/${builders}</span>
        <span class="pill">Duration ${c.dur}⏳</span>
        ${cdText}
        <span class="pill" title="${c.tip}">Info</span>
      </div>
      <p>${c.desc}</p>
      <button class="action">Enqueue</button>
    `;
    const btn=div.querySelector('button');
    btn.addEventListener('click',()=>enqueue(c));
    wrap.appendChild(div);
  });
}

function renderQueue(){
  const q=el('queueList'); q.innerHTML='';
  S.queue.forEach((it,idx)=>{
    const row=document.createElement('div');
    row.className='qitem';
    row.innerHTML=`
      <span class="name">${it.name}</span>
      <span class="prog">Lab ${it.lab} • ${it.left}/${it.dur} seasons</span>
      <button class="cancel">Cancel</button>
    `;
    row.querySelector('.cancel').addEventListener('click',()=>cancelQueue(idx));
    q.appendChild(row);
  });
}

// ===== Ambient micro-events =====
function ambientEvents(){
  const events=[];
  if(Math.random()<0.10){ events.push('Good Rains'); S.A*=1.01; }
  if(Math.random()<0.07){ events.push('Skilled Hunter'); S.trust=Math.min(1,S.trust+0.01); }
  if(S.built.fair && Math.random()<0.12){ events.push('Peaceful Festival'); S.trust=Math.min(1,S.trust+0.03); S.stability=Math.min(1,S.stability+0.02); }
  if(Math.random()<(S.built.council?0.03:0.10)){ events.push('Bandit Sighting'); S.stability=Math.max(0,S.stability-(S.built.council?0.01:0.04)); }
  if(events.length) S.eventsLast=S.eventsLast.concat(events);
}

// ===== Upkeep costs (coins per season) =====
function upkeepCost(){
  let cost = 0;
  cost += S.houses * 0.2;
  cost += S.farms  * 0.3;
  if(S.built.well)      cost += 0.2;
  if(S.built.granary)   cost += 0.3;
  if(S.built.council)   cost += 0.1;
  if(S.built.fair)      cost += 0.2;
  if(S.built.irrigation)cost += 0.15;
  if(S.built.plough)    cost += 0.15;
  if(S.built.workshop)  cost += 0.2;
  return cost;
}

// ===== Season step =====
function advanceSeason(){
  S.turn++; S.seasonIdx=(S.seasonIdx+1)%4; el('turn').textContent=S.turn;
  S.eventsLast=[];

  // 1) Progress queue (requires sufficient builders in total)
  const builders = Math.floor(S.pop * S.builderShare);
  const needLab = totalQueuedLabor();
  const progressMultiplier = needLab<=builders ? 1 : Math.max(0.3, builders/Math.max(1,needLab)); // slow if understaffed
  S.queue.forEach(it=> it.left = Math.max(0, it.left - progressMultiplier));
  // Complete finished items
  const completed = S.queue.filter(it=>it.left<=0);
  if(completed.length){
    completed.forEach(it=> it.effect && it.effect());
    S.queue = S.queue.filter(it=>it.left>0);
    S.eventsLast.push('Project Complete');
  }

  // 2) Production & crises
  const {foodOut, needs, net} = snapshot();
  // Disease
  let deathRate = 0.02 * (1 - S.health);
  const diseaseRisk = (S.built.well?0.03:0.10) * (1 - S.health);
  if(Math.random()<diseaseRisk){
    const dead=Math.max(1,Math.round(S.pop*(0.02 + Math.random()*0.03)));
    S.pop=Math.max(10,S.pop-dead); S.eventsLast.push('Disease'); S.stability=Math.max(0,S.stability-0.05);
  }
  // Famine
  if(net<0){
    const famineRisk=(S.built.granary?0.15:0.45);
    if(Math.random()<famineRisk){
      const dead=Math.max(1,Math.round(S.pop*(0.03 + Math.random()*0.04)));
      S.pop=Math.max(10,S.pop-dead); S.eventsLast.push('Famine');
      S.trust=Math.max(0,S.trust-0.08); S.stability=Math.max(0,S.stability-0.08);
    }
  }
  // Disputes
  if(S.stability<0.35 && !S.built.council && Math.random()<0.25){ S.eventsLast.push('Dispute'); S.trust=Math.max(0,S.trust-0.06); }

  // 3) Ambient
  ambientEvents();

  // 4) Demography (births capped by housing cap)
  const births = Math.max(0, Math.min(S.cap - S.pop, Math.round((net>0? net:0) * 0.05)));
  const naturalDeaths = Math.round(S.pop*deathRate);
  S.pop = Math.max(10, S.pop + births - naturalDeaths);

  // 5) Coins: trade surplus + workshop revenue, minus upkeep
  const price = S.built.fair ? 0.20 : 0.05;
  const tradeCoins = Math.max(0, net) * price;
  const workshopCoins = (S.built.workshop && net>0) ? 2 : 0;
  const upkeep = upkeepCost();
  S.money = Math.max(-50, Math.min(999, S.money + tradeCoins + workshopCoins - upkeep));
  if(S.money < 0){
    S.eventsLast.push('Budget Shortfall');
    S.trust    = Math.max(0, S.trust - 0.03);
    S.stability= Math.max(0, S.stability - 0.03);
    S.money = 0;
  }

  // 6) Political Power engine
  let ppGain=0;
  if(net>0) ppGain+=1;
  if(S.built.council && net>0) ppGain+=1;
  if(S.built.fair) ppGain+=0.5;
  ppGain+=Math.max(0, Math.floor(S.trust*1));
  if(S.eventsLast.includes('Famine')) ppGain-=1;
  if(S.eventsLast.includes('Dispute')) ppGain-=0.5;
  S.pp=Math.max(0, Math.min(99, S.pp + ppGain));

  // 7) Drifts
  if(net>0 && S.built.council){ S.trust=Math.min(1,S.trust+0.03); }
  if(S.built.council){ S.stability=Math.min(1,S.stability+0.02); }
  if(net<0){ S.stability=Math.max(0,S.stability-0.01); }

  const ready = (net>0) && (S.built.council || S.built.granary) && (S.built.irrigation || S.built.plough);
  const msg = ready
    ? `Surplus sustained; institutions forming. <b>Proto-Industry ready next</b>.`
    : `Season passed. Net food: <b>${net>=0? '+'+net: net}</b>. Trade: <b>${tradeCoins.toFixed(1)}</b>, Workshop: <b>${workshopCoins}</b>, Upkeep: <b>-${upkeep.toFixed(1)}</b>. Events: <b>${S.eventsLast.join(', ')||'None'}</b>.`;

  recompute(msg);
  mountCards();
}

// ===== Autoplay & Month ticker =====
function start(){
  if(TIMER) return;
  const base=4000; TIMER=setInterval(advanceSeason, base / SPEED);
  el('btnPlay').textContent='⏸ Pause';
  startMonthTicker();
}
function stop(){
  if(!TIMER) return; clearInterval(TIMER); TIMER=null;
  el('btnPlay').textContent='▶ Play';
  stopMonthTicker();
}
function startMonthTicker(){
  if(MONTH_TIMER) return;
  const base=1000;
  MONTH_TIMER=setInterval(()=>{
    S.month++; if(S.month>12){ S.month=1; S.year++; }
    setDateDisplay();
  }, base / SPEED);
}
function stopMonthTicker(){ if(!MONTH_TIMER) return; clearInterval(MONTH_TIMER); MONTH_TIMER=null; }

// ===== Reset =====
function reset(){
  stop();
  Object.assign(S,{
    turn:1,seasonIdx:0,year:1,month:1,
    pop:100,cap:100,builderShare:0.2,needsPerCap:0.9,land:1.0,A:1.0,losses:0.12,
    health:0.35,trust:0.40,stability:0.45,pp:10,money:20,
    built:{well:false,granary:false,irrigation:false,council:false,fair:false,workshop:false,plough:false},
    farms:0,houses:0,queue:[],cooldowns:{gatherReadyAt:1},eventsLast:[]
  });
  mountCards(); renderQueue(); recompute('Reset to starting conditions.');
}

// ===== Workforce buttons =====
document.addEventListener('click', (e)=>{
  const b = e.target.closest('.wbtn');
  if(!b) return;
  document.querySelectorAll('.wbtn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  S.builderShare = parseFloat(b.dataset.share);
  recompute('Workforce updated: Builders at ' + Math.round(S.builderShare*100) + '% this season.');
});

// ===== Tutorial overlay =====
const tut = el('tut');
const steps = [
  {t:'Welcome to EconoVille — Phase 1', b:'Create a food surplus, then build institutions to unlock proto-industry.'},
  {t:'Projects & Build Queue', b:'Enqueue projects. Each uses PP, coins, and builders. Multi-season builds complete automatically.'},
  {t:'Workforce Assignment', b:'Set Builders to 10/20/30%. More builders speed construction but reduce farming output.'},
  {t:'Money & Upkeep', b:'Surplus converts to coins (more with Market Fair). Buildings have upkeep — shortfalls hurt trust & stability.'},
];
let stepIdx = 0;
function showTut(i=0){ stepIdx=i; el('tTitle').textContent=steps[i].t; el('tBody').textContent=steps[i].b; tut.style.display='flex'; }
function hideTut(){ tut.style.display='none'; }
el('tPrev').addEventListener('click', ()=>{ stepIdx=Math.max(0, stepIdx-1); showTut(stepIdx); });
el('tNext').addEventListener('click', ()=>{ stepIdx++; if(stepIdx>=steps.length) hideTut(); else showTut(stepIdx); });

// ===== Init =====
mountCards(); renderQueue(); recompute();
showTut(0);

el('btnAdvance').addEventListener('click', advanceSeason);
el('btnReset').addEventListener('click', reset);
el('btnPlay').addEventListener('click', ()=> (TIMER? stop(): start()));
el('speed').addEventListener('change',(e)=>{SPEED=parseFloat(e.target.value||'1'); if(TIMER){stop();start();} if(MONTH_TIMER){stopMonthTicker();startMonthTicker();}});
</script>
</body>
</html>
