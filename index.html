
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EconoVille — Macroeconomic Village Simulator</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg,#87CEEB,#98FB98);
      color:#333; overflow:auto;
    }
    .container{display:flex; height:100vh}
    .game-area{flex:1; position:relative; min-width:0}
    #gameCanvas{
      border:2px solid #8B4513; background:#90EE90; display:block;
      width:100%; height:auto; max-width:100%;
      image-rendering: pixelated; image-rendering: crisp-edges;
      cursor: crosshair;
    }
    .narrative-banner{
      position:absolute; top:10px; left:10px; z-index:10;
      background:rgba(255,255,255,0.92); border:2px solid #4169E1;
      border-radius:8px; padding:10px 14px; max-width:420px;
      font-weight:bold; color:#2E8B57;
    }
    .legend{
      position:absolute; bottom:10px; left:10px; z-index:10;
      background:rgba(255,255,255,0.9); border:1px solid #DDD;
      border-radius:6px; padding:10px; font-size:0.85em;
    }
    .legend-item{display:flex; align-items:center; gap:8px; margin:4px 0}
    .legend-icon{width:16px; height:16px; border:1px solid #666}
    .controls{
      width:320px; min-width:250px; max-width:500px; background:rgba(255,255,255,0.96);
      padding:18px 20px; border-left:2px solid #8B4513; overflow-y:auto;
      position:relative;
    }
    .resize-handle{
      position:absolute; left:0; top:0; bottom:0; width:6px;
      background:linear-gradient(90deg, transparent, #8B4513, transparent);
      cursor:col-resize; z-index:20;
    }
    .resize-handle:hover{
      background:linear-gradient(90deg, transparent, #4169E1, transparent);
    }
    .resize-handle::before{
      content:''; position:absolute; left:2px; top:50%; transform:translateY(-50%);
      width:2px; height:30px; background:#8B4513; border-radius:1px;
    }
    .preset-buttons{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:14px}
    button{
      padding:8px 12px; border:2px solid #4169E1; border-radius:6px;
      background:#87CEEB; color:#fff; font-weight:bold; cursor:pointer;
      transition:transform .15s, background .15s;
    }
    button:hover{background:#4169E1; transform:translateY(-1px)}
    .scenario-tip{
      background:#FFF8DC; border:1px solid #DDA0DD; border-radius:6px;
      padding:10px; margin:8px 0 12px; color:#8B4513; font-size:0.9em;
    }
    .status-row{
      background:#E6F3FF; border-radius:6px; padding:8px; font-size:0.85em; margin:10px 0;
    }
    .control-group{margin:12px 0}
    .control-group label{display:block; font-weight:bold; color:#2E8B57; margin-bottom:6px}
    .slider-container{display:flex; align-items:center; gap:10px}
    input[type="range"]{flex:1; height:6px; border-radius:3px; background:#ddd; outline:none}
    .value-display{min-width:56px; text-align:right; font-weight:bold; color:#4169E1}
    .debug-panel{margin-top:14px; background:#F0F8FF; border:1px solid #B0C4DE; border-radius:6px}
    .debug-toggle{width:100%; background:#B0C4DE; border:none; padding:8px; font-weight:bold; cursor:pointer}
    .debug-content{display:none; padding:10px; font-family:monospace; font-size:0.85em}
    .debug-content.open{display:block}
    .glossary{display:none; background:#F5F5F5; border:1px solid #DDD; border-radius:6px; padding:10px; margin-top:10px; font-size:0.88em}
    .glossary.open{display:block}
    .glossary-term{font-weight:bold; color:#4169E1}
    .tooltip{
      position:absolute; pointer-events:none; z-index:100;
      max-width:260px; background:rgba(0,0,0,0.92); color:#fff;
      padding:8px 10px; border-radius:6px; font-size:0.9em; opacity:0; transition:opacity .15s;
    }
    .tooltip.visible{opacity:1}
    .reasoning-bar{
      background:#fff; border:1px solid #B0C4DE; border-radius:8px;
      padding:12px; margin:12px 0; font-size:0.9em
    }
    .reasoning-bar header{
      display:flex; align-items:center; justify-content:space-between; margin-bottom:8px
    }
    .reasoning-list{ margin-left:18px }
    .reasoning-list li{ margin:6px 0 }
    .refs-panel{ display:none; margin-top:8px; padding:8px; background:#F7FAFF; border:1px solid #DCE7FA; border-radius:6px; font-size:0.86em }
    .refs-panel.open{ display:block }
    .ref-tag{
      display:inline-block; min-width:18px; text-align:center; font-weight:700;
      border:1px solid #4169E1; color:#4169E1; border-radius:4px; padding:0 3px; margin:0 4px
    }
    .autolinks{ display:grid; grid-template-columns: 1fr 1fr; gap:6px; margin:10px 0 6px }
    .autolinks label{ display:flex; gap:8px; align-items:center; font-size:0.86em }
  </style>
</head>
<body>
  <div class="container">
    <div class="game-area">
      <div class="narrative-banner" id="narrativeBanner">
        Welcome to EconoVille! Watch how the economy shapes daily life.
      </div>
      <canvas id="gameCanvas" width="800" height="600"></canvas>

      <div class="legend">
        <div class="legend-item"><div class="legend-icon" style="background:#228B22"></div><span>Open Shop</span></div>
        <div class="legend-item"><div class="legend-icon" style="background:#8B4513"></div><span>Closed Shop</span></div>
        <div class="legend-item"><div class="legend-icon" style="background:#B0B0B0"></div><span>Factory Smoke</span></div>
        <div class="legend-item"><div class="legend-icon" style="background:#32CD32"></div><span>Healthy Crops</span></div>
      </div>
    </div>

    <aside class="controls">
      <div class="resize-handle" id="resizeHandle"></div>
      <h2 style="text-align:center; color:#2E8B57; margin-bottom:12px">Economic Controls</h2>

      <div class="preset-buttons">
        <button id="presetBoom">Boom</button>
        <button id="presetRecession">Recession</button>
        <button id="presetStagflation">Stagflation</button>
        <button id="btnReset">Reset</button>
      </div>

      <div class="scenario-tip" id="scenarioTip">Select a preset to see different economic scenarios play out!</div>

      <div class="status-row">
        <div><strong>Status:</strong> <span id="statusSummary">Economy loading...</span></div>
        <div style="margin-top:4px"><span id="quickStats">Capacity: --% | Closures: --% | Activity: --%</span></div>
      </div>

      <div class="control-group">
        <label>Auto-links (rules & stabilisers)</label>
        <div class="autolinks">
          <label><input type="checkbox" id="autoOkun" checked/> Okun link (GDP→Unemp)</label>
          <label><input type="checkbox" id="autoPhillips" checked/> Phillips link (gap→π)</label>
          <label><input type="checkbox" id="autoTaylor" checked/> Taylor rule (π,gap→i)</label>
          <label><input type="checkbox" id="autoOil" checked/> Oil pass-through (commodities→π)</label>
          <label><input type="checkbox" id="autoStab" checked/> Auto stabilisers (fiscal cushion)</label>
        </div>
        <div style="font-size:0.8em;color:#666">Pedagogical links (not forecasts). Uncheck to disable coupling.</div>
      </div>

      <div class="reasoning-bar">
        <header>
          <strong>Reasoning</strong>
          <button id="toggleRefs" type="button" class="debug-toggle" style="width:auto;background:#E6F3FF;color:#2E8B57;border:1px solid #B0C4DE">
            Sources
          </button>
        </header>
        <ol id="reasoningList" class="reasoning-list"></ol>
        <div id="refsPanel" class="refs-panel"></div>
      </div>

      <div class="control-group">
        <label for="gdpGrowth">GDP Growth (%)</label>
        <div class="slider-container">
          <input type="range" id="gdpGrowth" min="-5" max="8" step="0.1" value="1.8"/>
          <span class="value-display" id="gdpValue">1.8%</span>
        </div>
      </div>

      <div class="control-group">
        <label for="unemployment">Unemployment (%)</label>
        <div class="slider-container">
          <input type="range" id="unemployment" min="2" max="15" step="0.1" value="5.2"/>
          <span class="value-display" id="unemploymentValue">5.2%</span>
        </div>
      </div>

      <div class="control-group">
        <label for="inflation">Inflation (%)</label>
        <div class="slider-container">
          <input type="range" id="inflation" min="0" max="12" step="0.1" value="3.0"/>
          <span class="value-display" id="inflationValue">3.0%</span>
        </div>
      </div>

      <div class="control-group">
        <label for="interestRate">Interest Rate (%)</label>
        <div class="slider-container">
          <input type="range" id="interestRate" min="0" max="10" step="0.1" value="4.0"/>
          <span class="value-display" id="interestRateValue">4.0%</span>
        </div>
      </div>

      <div class="control-group">
        <label for="commodityIndex">Commodity Index</label>
        <div class="slider-container">
          <input type="range" id="commodityIndex" min="80" max="200" step="1" value="120"/>
          <span class="value-display" id="commodityValue">120</span>
        </div>
      </div>

      <div class="control-group">
        <label for="exports">Exports Growth (%)</label>
        <div class="slider-container">
          <input type="range" id="exports" min="-5" max="10" step="0.1" value="0.5"/>
          <span class="value-display" id="exportsValue">0.5%</span>
        </div>
      </div>

      <div class="control-group">
        <label for="shock">Economic Shock</label>
        <select id="shock" style="width:100%; padding:6px">
          <option value="">None</option>
          <option value="oil_shock">Oil Crisis</option>
          <option value="supply_chain">Supply Chain Disruption</option>
          <option value="policy_tightening">Policy Tightening</option>
        </select>
      </div>

      <button id="glossaryBtn" class="glossary-toggle">Economic Terms</button>
      <div class="glossary" id="glossary">
        <div><span class="glossary-term">GDP Growth:</span> How fast total output is changing.</div>
        <div><span class="glossary-term">Unemployment:</span> Share of workers without jobs.</div>
        <div><span class="glossary-term">Inflation:</span> Rate at which prices rise.</div>
        <div><span class="glossary-term">Interest Rate:</span> Cost of borrowing.</div>
        <div><span class="glossary-term">Commodity Index:</span> Prices for inputs like oil or grain.</div>
        <div><span class="glossary-term">Exports:</span> Goods sold abroad.</div>
      </div>

      <div class="debug-panel">
        <button id="debugBtn" class="debug-toggle">Mapping Debug</button>
        <div class="debug-content" id="debugContent"><div id="debugStats"></div></div>
      </div>
    </aside>
  </div>

  <div id="tooltip" class="tooltip"></div>

  <script>
    const clamp = (lo, hi, x) => Math.max(lo, Math.min(hi, x));
    const lerp = (a,b,t) => a + (b-a)*t;

    const MODEL = {
      potential_growth: 2.0,
      u_star: 5.0,
      pi_target: 2.0,
      phillips_kappa: 0.30,
      exports_scale: 5.0,
      commodity_base: 120,
      commodity_norm: 100,
      closures_sens_u: 0.15,
      closures_sens_prices: 0.10,
      closures_offset_gap: 0.05,
      gap_sens_factory: 0.35,
      exports_sens_factory: 0.25,
      energy_sens_factory: 0.25,
      gap_sens_conf: 0.45,
      u_slack_sens_conf: 0.30,
      real_rate_housing_sens: 0.12,
      u_slack_sens_housing: 0.10
    };

    const DEFAULT_ECONOMY = {
      gdp_growth_pct: 1.8,
      unemployment_pct: 5.2,
      inflation_pct: 3.0,
      interest_rate_pct: 4.0,
      commodity_index: 120,
      exports_pct_growth: 0.5,
      trend: { gdp: 'flat', inflation: 'down' },
      shock: null
    };

    const PRESETS = {
      boom: {
        gdp_growth_pct: 4.5, unemployment_pct: 3.8, inflation_pct: 2.1,
        interest_rate_pct: 2.5, commodity_index: 140, exports_pct_growth: 6.2,
        trend: { gdp:'up', inflation:'flat' }, shock: null,
        tip: "Boom time! Low unemployment and strong growth create a bustling economy."
      },
      recession: {
        gdp_growth_pct: -2.1, unemployment_pct: 9.8, inflation_pct: 1.2,
        interest_rate_pct: 0.5, commodity_index: 95, exports_pct_growth: -3.4,
        trend: { gdp:'down', inflation:'down' }, shock: null,
        tip: "Economic downturn: job losses and business closures across the village."
      },
      stagflation: {
        gdp_growth_pct: 0.2, unemployment_pct: 8.1, inflation_pct: 7.8,
        interest_rate_pct: 6.5, commodity_index: 160, exports_pct_growth: -1.2,
        trend: { gdp:'flat', inflation:'up' }, shock: 'oil_shock',
        tip: "Stagflation: weak growth + high inflation squeezes everyone."
      }
    };

    const REFS = [
      {id:'PHILLIPS_FED', label:'Phillips curve (St. Louis Fed explainer)', url:'https://www.stlouisfed.org/open-vault/2020/january/what-is-phillips-curve-why-flattened'},
      {id:'PHILLIPS_FOMC_2025', label:'Phillips curve remarks (Fed Board speech, 2025)', url:'https://www.federalreserve.gov/newsevents/speech/kugler20250220a.htm'},
      {id:'NAIRU_RBA', label:'NAIRU explainer (RBA)', url:'https://www.rba.gov.au/education/resources/explainers/nairu.html'},
      {id:'OKUN_CLEVELAND', label:'Okun\'s law (Cleveland Fed commentary)', url:'https://www.clevelandfed.org/publications/economic-commentary/2012/ec-201208-an-unstable-okuns-law-not-the-best-rule-of-thumb'},
      {id:'TAYLOR_1993', label:'Taylor (1993): Discretion vs Policy Rules', url:'https://web.stanford.edu/~johntayl/Onlinepaperscombinedbyyear/1993/Discretion_versus_Policy_Rules_in_Practice.pdf'},
      {id:'TAYLOR_ATL_FED', label:'Taylor rule (Atlanta Fed explainer)', url:'https://www.atlantafed.org/cqer/research/taylor-rule'},
      {id:'OECD_STABS', label:'OECD (2020): Automatic fiscal stabilisers', url:'https://www.oecd.org/content/dam/oecd/en/publications/reports/2020/12/automatic-fiscal-stabilisers-recent-evolution-and-policy-options-to-boost-their-effectiveness_7d1ca7ac/816b1b06-en.pdf'},
      {id:'ECB_STABS', label:'ECB (2020): Automatic stabilisers explainer', url:'https://www.ecb.europa.eu/press/economic-bulletin/articles/2020/html/ecb.ebart202006_03~3175750a6d.en.html'}
    ];

    const SETTINGS = {
      autoOkun: true,
      autoPhillips: true,
      autoTaylor: true,
      autoOil: true,
      autoStab: true
    };

    const COEFF = {
      okun: -0.5,
      phillipsBlend: 0.35,
      oilPiPer10pts: 0.12,
      taylor_rstar: 0.8,
      taylor_phi_pi: 0.5,
      taylor_phi_y: 0.5,
      stabiliserShare: 0.30
    };

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const VILLAGE_WIDTH = 20, VILLAGE_HEIGHT = 15;
    let TILE_SIZE = 40;
    let controlsWidth = 320;

    function resizeCanvas(){
      const sidebarWidth = controlsWidth;
      const w = Math.max(520, window.innerWidth - sidebarWidth - 24);
      const h = Math.max(420, window.innerHeight - 24);
      TILE_SIZE = Math.floor(Math.min(w / VILLAGE_WIDTH, h / VILLAGE_HEIGHT));
      canvas.width = TILE_SIZE * VILLAGE_WIDTH;
      canvas.height = TILE_SIZE * VILLAGE_HEIGHT;
    }

    function initResizeHandle(){
      const resizeHandle = document.getElementById('resizeHandle');
      const controls = document.querySelector('.controls');
      let isResizing = false;

      resizeHandle.addEventListener('mousedown', (e) => {
        isResizing = true;
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });

      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        
        const containerWidth = window.innerWidth;
        const newWidth = containerWidth - e.clientX;
        const clampedWidth = Math.max(250, Math.min(500, newWidth));
        
        controlsWidth = clampedWidth;
        controls.style.width = clampedWidth + 'px';
        resizeCanvas();
      });

      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });

      window.addEventListener('resize', resizeCanvas);
    }

    const villageLayout = [
      ['farm','farm','farm','farm','road','housing','housing','housing','road','farm','farm','farm','farm','road','housing','housing','housing','housing','housing','housing'],
      ['farm','farm','farm','farm','road','housing','housing','housing','road','farm','farm','farm','farm','road','housing','housing','housing','housing','housing','housing'],
      ['farm','farm','farm','farm','road','housing','housing','housing','road','farm','farm','farm','farm','road','housing','housing','housing','housing','housing','housing'],
      ['road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road'],
      ['industry','industry','industry','road','retail','retail','retail','retail','road','square','square','square','road','retail','retail','retail','retail','industry','industry','industry'],
      ['industry','industry','industry','road','retail','retail','retail','retail','road','square','square','square','road','retail','retail','retail','retail','industry','industry','industry'],
      ['industry','industry','industry','road','retail','retail','retail','retail','road','square','square','square','road','retail','retail','retail','retail','industry','industry','industry'],
      ['road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road'],
      ['housing','housing','housing','road','retail','retail','retail','retail','road','industry','industry','industry','road','farm','farm','farm','farm','farm','farm','farm'],
      ['housing','housing','housing','road','retail','retail','retail','retail','road','industry','industry','industry','road','farm','farm','farm','farm','farm','farm','farm'],
      ['housing','housing','housing','road','retail','retail','retail','retail','road','industry','industry','industry','road','farm','farm','farm','farm','farm','farm','farm'],
      ['road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road'],
      ['farm','farm','farm','farm','housing','housing','housing','housing','road','retail','retail','retail','road','industry','industry','industry','industry','industry','industry','industry'],
      ['farm','farm','farm','farm','housing','housing','housing','housing','road','retail','retail','retail','road','industry','industry','industry','industry','industry','industry','industry'],
      ['farm','farm','farm','farm','housing','housing','housing','housing','road','retail','retail','retail','road','industry','industry','industry','industry','industry','industry','industry']
    ];

    const retailTiles = [];
    for(let y=0;y<VILLAGE_HEIGHT;y++){
      for(let x=0;x<VILLAGE_WIDTH;x++){
        if(villageLayout[y][x]==='retail'){ retailTiles.push({x,y}); }
      }
    }
    const retailState = new Map();

    function computeEconomicState(e){
      const gap_raw = e.gdp_growth_pct - MODEL.potential_growth;
      const gap_norm = gap_raw / 4.0;
      const u_slack = Math.max(0, e.unemployment_pct - MODEL.u_star) / 5.0;
      const pi_expected = MODEL.pi_target + MODEL.phillips_kappa * gap_raw;
      const supply_shock = Math.max(0, e.inflation_pct - pi_expected);
      const price_pressure = clamp(0,1,(e.inflation_pct - 4) / 8);
      const r_real = e.interest_rate_pct - e.inflation_pct;
      const exports_n = e.exports_pct_growth / MODEL.exports_scale;
      const energy_shock = Math.max(0,(e.commodity_index - MODEL.commodity_base)/60);
      const agri_tailwind = (e.commodity_index - 100) / MODEL.commodity_norm;

      const shops_closed_rate = clamp(
        0, 0.85,
        MODEL.closures_sens_u * u_slack
        + MODEL.closures_sens_prices * clamp(0,1, supply_shock/6)
        - MODEL.closures_offset_gap * gap_norm
      );

      const factory_capacity = clamp(
        0.20, 1.00,
        0.60 + MODEL.gap_sens_factory*gap_norm + MODEL.exports_sens_factory*exports_n - MODEL.energy_sens_factory*energy_shock
      );

      const citizen_activity = clamp(
        0.30, 1.50,
        1.00 + MODEL.gap_sens_conf*gap_norm - MODEL.u_slack_sens_conf*u_slack
      );

      const farm_productivity = clamp(
        0.20, 1.00,
        0.50 + 0.40*agri_tailwind - 0.20*energy_shock + 0.20*exports_n
      );

      let housing_activity = clamp(
        0.20, 1.00,
        1.00 - MODEL.real_rate_housing_sens*Math.max(0,r_real) - MODEL.u_slack_sens_housing*u_slack + 0.08*gap_norm
      );

      let vehicle_activity = 1.0, warehouse_congestion = 0.0, shock_effect = e.shock || 'none';
      if(e.shock==='oil_shock'){ vehicle_activity *= 0.4; }
      if(e.shock==='supply_chain'){ warehouse_congestion = 1.0; }
      if(e.shock==='policy_tightening'){ housing_activity *= 0.6; }

      return {
        shops_closed_rate,
        factory_capacity,
        citizen_activity,
        farm_productivity,
        housing_activity,
        price_pressure: clamp(0,1, price_pressure),
        vehicle_activity,
        warehouse_congestion,
        shock_effect
      };
    }

    let currentEconomy = {...DEFAULT_ECONOMY};
    let computedState = {};
    let oldComputedState = {};
    let tweenProgress = 1, isTransitioning = false, animationFrame = 0;

    let citizens = [];
    function initializeCitizens(){
      citizens.length = 0;
      for(let i=0;i<28;i++){
        citizens.push({
          x: Math.random()*canvas.width,
          y: Math.random()*canvas.height,
          targetX: Math.random()*canvas.width,
          targetY: Math.random()*canvas.height,
          speed: 0.6 + Math.random()*0.9,
          frame: Math.floor(Math.random()*3),
          frameTimer: 0
        });
      }
    }

    function drawCitizen(c,state){
      const sp = c.speed * state.citizen_activity;
      const dx = c.targetX - c.x, dy = c.targetY - c.y;
      const dist = Math.hypot(dx,dy);
      if(dist > sp){
        c.x += (dx/dist)*sp; c.y += (dy/dist)*sp;
      }else{
        c.x = c.targetX; c.y = c.targetY;
        c.targetX = Math.random()*canvas.width;
        c.targetY = Math.random()*canvas.height;
      }
      c.frameTimer += sp;
      if(c.frameTimer > 10){ c.frame=(c.frame+1)%3; c.frameTimer=0; }
      ctx.fillStyle = ['#FF69B4','#87CEEB','#98FB98'][c.frame];
      ctx.beginPath(); 
      ctx.arc(Math.round(c.x), Math.round(c.y), 3, 0, Math.PI*2); 
      ctx.fill();
    }

    function drawTile(x,y,type,state){
      const px = x*TILE_SIZE, py = y*TILE_SIZE;
      switch(type){
        case 'road': {
          ctx.fillStyle='#696969'; 
          ctx.fillRect(px,py,TILE_SIZE,TILE_SIZE);
          ctx.strokeStyle='#FFFF00'; 
          ctx.lineWidth=2; 
          ctx.setLineDash([5,5]);
          if(x%2===0){ 
            ctx.beginPath(); 
            ctx.moveTo(px, py+TILE_SIZE/2); 
            ctx.lineTo(px+TILE_SIZE, py+TILE_SIZE/2); 
            ctx.stroke(); 
          }
          ctx.setLineDash([]); 
          break;
        }
        case 'farm': {
          const prod = state.farm_productivity;
          const g = Math.floor(50 + prod*150);
          ctx.fillStyle = 'rgb(34,' + g + ',34)';
          ctx.fillRect(px,py,TILE_SIZE,TILE_SIZE);
          if(prod>0.7 && ((x+y)%4===0)){ 
            ctx.fillStyle='#654321'; 
            ctx.fillRect(px+15, py+2, 6, 15);
            const cap = state.factory_capacity;
            if(cap>0.3){
              ctx.fillStyle = 'rgba(128,128,128,' + (cap*0.7) + ')';
              for(let i=0;i<Math.floor(cap*5);i++){
                ctx.beginPath(); 
                ctx.arc(px+18 + Math.random()*4, py - i*3, 2, 0, Math.PI*2); 
                ctx.fill();
              }
            }
          }
          break;
        }
        case 'retail': {
          const key = x + ',' + y;
          const rs = retailState.get(key) || {closed:false, priceTag:false};
          ctx.fillStyle = rs.closed ? '#654321' : '#228B22';
          ctx.fillRect(px,py,TILE_SIZE,TILE_SIZE);
          ctx.fillStyle = rs.closed ? '#8B4513' : '#32CD32';
          ctx.fillRect(px+3, py+3, TILE_SIZE-6, TILE_SIZE-6);
          if(rs.closed){
            ctx.fillStyle='#FFFF00'; 
            ctx.fillRect(px+5, py+8, 12, 6);
            ctx.fillStyle='#000'; 
            ctx.font='8px Arial'; 
            ctx.fillText('LEASE', px+6, py+12);
          }
          break;
        }
        case 'housing': {
          ctx.fillStyle='#DEB887'; 
          ctx.fillRect(px,py,TILE_SIZE,TILE_SIZE);
          ctx.fillStyle='#8B4513'; 
          ctx.fillRect(px+8, py+8, TILE_SIZE-16, TILE_SIZE-16);
          if(state.housing_activity < 0.5 && Math.random() < (0.8 - state.housing_activity)){
            ctx.fillStyle='#FFFF00'; 
            ctx.fillRect(px+2, py+20, 10, 8);
            ctx.fillStyle='#000'; 
            ctx.font='6px Arial'; 
            ctx.fillText('SALE', px+3, py+26);
          }
          break;
        }
        case 'square': {
          ctx.fillStyle='#98FB98'; 
          ctx.fillRect(px,py,TILE_SIZE,TILE_SIZE);
          if(x===10 && y===5){
            ctx.fillStyle='#4169E1'; 
            ctx.beginPath();
            ctx.arc(px + TILE_SIZE/2, py + TILE_SIZE/2, 8, 0, Math.PI*2); 
            ctx.fill();
          }
          break;
        }
        default:
          ctx.fillStyle='#90EE90'; 
          ctx.fillRect(px,py,TILE_SIZE,TILE_SIZE);
      }
    }

    function recomputeRetailState(state){
      retailState.clear();
      for(const tile of retailTiles){
        const closed = Math.random() < state.shops_closed_rate;
        const priceTag = !closed && state.price_pressure>0.3 && Math.random() < state.price_pressure;
        retailState.set(tile.x + ',' + tile.y, {closed, priceTag});
      }
    }

    function getCurrentState(){
      if(!isTransitioning || tweenProgress>=1) return computedState;
      const cur = {};
      for(const k in computedState){
        if(typeof computedState[k]==='number' && typeof oldComputedState[k]==='number'){
          cur[k] = lerp(oldComputedState[k], computedState[k], tweenProgress);
        }else{
          cur[k] = computedState[k];
        }
      }
      return cur;
    }

    function render(){
      ctx.clearRect(0,0,canvas.width, canvas.height);
      const s = getCurrentState();

      for(let y=0;y<VILLAGE_HEIGHT;y++){
        for(let x=0;x<VILLAGE_WIDTH;x++){
          drawTile(x,y,villageLayout[y][x], s);
        }
      }

      const nC = Math.min(citizens.length, Math.floor(citizens.length * s.citizen_activity));
      for(let i=0;i<nC;i++) drawCitizen(citizens[i], s);
    }

    const els = {
      gdp: document.getElementById('gdpGrowth'),
      u: document.getElementById('unemployment'),
      pi: document.getElementById('inflation'),
      i: document.getElementById('interestRate'),
      com: document.getElementById('commodityIndex'),
      ex: document.getElementById('exports'),
      shock: document.getElementById('shock'),
      gdpV: document.getElementById('gdpValue'),
      uV: document.getElementById('unemploymentValue'),
      piV: document.getElementById('inflationValue'),
      iV: document.getElementById('interestRateValue'),
      comV: document.getElementById('commodityValue'),
      exV: document.getElementById('exportsValue'),
      scenarioTip: document.getElementById('scenarioTip'),
      narrative: document.getElementById('narrativeBanner'),
      statusSummary: document.getElementById('statusSummary'),
      quickStats: document.getElementById('quickStats'),
      debugBtn: document.getElementById('debugBtn'),
      debugContent: document.getElementById('debugContent'),
      debugStats: document.getElementById('debugStats'),
      glossaryBtn: document.getElementById('glossaryBtn'),
      glossary: document.getElementById('glossary'),
      presetBoom: document.getElementById('presetBoom'),
      presetRecession: document.getElementById('presetRecession'),
      presetStagflation: document.getElementById('presetStagflation'),
      btnReset: document.getElementById('btnReset'),
      reasoningList: document.getElementById('reasoningList'),
      refsPanel: document.getElementById('refsPanel'),
      toggleRefs: document.getElementById('toggleRefs')
    };

    function updateSliderDisplays(){
      els.gdpV.textContent = currentEconomy.gdp_growth_pct.toFixed(1)+'%';
      els.uV.textContent   = currentEconomy.unemployment_pct.toFixed(1)+'%';
      els.piV.textContent  = currentEconomy.inflation_pct.toFixed(1)+'%';
      els.iV.textContent   = currentEconomy.interest_rate_pct.toFixed(1)+'%';
      els.comV.textContent = String(currentEconomy.commodity_index);
      els.exV.textContent  = currentEconomy.exports_pct_growth.toFixed(1)+'%';
    }

    function updateEconomy(){
      oldComputedState = {...computedState};
      computedState = computeEconomicState(currentEconomy);
      recomputeRetailState(computedState);
      tweenProgress = 0; 
      isTransitioning = true;
      updateNarrative();
      updateDebugPanel();
    }

    function updateNarrative(){
      const s = computedState;
      let msg = 'Steady as she goes.';
      if(s.citizen_activity>1.1) msg = 'Boom time! Factory near ' + (s.factory_capacity*100|0) + '% capacity.';
      else if(s.citizen_activity<0.6) msg = 'Tough times. ' + (s.shops_closed_rate*100|0) + '% shops shuttered; streets quiet.';
      else if(s.price_pressure>0.4) msg = 'Inflation squeeze: retailers post price hikes; foot traffic softens.';
      else if(s.factory_capacity<0.4) msg = 'Industrial slowdown: plants idling as demand weakens.';
      els.narrative.textContent = msg;

      els.statusSummary.textContent = s.citizen_activity>1.0 ? 'Booming' : (s.citizen_activity<0.6 ? 'Struggling' : 'Stable');
      els.quickStats.textContent = 'Capacity: ' + (s.factory_capacity*100|0) + '% | Closures: ' + (s.shops_closed_rate*100|0) + '% | Activity: ' + (s.citizen_activity*100|0) + '%';
    }

    function updateDebugPanel(){
      const s = computedState;
      const lines = [
        'shops_closed_rate: ' + s.shops_closed_rate.toFixed(2) + ' (' + (s.shops_closed_rate*100|0) + '%)',
        'factory_capacity: ' + s.factory_capacity.toFixed(2) + ' (' + (s.factory_capacity*100|0) + '%)',
        'citizen_activity: ' + s.citizen_activity.toFixed(2) + ' (' + (s.citizen_activity*100|0) + '%)',
        'farm_productivity: ' + s.farm_productivity.toFixed(2) + ' (' + (s.farm_productivity*100|0) + '%)',
        'housing_activity: ' + s.housing_activity.toFixed(2) + ' (' + (s.housing_activity*100|0) + '%)',
        'price_pressure: ' + s.price_pressure.toFixed(2) + ' (' + (s.price_pressure*100|0) + '%)',
        'shock_effect: ' + s.shock_effect
      ];
      els.debugStats.innerHTML = lines.join('<br>');
    }

    function renderRefsPanel(){
      if(!els.refsPanel || els.refsPanel.dataset.rendered) return;
      els.refsPanel.innerHTML = REFS.map((r,i) => 
        '<div><span class="ref-tag">' + (i+1) + '</span>' +
        '<a href="' + r.url + '" target="_blank" rel="noopener">' + r.label + '</a>' +
        '</div>'
      ).join('');
      els.refsPanel.dataset.rendered = '1';
    }

    function updateEconomyFromUI(ev){
      currentEconomy.gdp_growth_pct      = parseFloat(els.gdp.value);
      currentEconomy.unemployment_pct    = parseFloat(els.u.value);
      currentEconomy.inflation_pct       = parseFloat(els.pi.value);
      currentEconomy.interest_rate_pct   = parseFloat(els.i.value);
      currentEconomy.commodity_index     = parseInt(els.com.value,10);
      currentEconomy.exports_pct_growth  = parseFloat(els.ex.value);
      currentEconomy.shock               = els.shock.value || null;
      
      updateEconomy();
      updateSliderDisplays();
    }

    [els.gdp,els.u,els.pi,els.i,els.com,els.ex].forEach(el => {
      el.addEventListener('input', updateEconomyFromUI);
    });
    els.shock.addEventListener('change', updateEconomyFromUI);

    function applyPreset(name){
      const p = PRESETS[name]; 
      if(!p) return;
      currentEconomy = {...p};
      els.gdp.value = p.gdp_growth_pct;
      els.u.value   = p.unemployment_pct;
      els.pi.value  = p.inflation_pct;
      els.i.value   = p.interest_rate_pct;
      els.com.value = p.commodity_index;
      els.ex.value  = p.exports_pct_growth;
      els.shock.value = p.shock || '';
      els.scenarioTip.textContent = p.tip;
      updateEconomy(); 
      updateSliderDisplays();
    }

    function resetEconomy(){
      currentEconomy = {...DEFAULT_ECONOMY};
      els.gdp.value = DEFAULT_ECONOMY.gdp_growth_pct;
      els.u.value   = DEFAULT_ECONOMY.unemployment_pct;
      els.pi.value  = DEFAULT_ECONOMY.inflation_pct;
      els.i.value   = DEFAULT_ECONOMY.interest_rate_pct;
      els.com.value = DEFAULT_ECONOMY.commodity_index;
      els.ex.value  = DEFAULT_ECONOMY.exports_pct_growth;
      els.shock.value = '';
      els.scenarioTip.textContent = 'Select a preset to see different economic scenarios play out!';
      updateEconomy(); 
      updateSliderDisplays();
    }

    els.presetBoom.addEventListener('click', () => applyPreset('boom'));
    els.presetRecession.addEventListener('click', () => applyPreset('recession'));
    els.presetStagflation.addEventListener('click', () => applyPreset('stagflation'));
    els.btnReset.addEventListener('click', resetEconomy);

    els.debugBtn.addEventListener('click', () => { 
      els.debugContent.classList.toggle('open'); 
    });
    els.glossaryBtn.addEventListener('click', () => { 
      els.glossary.classList.toggle('open'); 
    });
    els.toggleRefs.addEventListener('click', () => {
      renderRefsPanel();
      els.refsPanel.classList.toggle('open');
    });

    function animate(){
      animationFrame++;
      if(isTransitioning){
        tweenProgress += 0.03;
        if(tweenProgress>=1){ 
          tweenProgress=1; 
          isTransitioning=false; 
        }
      }
      render();
      requestAnimationFrame(animate);
    }

    function init(){
      resizeCanvas();
      initResizeHandle();
      initializeCitizens();
      computedState = computeEconomicState(currentEconomy);
      recomputeRetailState(computedState);
      updateSliderDisplays();
      updateNarrative();
      updateDebugPanel();
      renderRefsPanel();
      els.refsPanel.classList.remove('open');
      requestAnimationFrame(animate);
    }

    init();
  </script>
</body>
</html>
