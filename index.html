<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EconoVille – Enhanced Macroeconomic Village Simulator</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg,#87CEEB,#98FB98);
      color:#333; overflow:auto;
    }
    .container{display:flex; height:100vh}
    .game-area{flex:1; position:relative; min-width:0}
    #gameCanvas{
      border:2px solid #8B4513; background:#90EE90; display:block;
      width:100%; height:auto; max-width:100%;
      image-rendering: pixelated; image-rendering: crisp-edges;
      cursor: crosshair;
    }
    .narrative-banner{
      position:absolute; top:10px; left:10px; z-index:10;
      background:rgba(255,255,255,0.92); border:2px solid #4169E1;
      border-radius:8px; padding:10px 14px; max-width:420px;
      font-weight:bold; color:#2E8B57;
    }
    .legend{
      position:absolute; bottom:10px; left:10px; z-index:10;
      background:rgba(255,255,255,0.9); border:1px solid #DDD;
      border-radius:6px; padding:10px; font-size:0.85em;
    }
    .legend-item{display:flex; align-items:center; gap:8px; margin:4px 0}
    .legend-icon{width:16px; height:16px; border:1px solid #666}
    
    .gdp-components{
      position:absolute; bottom:10px; right:10px; z-index:10;
      background:rgba(255,255,255,0.95); border:2px solid #2E8B57;
      border-radius:8px; padding:12px; min-width:200px; font-size:0.85em;
    }
    .gdp-header{
      font-weight:bold; color:#2E8B57; text-align:center; margin-bottom:8px;
      font-size:1.1em; border-bottom:1px solid #B0C4DE; padding-bottom:4px;
    }
    .gdp-breakdown{display:flex; flex-direction:column; gap:4px}
    .gdp-item{display:flex; justify-content:space-between; align-items:center}
    .gdp-total{
      display:flex; justify-content:space-between; align-items:center;
      border-top:1px solid #B0C4DE; padding-top:6px; margin-top:4px;
      font-weight:bold; color:#2E4B8C;
    }
    .gdp-label{color:#555; font-size:0.9em}
    .gdp-value{
      font-weight:bold; color:#2E8B57; font-family:monospace;
      background:#E6F3FF; padding:2px 6px; border-radius:4px; min-width:50px; text-align:right;
    }
    .gdp-total .gdp-value{background:#D4EDDA; color:#155724}
    
    .controls{
      width:400px; background:rgba(255,255,255,0.96);
      padding:18px 20px; border-left:2px solid #8B4513; overflow-y:auto;
    }
    .preset-buttons{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:14px}
    button{
      padding:8px 12px; border:2px solid #4169E1; border-radius:6px;
      background:#87CEEB; color:#fff; font-weight:bold; cursor:pointer;
      transition:transform .15s, background .15s;
    }
    button:hover{background:#4169E1; transform:translateY(-1px)}
    .scenario-tip{
      background:#FFF8DC; border:1px solid #DDA0DD; border-radius:6px;
      padding:10px; margin:8px 0 12px; color:#8B4513; font-size:0.9em;
    }
    .status-row{
      background:#E6F3FF; border-radius:6px; padding:8px; font-size:0.85em; margin:10px 0;
    }
    .control-group{margin:12px 0}
    .control-group label{display:block; font-weight:bold; color:#2E8B57; margin-bottom:6px}
    .slider-container{display:flex; align-items:center; gap:10px}
    input[type="range"]{flex:1; height:6px; border-radius:3px; background:#ddd; outline:none}
    .value-display{min-width:56px; text-align:right; font-weight:bold; color:#4169E1}
    .debug-panel{margin-top:14px; background:#F0F8FF; border:1px solid #B0C4DE; border-radius:6px}
    .debug-toggle{width:100%; background:#B0C4DE; border:none; padding:8px; font-weight:bold; cursor:pointer}
    .debug-content{display:none; padding:10px; font-family:monospace; font-size:0.85em}
    .debug-content.open{display:block}
    .glossary{display:none; background:#F5F5F5; border:1px solid #DDD; border-radius:6px; padding:10px; margin-top:10px; font-size:0.88em}
    .glossary.open{display:block}
    .glossary-term{font-weight:bold; color:#4169E1}
    .tooltip{
      position:absolute; pointer-events:none; z-index:100;
      max-width:260px; background:rgba(0,0,0,0.92); color:#fff;
      padding:8px 10px; border-radius:6px; font-size:0.9em; opacity:0; transition:opacity .15s;
    }
    .tooltip.visible{opacity:1}

    .help-icon{
      display:inline-block; width:16px; height:16px; border-radius:50%;
      background:#87CEEB; color:#fff; text-align:center; line-height:16px;
      font-size:10px; margin-left:6px; cursor:help;
    }
    .help-icon:hover{background:#4169E1; transform:scale(1.1)}
    .beginner-tip{
      font-size:0.8em; color:#666; margin-top:4px; font-style:italic;
      padding:4px 8px; background:#F8F9FA; border-left:3px solid #87CEEB; border-radius:4px;
    }
    
    .auto-indicator{
      display:inline-block; margin-left:8px; padding:2px 6px; border-radius:10px;
      font-size:0.7em; font-weight:bold; background:#E6F3FF; color:#2E8B57;
      animation:pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse{
      0%, 100%{opacity:0.6; transform:scale(1)}
      50%{opacity:1; transform:scale(1.05)}
    }

    .auto-toggle{
      background:#E8F5E8; border:1px solid #90EE90; border-radius:6px;
      padding:8px; margin:8px 0; display:flex; align-items:center; gap:8px;
    }
    .auto-toggle input[type="checkbox"]{margin:0}
    .auto-toggle label{margin:0; font-size:0.9em; color:#2E8B57; cursor:pointer}

    .reasoning-bar{
      background:#fff; border:1px solid #B0C4DE; border-radius:8px;
      padding:14px; margin:12px 0; font-size:0.9em; line-height:1.4;
    }
    .reasoning-section{margin-bottom:16px}
    .reasoning-section:last-child{margin-bottom:0}
    .reasoning-title{font-weight:bold; color:#2E8B57; margin-bottom:8px; font-size:0.95em}
    .reasoning-content{margin-left:12px; color:#333}
    .reasoning-step{margin:8px 0; padding-left:16px; position:relative}
    .reasoning-step:before{
      content:"→"; position:absolute; left:0; color:#4169E1; font-weight:bold;
    }
    .economic-value{
      background:#E6F3FF; padding:2px 6px; border-radius:4px; 
      font-weight:bold; color:#2E4B8C; font-family:monospace;
    }

    .time-controls{
      background:#F0F8FF; border:1px solid #B0C4DE; border-radius:6px;
      padding:10px; margin:8px 0;
    }
    .time-controls label{margin-bottom:4px !important; font-size:0.9em}
    .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .mini{font-size:0.85em; color:#555}

    .sparklines{display:grid; grid-template-columns:1fr; gap:8px}
    .spark-card{background:#fff; border:1px solid #e6e6e6; border-radius:6px; padding:6px}
    .spark-title{font-weight:bold; margin-bottom:4px; color:#2E8B57; font-size:0.85em}
    .spark{width:100%; height:40px}
  </style>
</head>
<body>
  <div class="container">
    <div class="game-area">
      <div class="narrative-banner" id="narrativeBanner">
        Welcome to EconoVille! Watch how the economy shapes daily life.
      </div>
      <canvas id="gameCanvas" width="800" height="600"></canvas>

      <div class="legend">
        <div class="legend-item"><div class="legend-icon" style="background:#228B22"></div><span>Open Shop</span></div>
        <div class="legend-item"><div class="legend-icon" style="background:#8B4513"></div><span>Closed Shop</span></div>
        <div class="legend-item"><div class="legend-icon" style="background:#B0B0B0"></div><span>Factory Smoke</span></div>
        <div class="legend-item"><div class="legend-icon" style="background:#32CD32"></div><span>Healthy Crops</span></div>
        <div class="legend-item"><div class="legend-icon" style="background:linear-gradient(90deg,#d9534f,#5cb85c)"></div><span>GDP Growth</span></div>
      </div>

      <div class="gdp-components">
        <div class="gdp-header">GDP = C + I + G + NX</div>
        <div class="gdp-breakdown">
          <div class="gdp-item">
            <span class="gdp-label">Consumption:</span>
            <span class="gdp-value" id="consumptionValue">65.0</span>
          </div>
          <div class="gdp-item">
            <span class="gdp-label">Investment:</span>
            <span class="gdp-value" id="investmentValue">20.0</span>
          </div>
          <div class="gdp-item">
            <span class="gdp-label">Government:</span>
            <span class="gdp-value" id="governmentValue">20.0</span>
          </div>
          <div class="gdp-item">
            <span class="gdp-label">Net Exports:</span>
            <span class="gdp-value" id="netExportsValue">-3.2</span>
          </div>
          <div class="gdp-total">
            <span class="gdp-label">Total GDP:</span>
            <span class="gdp-value" id="totalGDPValue">101.8</span>
          </div>
        </div>
      </div>
    </div>

    <aside class="controls">
      <h2 style="text-align:center; color:#2E8B57; margin-bottom:12px">Economic Controls</h2>

      <div class="auto-toggle">
        <input type="checkbox" id="autoAdjustEnabled" checked/>
        <label for="autoAdjustEnabled">Auto-adjust controls based on economic laws</label>
      </div>

      <div class="preset-buttons">
        <button id="presetBoom">Boom</button>
        <button id="presetRecession">Recession</button>
        <button id="presetStagflation">Stagflation</button>
        <button id="btnReset">Reset</button>
      </div>

      <div class="scenario-tip" id="scenarioTip">Select a preset to see different economic scenarios play out!</div>

      <div class="time-controls">
        <label>Simulation Controls</label>
        <div class="grid-2">
          <button id="simPlay" type="button">▶ Run</button>
          <button id="simPause" type="button">⏸ Pause</button>
        </div>
        <div style="margin-top:8px; display:flex; align-items:center; gap:10px">
          <span class="mini">Speed</span>
          <input id="simSpeed" type="range" min="1" max="5" step="1" value="2" style="flex:1"/>
          <span id="simSpeedValue" class="mini">2x</span>
        </div>
        <div class="mini" style="margin-top:6px">
          Time: <strong id="simClock">Month 0</strong>
        </div>
      </div>

      <div class="debug-panel">
        <button id="historyBtn" class="debug-toggle">Economic History</button>
        <div id="historyContent" class="debug-content">
          <div class="sparklines">
            <div class="spark-card">
              <div class="spark-title">GDP Growth (%)</div>
              <canvas id="chartGDP" class="spark" width="340" height="40"></canvas>
            </div>
            <div class="spark-card">
              <div class="spark-title">Inflation (%)</div>
              <canvas id="chartInfl" class="spark" width="340" height="40"></canvas>
            </div>
            <div class="spark-card">
              <div class="spark-title">Unemployment (%)</div>
              <canvas id="chartUnemp" class="spark" width="340" height="40"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="status-row">
        <div><strong>Status:</strong> <span id="statusSummary">Stable</span></div>
        <div style="margin-top:4px"><span id="quickStats">Capacity: 65% | Closures: 5% | Activity: 100%</span></div>
      </div>

      <div class="debug-panel">
        <button id="analysisToggle" class="debug-toggle">Economic Analysis</button>
        <div id="analysisContent" class="debug-content">
          <div class="reasoning-bar">
            <div id="reasoningContent">
              <div class="reasoning-section">
                <div class="reasoning-title">Current Economic State</div>
                <div class="reasoning-content">
                  <div class="reasoning-step">Economy operating at stable baseline conditions</div>
                  <div class="reasoning-step">All sectors performing within normal ranges</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="control-group">
        <label for="gdpGrowth">
          GDP Growth (%)
          <span class="help-icon" title="How fast the economy is growing">❓</span>
        </label>
        <div class="slider-container">
          <input type="range" id="gdpGrowth" min="-5" max="8" step="0.1" value="1.8"/>
          <span class="value-display" id="gdpValue">1.8%</span>
        </div>
        <div class="beginner-tip">How fast the economy is growing. Higher = more jobs, but can cause inflation.</div>
      </div>

      <div class="control-group">
        <label for="unemployment">
          Unemployment (%)
          <span class="help-icon" title="Percent of people without jobs">❓</span>
        </label>
        <div class="slider-container">
          <input type="range" id="unemployment" min="2" max="15" step="0.1" value="5.2"/>
          <span class="value-display" id="unemploymentValue">5.2%</span>
        </div>
        <div class="beginner-tip">Percent of people without jobs. Lower is better, but too low can overheat the economy.</div>
      </div>

      <div class="control-group">
        <label for="inflation">
          Inflation (%)
          <span class="help-icon" title="How fast prices rise">❓</span>
        </label>
        <div class="slider-container">
          <input type="range" id="inflation" min="0" max="12" step="0.1" value="3.0"/>
          <span class="value-display" id="inflationValue">3.0%</span>
        </div>
        <div class="beginner-tip">How fast prices rise. Around 2-3% is ideal. Too high hurts purchasing power.</div>
      </div>

      <div class="control-group">
        <label for="interestRate">
          Interest Rate (%)
          <span class="help-icon" title="Cost of borrowing money">❓</span>
        </label>
        <div class="slider-container">
          <input type="range" id="interestRate" min="0" max="10" step="0.1" value="4.0"/>
          <span class="value-display" id="interestRateValue">4.0%</span>
        </div>
        <div class="beginner-tip">Cost of borrowing money. Higher rates cool the economy, lower rates stimulate it.</div>
      </div>

      <div class="control-group">
        <label for="commodityIndex">
          Commodity Index
          <span class="help-icon" title="Prices of raw materials">❓</span>
        </label>
        <div class="slider-container">
          <input type="range" id="commodityIndex" min="80" max="200" step="1" value="120"/>
          <span class="value-display" id="commodityValue">120</span>
        </div>
        <div class="beginner-tip">Prices of raw materials like oil and grain. Higher = more expensive inputs.</div>
      </div>

      <div class="control-group">
        <label for="exports">
          Exports Growth (%)
          <span class="help-icon" title="Trade with other countries">❓</span>
        </label>
        <div class="slider-container">
          <input type="range" id="exports" min="-5" max="10" step="0.1" value="0.5"/>
          <span class="value-display" id="exportsValue">0.5%</span>
        </div>
        <div class="beginner-tip">How fast we're selling goods to other countries. Higher exports boost the economy.</div>
      </div>

      <div class="control-group">
        <label for="shock">Economic Shock</label>
        <select id="shock" style="width:100%; padding:6px">
          <option value="">None</option>
          <option value="oil_shock">Oil Crisis</option>
          <option value="supply_chain">Supply Chain Disruption</option>
          <option value="policy_tightening">Policy Tightening</option>
        </select>
      </div>

      <button id="glossaryBtn" class="glossary-toggle">Economic Terms</button>
      <div class="glossary" id="glossary">
        <div><span class="glossary-term">GDP Growth:</span> How fast total output is changing.</div>
        <div><span class="glossary-term">Unemployment:</span> Share of workers without jobs.</div>
        <div><span class="glossary-term">Inflation:</span> Rate at which prices rise.</div>
        <div><span class="glossary-term">Interest Rate:</span> Cost of borrowing.</div>
        <div><span class="glossary-term">Phillips Curve:</span> Trade-off between unemployment and inflation.</div>
        <div><span class="glossary-term">Okun's Law:</span> Relationship between GDP growth and unemployment.</div>
        <div><span class="glossary-term">Taylor Rule:</span> How central banks set interest rates.</div>
      </div>

      <div class="debug-panel">
        <button id="debugBtn" class="debug-toggle">Technical Details</button>
        <div class="debug-content" id="debugContent">
          <div id="debugStats">Debug information will appear here...</div>
        </div>
      </div>
    </aside>
  </div>

  <div id="tooltip" class="tooltip"></div>

  <script>
    const MODEL = {
      potential_growth: 2.0, u_star: 5.0, pi_target: 2.0,
      phillips_kappa: 0.40, okun_beta: -0.5, taylor_phi_pi: 1.5,
      taylor_phi_y: 0.5, taylor_rstar: 1.0, closures_sens_u: 0.20,
      closures_sens_prices: 0.15, closures_base_u: 0.05,
      factory_sens_gap: 0.45, factory_sens_exports: 0.30,
      factory_sens_energy: 0.25, factory_base: 0.65,
      housing_sens_real_rate: 0.15, housing_sens_unemployment: 0.12,
      housing_base: 0.80, commodity_oil_passthrough: 0.15
    };

    const DEFAULT_ECONOMY = {
      gdp_growth_pct: 1.8, unemployment_pct: 5.2, inflation_pct: 3.0,
      interest_rate_pct: 4.0, commodity_index: 120, exports_pct_growth: 0.5, shock: null
    };

    const PRESETS = {
      boom: { gdp_growth_pct: 4.5, unemployment_pct: 3.8, inflation_pct: 2.1,
        interest_rate_pct: 2.5, commodity_index: 140, exports_pct_growth: 6.2, shock: null,
        tip: "Economic boom: Strong growth with low unemployment creates inflationary pressure." },
      recession: { gdp_growth_pct: -2.1, unemployment_pct: 9.8, inflation_pct: 1.2,
        interest_rate_pct: 0.5, commodity_index: 95, exports_pct_growth: -3.4, shock: null,
        tip: "Recession: Negative growth and high unemployment suppress economic activity." },
      stagflation: { gdp_growth_pct: 0.2, unemployment_pct: 8.1, inflation_pct: 7.8,
        interest_rate_pct: 6.5, commodity_index: 160, exports_pct_growth: -1.2, shock: 'oil_shock',
        tip: "Stagflation: The worst of both worlds - stagnant growth with high inflation." }
    };

    const clamp = (lo, hi, x) => Math.max(lo, Math.min(hi, x));

    const AUTO_ADJUST = { enabled: true, lastAdjustment: 0, adjustmentThreshold: 1000 };

    function computeEconomicState(economy) {
      const output_gap = economy.gdp_growth_pct - MODEL.potential_growth;
      const unemployment_gap = economy.unemployment_pct - MODEL.u_star;
      const real_rate = economy.interest_rate_pct - economy.inflation_pct;
      const commodity_shock = Math.max(0, (economy.commodity_index - 120) / 40);
      const price_pressure = Math.max(0, (economy.inflation_pct - 4) / 8);
      const unemployment_pressure = Math.max(0, unemployment_gap / 5);
      
      const shops_closed_rate = clamp(0, 0.9,
        MODEL.closures_base_u + MODEL.closures_sens_u * unemployment_pressure + MODEL.closures_sens_prices * price_pressure
      );

      const export_boost = economy.exports_pct_growth / 5.0;
      const energy_drag = commodity_shock * MODEL.factory_sens_energy;
      let factory_capacity = clamp(0.2, 1.0,
        MODEL.factory_base + MODEL.factory_sens_gap * (output_gap / 4) + MODEL.factory_sens_exports * export_boost - energy_drag
      );

      let housing_activity = clamp(0.2, 1.0,
        MODEL.housing_base - MODEL.housing_sens_real_rate * Math.max(0, real_rate / 2) - MODEL.housing_sens_unemployment * unemployment_pressure
      );

      const citizen_activity = clamp(0.3, 1.5, 1.0 + 0.4 * (output_gap / 4) - 0.3 * unemployment_pressure);
      const farm_productivity = clamp(0.2, 1.0, 0.6 + 0.3 * export_boost + 0.1 * (commodity_shock - 0.5));

      let vehicle_activity = 1.0;
      if(economy.shock === 'oil_shock') vehicle_activity *= 0.5;
      else if(economy.shock === 'supply_chain') factory_capacity *= 0.8;
      else if(economy.shock === 'policy_tightening') housing_activity *= 0.7;

      return {
        output_gap, unemployment_gap, real_rate, shops_closed_rate, factory_capacity,
        housing_activity, citizen_activity, farm_productivity, price_pressure: clamp(0,1,price_pressure),
        vehicle_activity, export_boost, energy_drag, unemployment_pressure, commodity_shock
      };
    }

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const VILLAGE_WIDTH = 20, VILLAGE_HEIGHT = 15;
    let TILE_SIZE = 40;

    function resizeCanvas(){
      const sidebarWidth = 400;
      const w = Math.max(520, window.innerWidth - sidebarWidth - 24);
      const h = Math.max(420, window.innerHeight - 24);
      TILE_SIZE = Math.floor(Math.min(w / VILLAGE_WIDTH, h / VILLAGE_HEIGHT));
      canvas.width = TILE_SIZE * VILLAGE_WIDTH;
      canvas.height = TILE_SIZE * VILLAGE_HEIGHT;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    const villageLayout = [
      ['farm','farm','farm','farm','road','housing','housing','housing','road','farm','farm','farm','farm','road','housing','housing','housing','housing','housing','housing'],
      ['farm','farm','farm','farm','road','housing','housing','housing','road','farm','farm','farm','farm','road','housing','housing','housing','housing','housing','housing'],
      ['farm','farm','farm','farm','road','housing','housing','housing','road','farm','farm','farm','farm','road','housing','housing','housing','housing','housing','housing'],
      ['road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road'],
      ['industry','industry','industry','road','retail','retail','retail','retail','road','square','square','square','road','retail','retail','retail','retail','industry','industry','industry'],
      ['industry','industry','industry','road','retail','retail','retail','retail','road','square','square','square','road','retail','retail','retail','retail','industry','industry','industry'],
      ['industry','industry','industry','road','retail','retail','retail','retail','road','square','square','square','road','retail','retail','retail','retail','industry','industry','industry'],
      ['road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road'],
      ['housing','housing','housing','road','retail','retail','retail','retail','road','industry','industry','industry','road','farm','farm','farm','farm','farm','farm','farm'],
      ['housing','housing','housing','road','retail','retail','retail','retail','road','industry','industry','industry','road','farm','farm','farm','farm','farm','farm','farm'],
      ['housing','housing','housing','road','retail','retail','retail','retail','road','industry','industry','industry','road','farm','farm','farm','farm','farm','farm','farm'],
      ['road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road','road'],
      ['farm','farm','farm','farm','housing','housing','housing','housing','road','retail','retail','retail','road','industry','industry','industry','industry','industry','industry','industry'],
      ['farm','farm','farm','farm','housing','housing','housing','housing','road','retail','retail','retail','road','industry','industry','industry','industry','industry','industry','industry'],
      ['farm','farm','farm','farm','housing','housing','housing','housing','road','retail','retail','retail','road','industry','industry','industry','industry','industry','industry','industry']
    ];

    const retailTiles = [];
    for(let y=0;y<VILLAGE_HEIGHT;y++){
      for(let x=0;x<VILLAGE_WIDTH;x++){
        if(villageLayout[y][x]==='retail'){ retailTiles.push({x,y}); }
      }
    }
    const retailState = new Map();

    let citizens = [];
    function initializeCitizens(){
      citizens.length = 0;
      for(let i=0;i<28;i++){
        citizens.push({
          x: Math.random()*canvas.width, y: Math.random()*canvas.height,
          targetX: Math.random()*canvas.width, targetY: Math.random()*canvas.height,
          speed: 0.6 + Math.random()*0.9, frame: Math.floor(Math.random()*3), frameTimer: 0
        });
      }
    }

    function drawCitizen(c,state){
      const sp = c.speed * state.citizen_activity;
      const dx = c.targetX - c.x, dy = c.targetY - c.y;
      const dist = Math.hypot(dx,dy);
      if(dist > sp){
        c.x += (dx/dist)*sp; c.y += (dy/dist)*sp;
      }else{
        c.x = c.targetX; c.y = c.targetY;
        c.targetX = Math.random()*canvas.width;
        c.targetY = Math.random()*canvas.height;
      }
      c.frameTimer += sp;
      if(c.frameTimer > 10){ c.frame=(c.frame+1)%3; c.frameTimer=0; }
      ctx.fillStyle = ['#FF69B4','#87CEEB','#98FB98'][c.frame];
      ctx.beginPath(); ctx.arc(Math.round(c.x), Math.round(c.y), 3, 0, Math.PI*2); ctx.fill();
    }

    const roadAt = (tx,ty) => ty>=0 && ty<VILLAGE_HEIGHT && tx>=0 && tx<VILLAGE_WIDTH && villageLayout[ty][tx]==='road';

    function randomRoadTile(){
      let tx,ty;
      do{ tx = (Math.random()*VILLAGE_WIDTH)|0; ty=(Math.random()*VILLAGE_HEIGHT)|0; } while(!roadAt(tx,ty));
      return {tx,ty};
    }

    let vehicles = [];
    function initializeVehicles(){
      vehicles.length = 0;
      for(let i=0;i<7;i++){
        const {tx,ty} = randomRoadTile();
        vehicles.push({
          tx,ty, x: tx*TILE_SIZE + TILE_SIZE/2, y: ty*TILE_SIZE + TILE_SIZE/2,
          speed: 1 + Math.random()*1.8, type: Math.random()>0.5?'truck':'car', dir:null
        });
      }
    }

    function nextRoadStep(v){
      const choices = [{dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:1},{dx:0,dy:-1}].filter(d=>roadAt(v.tx+d.dx, v.ty+d.dy));
      v.dir = choices.length ? choices[(Math.random()*choices.length)|0] : {dx:0,dy:0};
    }

    function drawVehicle(v,state){
      const sp = v.speed * (state.vehicle_activity || 1);
      if(!v.dir) nextRoadStep(v);
      const targetX = (v.tx+v.dir.dx)*TILE_SIZE + TILE_SIZE/2;
      const targetY = (v.ty+v.dir.dy)*TILE_SIZE + TILE_SIZE/2;
      const dx = targetX - v.x, dy = targetY - v.y;
      const dist = Math.hypot(dx,dy);
      if(dist <= sp){
        v.tx += v.dir.dx; v.ty += v.dir.dy;
        v.x = targetX; v.y = targetY; nextRoadStep(v);
      }else{
        v.x += (dx/dist)*sp; v.y += (dy/dist)*sp;
      }
      ctx.fillStyle = v.type==='truck' ? '#8B4513' : '#4169E1';
      ctx.fillRect(Math.round(v.x-6), Math.round(v.y-3), 12, 6);
      ctx.fillStyle='#000';
      ctx.beginPath();
      ctx.arc(v.x-4, v.y+3, 1.5, 0, Math.PI*2);
      ctx.arc(v.x+4, v.y+3, 1.5, 0, Math.PI*2);
      ctx.fill();
    }

    const TIME = { months: 0, paused: true, frame: 0, tickFrames: 30 };
    const HISTORY = { max: 60, t: [], gdp: [], pi: [], u: [] };

    function pushHistory(){
      HISTORY.t.push(TIME.months);
      HISTORY.gdp.push(currentEconomy.gdp_growth_pct);
      HISTORY.pi.push(currentEconomy.inflation_pct);
      HISTORY.u.push(currentEconomy.unemployment_pct);
      ['t','gdp','pi','u'].forEach(k=>{
        if(HISTORY[k].length>HISTORY.max) HISTORY[k].splice(0, HISTORY[k].length-HISTORY.max);
      });
    }

    function drawSparkline(canvasId, data, ymin=null, ymax=null){
      const cv = document.getElementById(canvasId);
      if(!cv) return;
      const c2 = cv.getContext('2d');
      c2.clearRect(0,0,cv.width,cv.height);
      if(!data || data.length<2) return;
      let min = ymin ?? Math.min(...data);
      let max = ymax ?? Math.max(...data);
      if(min===max){ min -= 1; max += 1; }
      const n = data.length, w=cv.width, h=cv.height, pad=2;
      c2.strokeStyle = '#2E8B57'; c2.lineWidth = 1.5; c2.beginPath();
      for(let i=0;i<n;i++){
        const x = pad + i*(w-2*pad)/(n-1);
        const y = h - pad - (data[i]-min)*(h-2*pad)/(max-min);
        if(i===0) c2.moveTo(x,y); else c2.lineTo(x,y);
      }
      c2.stroke();
    }

    function renderHistory(){
      drawSparkline('chartGDP',  HISTORY.gdp,  -5, 8);
      drawSparkline('chartInfl', HISTORY.pi,    0, 12);
      drawSparkline('chartUnemp',HISTORY.u,     2, 15);
    }

    function stepTime(){
      TIME.months++;
      els.simClock.textContent = `Month ${TIME.months}`;
      pushHistory();
      renderHistory();
    }

    function drawGDPGauge(economy, state){
      const x=12, y=12, w=180, h=90;
      ctx.save();
      ctx.fillStyle='rgba(255,255,255,0.92)';
      ctx.strokeStyle='#2E8B57'; ctx.lineWidth=2;
      roundRect(ctx,x,y,w,h,8,true,true);
      ctx.fillStyle='#2E8B57'; ctx.font='bold 12px Arial';
      ctx.fillText('GDP Growth Meter', x+10, y+18);
      const min=-5, max=8;
      const barX=x+10, barY=y+30, barW=w-20, barH=18;
      const grad = ctx.createLinearGradient(barX,0,barX+barW,0);
      grad.addColorStop(0,'#d9534f');
      grad.addColorStop((0 - min)/(max - min),'#f0ad4e');
      grad.addColorStop((MODEL.potential_growth - min)/(max - min),'#5bc0de');
      grad.addColorStop(1,'#5cb85c');
      ctx.fillStyle='#f1f1f1'; ctx.fillRect(barX,barY,barW,barH);
      ctx.fillStyle=grad;
      const g = clamp(min,max,economy.gdp_growth_pct);
      const ratio = (g - min)/(max - min);
      ctx.fillRect(barX,barY,barW*ratio,barH);
      const zeroR = (0 - min)/(max - min);
      ctx.strokeStyle='rgba(0,0,0,0.35)';
      ctx.beginPath(); ctx.moveTo(barX+barW*zeroR, barY-2); ctx.lineTo(barX+barW*zeroR, barY+barH+2); ctx.stroke();
      const potR = (MODEL.potential_growth - min)/(max - min);
      ctx.strokeStyle='#2E8B57'; ctx.setLineDash([3,2]);
      ctx.beginPath(); ctx.moveTo(barX+barW*potR, barY-2); ctx.lineTo(barX+barW*potR, barY+barH+2); ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle='#333'; ctx.font='11px Arial';
      ctx.fillText(`${min}%`, barX, barY+barH+14);
      ctx.fillText('0%', barX+barW*zeroR-8, barY+barH+14);
      ctx.fillText(`${max}%`, barX+barW-22, barY+barH+14);
      const gap = economy.gdp_growth_pct - MODEL.potential_growth;
      ctx.font='bold 12px Arial';
      ctx.fillStyle = gap >= 0 ? '#0b7a2a' : '#8b1a1a';
      ctx.fillText(`Growth: ${economy.gdp_growth_pct.toFixed(1)}%`, x+10, y+66);
      ctx.fillStyle='#2E4B8C';
      ctx.fillText(`Potential: ${MODEL.potential_growth.toFixed(1)}%`, x+10, y+82);
      ctx.restore();
    }

    function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
      if (typeof stroke === 'undefined') stroke = true;
      if (typeof radius === 'undefined') radius = 5;
      if (typeof radius === 'number') {
        radius = {tl: radius, tr: radius, br: radius, bl: radius};
      } else {
        const defaultRadius = {tl: 0, tr: 0, br: 0, bl: 0};
        for (let side in defaultRadius) radius[side] = radius[side] || defaultRadius[side];
      }
      ctx.beginPath();
      ctx.moveTo(x + radius.tl, y);
      ctx.lineTo(x + width - radius.tr, y);
      ctx.quadraticCurveTo(x + width, y, x + width, y + radius.tr);
      ctx.lineTo(x + width, y + height - radius.br);
      ctx.quadraticCurveTo(x + width, y + height, x + width - radius.br, y + height);
      ctx.lineTo(x + radius.bl, y + height);
      ctx.quadraticCurveTo(x, y + height, x, y + height - radius.bl);
      ctx.lineTo(x, y + radius.tl);
      ctx.quadraticCurveTo(x, y, x + radius.tl, y);
      ctx.closePath();
      if (fill) ctx.fill();
      if (stroke) ctx.stroke();
    }

    function drawTile(x,y,type,state){
      const px = x*TILE_SIZE, py = y*TILE_SIZE;
      switch(type){
        case 'road': {
          ctx.fillStyle='#696969'; ctx.fillRect(px,py,TILE_SIZE,TILE_SIZE);
          ctx.strokeStyle='#FFFF00'; ctx.lineWidth=2; ctx.setLineDash([5,5]);
          if(x%2===0){ ctx.beginPath(); ctx.moveTo(px, py+TILE_SIZE/2); ctx.lineTo(px+TILE_SIZE, py+TILE_SIZE/2); ctx.stroke(); }
          ctx.setLineDash([]); break;
        }
        case 'farm': {
          const prod = state.farm_productivity;
          const g = Math.floor(50 + prod*150);
          ctx.fillStyle = `rgb(34,${g},34)`;
          ctx.fillRect(px,py,TILE_SIZE,TILE_SIZE);
          ctx.strokeStyle = `rgb(0,${Math.floor(g*0.8)},0)`; ctx.lineWidth=1;
          for(let i=0;i<4;i++){ ctx.beginPath(); ctx.moveTo(px, py+i*10+5); ctx.lineTo(px+TILE_SIZE, py+i*10+5); ctx.stroke(); }
          if(prod>0.7 && ((x+y)%4===0)){ ctx.fillStyle='#DAA520'; ctx.fillRect(px+10, py+10, 8, 8); }
          break;
        }
        case 'industry': {
          ctx.fillStyle='#8B4513'; ctx.fillRect(px,py,TILE_SIZE,TILE_SIZE);
          ctx.fillStyle='#A0A0A0'; ctx.fillRect(px+5, py+5, TILE_SIZE-10, TILE_SIZE-10);
          if((x+y)%3===0){
            ctx.fillStyle='#654321'; ctx.fillRect(px+15, py+2, 6, 15);
            const cap = state.factory_capacity;
            if(cap>0.3){
              ctx.fillStyle = `rgba(128,128,128,${cap*0.7})`;
              for(let i=0;i<Math.floor(cap*5);i++){
                ctx.beginPath(); ctx.arc(px+18 + Math.random()*4, py - i*3, 2, 0, Math.PI*2); ctx.fill();
              }
            }
          }
          break;
        }
        case 'retail': {
          const key = `${x},${y}`;
          const rs = retailState.get(key) || {closed:false, priceTag:false};
          ctx.fillStyle = rs.closed ? '#654321' : '#228B22';
          ctx.fillRect(px,py,TILE_SIZE,TILE_SIZE);
          ctx.fillStyle = rs.closed ? '#8B4513' : '#32CD32';
          ctx.fillRect(px+3, py+3, TILE_SIZE-6, TILE_SIZE-6);
          ctx.fillStyle = rs.closed ? '#4B0000' : '#006400';
          ctx.fillRect(px + TILE_SIZE - 8, py + TILE_SIZE - 15, 5, 12);
          if(rs.closed){
            ctx.fillStyle='#FFFF00'; ctx.fillRect(px+5, py+8, 12, 6);
            ctx.fillStyle='#000'; ctx.font='8px Arial'; ctx.fillText('LEASE', px+6, py+12);
          }else if(rs.priceTag){
            ctx.fillStyle='#FF0000'; ctx.font='10px Arial';
            ctx.fillText('↑', px+22, py+15);
          }
          break;
        }
        case 'housing': {
          ctx.fillStyle='#DEB887'; ctx.fillRect(px,py,TILE_SIZE,TILE_SIZE);
          ctx.fillStyle='#8B4513'; ctx.fillRect(px+8, py+8, TILE_SIZE-16, TILE_SIZE-16);
          ctx.fillStyle='#CD853F';
          ctx.beginPath();
          ctx.moveTo(px+5, py+10); ctx.lineTo(px+TILE_SIZE/2, py+2); ctx.lineTo(px+TILE_SIZE-5, py+10);
          ctx.closePath(); ctx.fill();
          if(state.housing_activity < 0.6 && Math.random() < (1.0 - state.housing_activity)){
            ctx.fillStyle='#FFFF00'; ctx.fillRect(px+2, py+20, 10, 8);
            ctx.fillStyle='#000'; ctx.font='6px Arial'; ctx.fillText('SALE', px+3, py+26);
          }
          break;
        }
        case 'square': {
          ctx.fillStyle='#98FB98'; ctx.fillRect(px,py,TILE_SIZE,TILE_SIZE);
          if(x===10 && y===5){
            ctx.fillStyle='#4169E1'; ctx.beginPath();
            ctx.arc(px + TILE_SIZE/2, py + TILE_SIZE/2, 8, 0, Math.PI*2); ctx.fill();
            if(state.citizen_activity>0.8){
              ctx.fillStyle='#87CEEB';
              for(let i=0;i<3;i++){
                ctx.beginPath();
                ctx.arc(px + TILE_SIZE/2 + (Math.random()*10-5), py + TILE_SIZE/2 + (Math.random()*10-5), 1, 0, Math.PI*2);
                ctx.fill();
              }
            }
          }
          if(state.citizen_activity>0.6 && ((x+y)%3===1)){
            ctx.fillStyle='#DDA0DD'; ctx.fillRect(px+5, py+5, 12, 8);
            ctx.fillStyle='#8B008B'; ctx.fillRect(px+6, py+6, 10, 6);
          }
          break;
        }
        default:
          ctx.fillStyle='#90EE90'; ctx.fillRect(px,py,TILE_SIZE,TILE_SIZE);
      }
    }

    function recomputeRetailState(state){
      retailState.clear();
      for(const {x,y} of retailTiles){
        const closed = Math.random() < state.shops_closed_rate;
        const priceTag = !closed && state.price_pressure>0.3 && Math.random() < state.price_pressure;
        retailState.set(`${x},${y}`, {closed, priceTag});
      }
    }

    let currentEconomy = {...DEFAULT_ECONOMY};
    let computedState = {};
    let animationFrame = 0;

    function render(){
      ctx.clearRect(0,0,canvas.width, canvas.height);
      const s = computedState;
      for(let y=0;y<VILLAGE_HEIGHT;y++)
        for(let x=0;x<VILLAGE_WIDTH;x++)
          drawTile(x,y,villageLayout[y][x], s);
      const nC = Math.min(citizens.length, Math.floor(citizens.length * s.citizen_activity));
      for(let i=0;i<nC;i++) drawCitizen(citizens[i], s);
      const nV = Math.min(vehicles.length, Math.floor(vehicles.length * (s.vehicle_activity||1)));
      for(let i=0;i<nV;i++) drawVehicle(vehicles[i], s);
      drawGDPGauge(currentEconomy, s);
    }

    function calculateGDPComponents(economy, state) {
      const baseGDP = 100;
      const growthMultiplier = 1 + (economy.gdp_growth_pct / 100);
      const totalGDP = baseGDP * growthMultiplier;
      const consumptionShare = 0.65 + (state.citizen_activity - 1) * 0.1;
      const consumption = totalGDP * clamp(0.5, 0.8, consumptionShare);
      const realRate = economy.interest_rate_pct - economy.inflation_pct;
      const investmentShare = 0.20 - (realRate / 100) * 0.05 + (state.factory_capacity - 0.7) * 0.05;
      const investment = totalGDP * clamp(0.1, 0.3, investmentShare);
      const unemploymentPressure = Math.max(0, economy.unemployment_pct - MODEL.u_star) / 10;
      const govShare = 0.20 + unemploymentPressure * 0.05;
      const government = totalGDP * clamp(0.15, 0.3, govShare);
      const exportsLevel = (economy.exports_pct_growth / 100) * 10;
      const importsEffect = -consumption * 0.15;
      const netExports = exportsLevel + importsEffect;
      return {
        consumption: consumption.toFixed(1), investment: investment.toFixed(1),
        government: government.toFixed(1), netExports: netExports.toFixed(1), total: totalGDP.toFixed(1)
      };
    }

    const els = {
      gdp: document.getElementById('gdpGrowth'), u: document.getElementById('unemployment'),
      pi: document.getElementById('inflation'), i: document.getElementById('interestRate'),
      com: document.getElementById('commodityIndex'), ex: document.getElementById('exports'),
      shock: document.getElementById('shock'), gdpV: document.getElementById('gdpValue'),
      uV: document.getElementById('unemploymentValue'), piV: document.getElementById('inflationValue'),
      iV: document.getElementById('interestRateValue'), comV: document.getElementById('commodityValue'),
      exV: document.getElementById('exportsValue'), scenarioTip: document.getElementById('scenarioTip'),
      narrative: document.getElementById('narrativeBanner'), statusSummary: document.getElementById('statusSummary'),
      quickStats: document.getElementById('quickStats'), debugBtn: document.getElementById('debugBtn'),
      debugContent: document.getElementById('debugContent'), debugStats: document.getElementById('debugStats'),
      glossaryBtn: document.getElementById('glossaryBtn'), glossary: document.getElementById('glossary'),
      presetBoom: document.getElementById('presetBoom'), presetRecession: document.getElementById('presetRecession'),
      presetStagflation: document.getElementById('presetStagflation'), btnReset: document.getElementById('btnReset'),
      reasoningContent: document.getElementById('reasoningContent'), analysisToggle: document.getElementById('analysisToggle'),
      analysisContent: document.getElementById('analysisContent'), autoAdjustEnabled: document.getElementById('autoAdjustEnabled'),
      consumptionValue: document.getElementById('consumptionValue'), investmentValue: document.getElementById('investmentValue'),
      governmentValue: document.getElementById('governmentValue'), netExportsValue: document.getElementById('netExportsValue'),
      totalGDPValue: document.getElementById('totalGDPValue'), simPlay: document.getElementById('simPlay'),
      simPause: document.getElementById('simPause'), simSpeed: document.getElementById('simSpeed'),
      simSpeedValue: document.getElementById('simSpeedValue'), simClock: document.getElementById('simClock'),
      historyBtn: document.getElementById('historyBtn'), historyContent: document.getElementById('historyContent')
    };

    function autoAdjustControls(changedControl, oldValue, newValue) {
      if (!AUTO_ADJUST.enabled || Date.now() - AUTO_ADJUST.lastAdjustment < AUTO_ADJUST.adjustmentThreshold) return;
      AUTO_ADJUST.lastAdjustment = Date.now();

      switch(changedControl) {
        case 'inflation':
          if (newValue > oldValue && newValue > 4) {
            const rateIncrease = Math.min(0.5, (newValue - 4) * 0.2);
            const newRate = Math.min(10, currentEconomy.interest_rate_pct + rateIncrease);
            if (Math.abs(newRate - currentEconomy.interest_rate_pct) > 0.1) {
              els.i.value = newRate.toFixed(1);
              currentEconomy.interest_rate_pct = newRate;
              showAutoIndicator('interestRate', 'Central bank fighting inflation (Taylor Rule)');
            }
          }
          break;
        case 'unemployment':
          if (newValue > oldValue && newValue > 7) {
            const gdpDecrease = Math.min(1, (newValue - 7) * 0.3);
            const newGDP = Math.max(-5, currentEconomy.gdp_growth_pct - gdpDecrease);
            if (Math.abs(newGDP - currentEconomy.gdp_growth_pct) > 0.1) {
              els.gdp.value = newGDP.toFixed(1);
              currentEconomy.gdp_growth_pct = newGDP;
              showAutoIndicator('gdpGrowth', 'Economic slowdown from job losses (Okun\'s Law)');
            }
          } else if (newValue < oldValue && newValue < 4) {
            const inflIncrease = Math.min(0.4, (4 - newValue) * 0.15);
            const newInfl = Math.min(12, currentEconomy.inflation_pct + inflIncrease);
            if (Math.abs(newInfl - currentEconomy.inflation_pct) > 0.1) {
              els.pi.value = newInfl.toFixed(1);
              currentEconomy.inflation_pct = newInfl;
              showAutoIndicator('inflation', 'Wage pressure from tight job market (Phillips Curve)');
            }
          }
          break;
        case 'gdpGrowth':
          if (newValue > oldValue && newValue > 3) {
            const unempDecrease = Math.min(0.5, (newValue - 3) * 0.2);
            const newUnemp = Math.max(2, currentEconomy.unemployment_pct - unempDecrease);
            if (Math.abs(newUnemp - currentEconomy.unemployment_pct) > 0.1) {
              els.u.value = newUnemp.toFixed(1);
              currentEconomy.unemployment_pct = newUnemp;
              showAutoIndicator('unemployment', 'Job creation from economic growth (Okun\'s Law)');
            }
          }
          break;
        case 'commodityIndex':
          if (newValue > 140 && newValue > oldValue) {
            const inflIncrease = Math.min(0.8, (newValue - 140) * 0.01);
            const newInfl = Math.min(12, currentEconomy.inflation_pct + inflIncrease);
            if (Math.abs(newInfl - currentEconomy.inflation_pct) > 0.1) {
              els.pi.value = newInfl.toFixed(1);
              currentEconomy.inflation_pct = newInfl;
              showAutoIndicator('inflation', 'Supply shock from rising commodity prices');
            }
          }
          break;
        case 'interestRate':
          if (newValue < oldValue && newValue < 2) {
            const gdpBoost = Math.min(0.5, (2 - newValue) * 0.2);
            const newGDP = Math.min(8, currentEconomy.gdp_growth_pct + gdpBoost);
            if (Math.abs(newGDP - currentEconomy.gdp_growth_pct) > 0.1) {
              els.gdp.value = newGDP.toFixed(1);
              currentEconomy.gdp_growth_pct = newGDP;
              showAutoIndicator('gdpGrowth', 'Stimulus from lower borrowing costs');
            }
          }
          break;
      }
    }

    function showAutoIndicator(controlId, reason) {
      const container = document.querySelector(`#${controlId}`).parentElement.parentElement;
      let indicator = container.querySelector('.auto-indicator');
      if (!indicator) {
        indicator = document.createElement('span');
        indicator.className = 'auto-indicator';
        container.querySelector('label').appendChild(indicator);
      }
      indicator.textContent = 'AUTO';
      indicator.title = reason;
      setTimeout(() => { if (indicator.parentElement) indicator.remove(); }, 3000);
    }

    function updateSliderDisplays(){
      els.gdpV.textContent = currentEconomy.gdp_growth_pct.toFixed(1)+'%';
      els.uV.textContent   = currentEconomy.unemployment_pct.toFixed(1)+'%';
      els.piV.textContent  = currentEconomy.inflation_pct.toFixed(1)+'%';
      els.iV.textContent   = currentEconomy.interest_rate_pct.toFixed(1)+'%';
      els.comV.textContent = String(currentEconomy.commodity_index);
      els.exV.textContent  = currentEconomy.exports_pct_growth.toFixed(1)+'%';
      const gdpComponents = calculateGDPComponents(currentEconomy, computedState);
      els.consumptionValue.textContent = gdpComponents.consumption;
      els.investmentValue.textContent = gdpComponents.investment;
      els.governmentValue.textContent = gdpComponents.government;
      els.netExportsValue.textContent = gdpComponents.netExports;
      els.totalGDPValue.textContent = gdpComponents.total;
    }

    function updateEconomy(){
      computedState = computeEconomicState(currentEconomy);
      recomputeRetailState(computedState);
      updateNarrative();
      updateDebugPanel();
      updateReasoningDisplay();
    }

    function updateNarrative(){
      const s = computedState;
      let msg = 'Economic conditions are stable.';
      if(s.citizen_activity>1.1) msg = `Economic boom! Output gap of ${s.output_gap.toFixed(1)}pp drives factory capacity to ${(s.factory_capacity*100|0)}%.`;
      else if(s.citizen_activity<0.6) msg = `Economic downturn: ${(s.shops_closed_rate*100|0)}% shop closures reflect ${currentEconomy.unemployment_pct.toFixed(1)}% unemployment.`;
      else if(s.price_pressure>0.4) msg = `Inflationary pressure: ${currentEconomy.inflation_pct.toFixed(1)}% inflation squeezes retail margins.`;
      else if(s.factory_capacity<0.4) msg = `Industrial slowdown: Weak demand and negative output gap of ${s.output_gap.toFixed(1)}pp idles production.`;
      els.narrative.textContent = msg;
      els.statusSummary.textContent = s.citizen_activity>1.0 ? 'Expanding' : (s.citizen_activity<0.6 ? 'Contracting' : 'Stable');
      els.quickStats.textContent = `Capacity: ${(s.factory_capacity*100|0)}% | Closures: ${(s.shops_closed_rate*100|0)}% | Activity: ${(s.citizen_activity*100|0)}%`;
    }

    function updateDebugPanel(){
      const s = computedState;
      const lines = [
        `output_gap: ${s.output_gap.toFixed(2)}pp`, `unemployment_gap: ${s.unemployment_gap.toFixed(2)}pp`,
        `real_rate: ${s.real_rate.toFixed(2)}%`, `shops_closed_rate: ${s.shops_closed_rate.toFixed(2)}`,
        `factory_capacity: ${s.factory_capacity.toFixed(2)}`, `citizen_activity: ${s.citizen_activity.toFixed(2)}`,
        `farm_productivity: ${s.farm_productivity.toFixed(2)}`, `housing_activity: ${s.housing_activity.toFixed(2)}`
      ];
      els.debugStats.innerHTML = lines.join('<br>');
    }

    function updateReasoningDisplay() {
      const s = computedState;
      const outputGap = s.output_gap;
      const gapAnalysis = outputGap > 1 ? "positive (overheating)" : outputGap < -1 ? "negative (recession)" : "near potential";
      const content = `
        <div class="reasoning-section">
          <div class="reasoning-title">Output Gap Analysis</div>
          <div class="reasoning-content">
            <div class="reasoning-step">GDP Growth: <span class="economic-value">${currentEconomy.gdp_growth_pct.toFixed(1)}%</span> vs Potential: <span class="economic-value">${MODEL.potential_growth.toFixed(1)}%</span></div>
            <div class="reasoning-step">Output gap is <span class="economic-value">${outputGap.toFixed(1)}pp</span> (${gapAnalysis})</div>
            <div class="reasoning-step">This ${outputGap > 0 ? 'increases inflationary pressure' : 'reduces economic activity'}</div>
          </div>
        </div>
        <div class="reasoning-section">
          <div class="reasoning-title">Labor Market Dynamics</div>
          <div class="reasoning-content">
            <div class="reasoning-step">Unemployment: <span class="economic-value">${currentEconomy.unemployment_pct.toFixed(1)}%</span> vs Natural Rate: <span class="economic-value">${MODEL.u_star.toFixed(1)}%</span></div>
            <div class="reasoning-step">Gap: <span class="economic-value">${s.unemployment_gap.toFixed(1)}pp</span> ${s.unemployment_gap > 0 ? '(labor slack)' : '(tight market)'}</div>
            <div class="reasoning-step">${s.unemployment_gap < 0 ? 'Tight labor market puts upward pressure on wages' : 'High unemployment reduces wage pressure'}</div>
          </div>
        </div>
        <div class="reasoning-section">
          <div class="reasoning-title">Monetary Policy Impact</div>
          <div class="reasoning-content">
            <div class="reasoning-step">Nominal Rate: <span class="economic-value">${currentEconomy.interest_rate_pct.toFixed(1)}%</span>, Inflation: <span class="economic-value">${currentEconomy.inflation_pct.toFixed(1)}%</span></div>
            <div class="reasoning-step">Real Interest Rate: <span class="economic-value">${s.real_rate.toFixed(1)}%</span></div>
            <div class="reasoning-step">${s.real_rate > 2 ? 'Restrictive policy dampens investment and housing' : s.real_rate < 0 ? 'Expansionary policy stimulates borrowing' : 'Neutral policy stance'}</div>
          </div>
        </div>
      `;
      els.reasoningContent.innerHTML = content;
    }

    // Event Listeners
    function setupEventListeners() {
      // Slider event listeners
      els.gdp.addEventListener('input', () => {
        const oldValue = currentEconomy.gdp_growth_pct;
        currentEconomy.gdp_growth_pct = parseFloat(els.gdp.value);
        if (AUTO_ADJUST.enabled) autoAdjustControls('gdpGrowth', oldValue, currentEconomy.gdp_growth_pct);
        updateSliderDisplays();
        updateEconomy();
      });

      els.u.addEventListener('input', () => {
        const oldValue = currentEconomy.unemployment_pct;
        currentEconomy.unemployment_pct = parseFloat(els.u.value);
        if (AUTO_ADJUST.enabled) autoAdjustControls('unemployment', oldValue, currentEconomy.unemployment_pct);
        updateSliderDisplays();
        updateEconomy();
      });

      els.pi.addEventListener('input', () => {
        const oldValue = currentEconomy.inflation_pct;
        currentEconomy.inflation_pct = parseFloat(els.pi.value);
        if (AUTO_ADJUST.enabled) autoAdjustControls('inflation', oldValue, currentEconomy.inflation_pct);
        updateSliderDisplays();
        updateEconomy();
      });

      els.i.addEventListener('input', () => {
        const oldValue = currentEconomy.interest_rate_pct;
        currentEconomy.interest_rate_pct = parseFloat(els.i.value);
        if (AUTO_ADJUST.enabled) autoAdjustControls('interestRate', oldValue, currentEconomy.interest_rate_pct);
        updateSliderDisplays();
        updateEconomy();
      });

      els.com.addEventListener('input', () => {
        const oldValue = currentEconomy.commodity_index;
        currentEconomy.commodity_index = parseInt(els.com.value);
        if (AUTO_ADJUST.enabled) autoAdjustControls('commodityIndex', oldValue, currentEconomy.commodity_index);
        updateSliderDisplays();
        updateEconomy();
      });

      els.ex.addEventListener('input', () => {
        currentEconomy.exports_pct_growth = parseFloat(els.ex.value);
        updateSliderDisplays();
        updateEconomy();
      });

      els.shock.addEventListener('change', () => {
        currentEconomy.shock = els.shock.value || null;
        updateEconomy();
      });

      // Auto-adjust toggle
      els.autoAdjustEnabled.addEventListener('change', () => {
        AUTO_ADJUST.enabled = els.autoAdjustEnabled.checked;
      });

      // Preset buttons
      els.presetBoom.addEventListener('click', () => {
        Object.assign(currentEconomy, PRESETS.boom);
        syncSlidersToEconomy();
        els.scenarioTip.textContent = PRESETS.boom.tip;
        updateEconomy();
      });

      els.presetRecession.addEventListener('click', () => {
        Object.assign(currentEconomy, PRESETS.recession);
        syncSlidersToEconomy();
        els.scenarioTip.textContent = PRESETS.recession.tip;
        updateEconomy();
      });

      els.presetStagflation.addEventListener('click', () => {
        Object.assign(currentEconomy, PRESETS.stagflation);
        syncSlidersToEconomy();
        els.scenarioTip.textContent = PRESETS.stagflation.tip;
        updateEconomy();
      });

      els.btnReset.addEventListener('click', () => {
        Object.assign(currentEconomy, DEFAULT_ECONOMY);
        syncSlidersToEconomy();
        els.scenarioTip.textContent = "Select a preset to see different economic scenarios play out!";
        updateEconomy();
      });

      // Toggle buttons
      els.debugBtn.addEventListener('click', () => {
        els.debugContent.classList.toggle('open');
      });

      els.glossaryBtn.addEventListener('click', () => {
        els.glossary.classList.toggle('open');
      });

      els.analysisToggle.addEventListener('click', () => {
        els.analysisContent.classList.toggle('open');
      });

      els.historyBtn.addEventListener('click', () => {
        els.historyContent.classList.toggle('open');
      });

      // Simulation controls
      els.simPlay.addEventListener('click', () => {
        TIME.paused = false;
      });

      els.simPause.addEventListener('click', () => {
        TIME.paused = true;
      });

      els.simSpeed.addEventListener('input', () => {
        const speed = parseInt(els.simSpeed.value);
        els.simSpeedValue.textContent = speed + 'x';
        TIME.tickFrames = Math.max(5, 60 / speed);
      });
    }

    function syncSlidersToEconomy() {
      els.gdp.value = currentEconomy.gdp_growth_pct;
      els.u.value = currentEconomy.unemployment_pct;
      els.pi.value = currentEconomy.inflation_pct;
      els.i.value = currentEconomy.interest_rate_pct;
      els.com.value = currentEconomy.commodity_index;
      els.ex.value = currentEconomy.exports_pct_growth;
      els.shock.value = currentEconomy.shock || '';
      updateSliderDisplays();
    }

    // Main game loop
    function gameLoop() {
      TIME.frame++;
      
      if (!TIME.paused && TIME.frame % TIME.tickFrames === 0) {
        stepTime();
        updateEconomy();
      }
      
      render();
      requestAnimationFrame(gameLoop);
    }

    // Initialize the game
    function initialize() {
      resizeCanvas();
      initializeCitizens();
      initializeVehicles();
      setupEventListeners();
      updateEconomy();
      updateSliderDisplays();
      syncSlidersToEconomy();
      
      // Start the game loop
      gameLoop();
    }

    // Start the game when page loads
    window.addEventListener('load', initialize);
  </script>
</body>
</html>
